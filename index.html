// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  √âTAT GLOBAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STATE = {
  ws: null,
  serveur: null,
  roomId: null,
  joueurId: crypto.randomUUID(),
  nom: 'Joueur',
  estCreateur: false,
  modeJeu: 'classique',
  modeConnecte: false,
  joueurFautif: null,

  etat: null,
  tempsMax: 15,
  tempsRestant: 15,
  chronoInterval: null,
  estMonTour: false,
  nbTours: 0,

  langue: 'fr',
  modeMixte: false,
  paysJouesList: [],
};

const SERVEUR_HTTP = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://pays-game.onrender.com';
const SERVEUR_WS = SERVEUR_HTTP.replace('http', 'ws');

let PAYS_LOCAL = null;

async function chargerPaysLocal(langue) {
  try {
    const r = await fetch(`pays_${langue}.json`);
    const pays = await r.json();
    pays.forEach(p => {
      p.nom_normalise       = normaliser(p.nom_normalise || p.nom || '');
      p.capitale_normalisee = normaliser(p.capitale_normalisee || p.capitale || '');
    });
    pays._langue = langue;
    PAYS_LOCAL = pays;
  } catch {
    PAYS_LOCAL = [{ nom: 'FRANCE', capitale: 'PARIS', code: 'fr', nom_normalise: 'FRANCE', capitale_normalisee: 'PARIS' }];
    toast('‚ö†Ô∏è Fichier pays non trouv√©', 'warn');
  }
}

function normaliser(s) {
  return s.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^A-Z]/g, '');
}

function chercherPossibilites(seq) {
  if (!PAYS_LOCAL || !seq) return PAYS_LOCAL || [];
  const s = normaliser(seq);
  return PAYS_LOCAL.filter(p => p.nom_normalise.startsWith(s) || (STATE.modeMixte && p.capitale_normalisee.startsWith(s)));
}

function estComplet(seq) {
  const s = normaliser(seq);
  return PAYS_LOCAL?.find(p => p.nom_normalise === s || (STATE.modeMixte && p.capitale_normalisee === s)) || null;
}

function afficherEcran(id) {
  const chatBtn = document.getElementById('chat-toggle-btn');
  const pauseBtn = document.getElementById('btn-pause');
  
  if (chatBtn) {
    if (id === 'screen-lobby' || id === 'screen-jeu') chatBtn.classList.remove('hidden');
    else { chatBtn.classList.add('hidden'); document.getElementById('chat-panel').classList.remove('open'); }
  }
  
  // FIX : Emp√™cher l'apparition du bouton Pause en mode connect√© pour √©viter les d√©synchronisations
  if (pauseBtn) {
    pauseBtn.style.display = STATE.modeConnecte ? 'none' : 'inline-block';
  }

  ['screen-accueil','screen-lobby','screen-jeu','screen-fin'].forEach(s => document.getElementById(s).classList.toggle('hidden', s !== id));
}

const STEPS = ['step-choix','step-solo','step-multi','step-creer','step-rejoindre'];
function allerStep(id) {
  STEPS.forEach(s => document.getElementById(s)?.classList.add('hidden'));
  document.getElementById(id)?.classList.remove('hidden');
  setTimeout(() => document.getElementById(id)?.querySelector('input[type="text"]')?.focus(), 50);
}

function lancerSolo() {
  const nom = document.getElementById('solo-nom').value.trim() || 'Joueur';
  STATE.nom = nom; STATE.langue = document.getElementById('solo-langue').value;
  STATE.modeMixte = document.getElementById('solo-mixte').checked;
  STATE.modeJeu = document.getElementById('solo-mode')?.value || 'classique';
  let vies = parseInt(document.getElementById('solo-vies').value) || 10;
  let temps = parseInt(document.getElementById('solo-temps').value) || 15;
  if (STATE.modeJeu === 'blitz') temps = 5;
  if (STATE.modeJeu === 'survie') vies = 1;
  STATE.tempsMax = temps; SOLO.viesDepart = vies; SOLO.tempsDepart = temps;
  if (!PAYS_LOCAL || PAYS_LOCAL._langue !== STATE.langue) chargerPaysLocal(STATE.langue).then(() => lancerModeSolo(vies));
  else lancerModeSolo(vies);
}

async function creerPartie() {
  const nom = document.getElementById('creer-nom').value.trim() || 'Joueur';
  STATE.nom = nom; STATE.langue = document.getElementById('creer-langue').value;
  STATE.modeMixte = document.getElementById('creer-mixte').checked;
  STATE.tempsMax = parseInt(document.getElementById('creer-temps').value);
  STATE.estCreateur = true;
  const btn = document.getElementById('btn-creer');
  btn.disabled = true; btn.textContent = '‚è≥ Connexion‚Ä¶';
  if (!PAYS_LOCAL || PAYS_LOCAL._langue !== STATE.langue) await chargerPaysLocal(STATE.langue);
  STATE.modeJeu = document.getElementById('creer-mode')?.value || 'classique';
  let viesMode = parseInt(document.getElementById('creer-vies').value);
  let tempsMode = STATE.tempsMax;
  if (STATE.modeJeu === 'blitz') tempsMode = 5;
  if (STATE.modeJeu === 'survie') viesMode = 1;
  STATE.tempsMax = tempsMode;
  const connecte = await tenterConnexionServeur(true, { langue: STATE.langue, mode_mixte: STATE.modeMixte, vies: viesMode, temps: tempsMode, max_joueurs: parseInt(document.getElementById('creer-max').value), mode_jeu: STATE.modeJeu });
  btn.disabled = false; btn.textContent = 'üó∫Ô∏è Cr√©er la partie';
  if (!connecte) toast('üîå Serveur non disponible', 'error');
}

async function rejoindreParCode(codeForce) {
  const code = (codeForce || document.getElementById('rejoindre-code')?.value || '').trim().toUpperCase();
  const nom = (document.getElementById('rejoindre-nom')?.value || '').trim() || 'Joueur';
  if (!code || code.length !== 6) { toast('Code invalide (6 lettres)', 'error'); return; }
  STATE.nom = nom; STATE.estCreateur = false;
  const btn = document.querySelector('#step-rejoindre .btn-primary');
  if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Connexion‚Ä¶'; }
  try {
    const r = await fetch(`${SERVEUR_HTTP}/parties/${code}`, { signal: AbortSignal.timeout(5000) });
    if (!r.ok) { toast('Salle introuvable', 'error'); resetBtnRejoindre(); return; }
    const data = await r.json();
    if (data.etat === 'en_cours') { toast('‚ùå Cette partie a d√©j√† commenc√© !', 'error'); resetBtnRejoindre(); return; }
    if (data.etat === 'terminee') { toast('‚ùå Cette partie est termin√©e.', 'error'); resetBtnRejoindre(); return; }
    if ((data.joueurs ? data.joueurs.length : 0) >= (data.config?.max_joueurs || 8)) { toast('‚ùå La salle est pleine !', 'error'); resetBtnRejoindre(); return; }
    const cfg = data.config || {};
    STATE.langue = cfg.langue || 'fr'; STATE.modeMixte = cfg.mode_mixte || false; STATE.tempsMax = cfg.temps || 15;
  } catch { toast('Serveur non disponible', 'error'); resetBtnRejoindre(); return; }
  if (!PAYS_LOCAL || PAYS_LOCAL._langue !== STATE.langue) await chargerPaysLocal(STATE.langue);
  const connecte = await tenterConnexionServeur(false, null, code);
  if (!connecte) toast('Impossible de rejoindre', 'error');
  resetBtnRejoindre();
}

function resetBtnRejoindre() {
  const btn = document.querySelector('#step-rejoindre .btn-primary');
  if (btn) { btn.disabled = false; btn.textContent = 'Rejoindre ‚Üí'; }
}

async function rafraichirRooms() {
  const list = document.getElementById('rooms-list');
  list.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px;text-align:center">Recherche‚Ä¶</div>';
  try {
    const r = await fetch(`${SERVEUR_HTTP}/parties`, { signal: AbortSignal.timeout(4000) });
    const rooms = await r.json();
    list.innerHTML = '';
    if (!rooms.length) { list.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px;text-align:center">Aucune partie disponible</div>'; return; }
    rooms.forEach(room => {
      const div = document.createElement('div'); div.className = 'room-item';
      div.innerHTML = `<span class="room-id">${room.room_id}</span><span class="room-info">${room.joueurs}/${room.max_joueurs} joueurs ¬∑ ${room.langue === 'fr' ? 'üá´üá∑' : 'üá¨üáß'}</span>`;
      div.onclick = () => { allerStep('step-rejoindre'); document.getElementById('rejoindre-code').value = room.room_id; };
      list.appendChild(div);
    });
  } catch { list.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px;text-align:center">Serveur non disponible</div>'; }
}

async function tenterConnexionServeur(creer, config, roomId = null) {
  try {
    if (creer) {
      const r = await fetch(`${SERVEUR_HTTP}/parties`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(config), signal: AbortSignal.timeout(4000) });
      STATE.roomId = (await r.json()).room_id;
    } else STATE.roomId = roomId;
    const ws = new WebSocket(`${SERVEUR_WS}/ws/${STATE.roomId}/${encodeURIComponent(STATE.joueurId)}/${encodeURIComponent(STATE.nom)}`);
    return await new Promise((resolve) => {
      const timer = setTimeout(() => { ws.close(); resolve(false); }, 5000);
      ws.onopen = () => { clearTimeout(timer); STATE.ws = ws; STATE.modeConnecte = true; ws.onmessage = onMessage; ws.onclose = onClose; ws.onerror = () => {}; afficherLobby(); resolve(true); };
      ws.onerror = () => { clearTimeout(timer); resolve(false); };
    });
  } catch { return false; }
}

function envoyerWS(data) { if (STATE.ws && STATE.ws.readyState === WebSocket.OPEN) STATE.ws.send(JSON.stringify(data)); }

function onMessage(evt) { traiterMessage(JSON.parse(evt.data)); }

let _reconnectAttempts = 0; let _reconnectTimer = null;
function onClose(evt) {
  STATE.ws = null; STATE.modeConnecte = false;
  if (evt && evt.code === 4001) { toast('‚ùå Cette partie a d√©j√† commenc√©.', 'error'); setTimeout(() => afficherEcran('screen-accueil'), 1500); return; }
  if (evt && evt.code === 4002) { toast('‚ùå La salle est pleine.', 'error'); setTimeout(() => afficherEcran('screen-accueil'), 1500); return; }
  const enJeu = !document.getElementById('screen-jeu').classList.contains('hidden');
  const enLobby = !document.getElementById('screen-lobby').classList.contains('hidden');
  if ((enJeu || enLobby) && STATE.roomId && _reconnectAttempts < 5) {
    const delai = Math.min(1500 * Math.pow(1.5, _reconnectAttempts), 8000); _reconnectAttempts++;
    toast(`üîå D√©connect√© ‚Äî reconnexion dans ${Math.round(delai/1000)}s‚Ä¶ (${_reconnectAttempts}/5)`, 'warn');
    _reconnectTimer = setTimeout(async () => { if (await tenterReconnexion()) { _reconnectAttempts = 0; toast('‚úÖ Reconnect√© !', ''); } }, delai);
  } else if (enJeu || enLobby) {
    toast('üîå Connexion perdue ‚Äî impossible de reconnecter', 'error');
    setTimeout(() => { if (confirm("Connexion perdue. Retourner √† l'accueil ?")) retourAccueil(); }, 3000);
  }
}

async function tenterReconnexion() {
  if (!STATE.roomId || !STATE.joueurId) return false;
  try {
    const ws = new WebSocket(`${SERVEUR_WS}/ws/${STATE.roomId}/${encodeURIComponent(STATE.joueurId)}/${encodeURIComponent(STATE.nom)}`);
    return await new Promise((resolve) => {
      const timer = setTimeout(() => { ws.close(); resolve(false); }, 5000);
      ws.onopen = () => { clearTimeout(timer); STATE.ws = ws; STATE.modeConnecte = true; ws.onmessage = onMessage; ws.onclose = onClose; ws.onerror = () => {}; resolve(true); };
      ws.onerror = () => { clearTimeout(timer); resolve(false); };
    });
  } catch { return false; }
}

function traiterMessage(msg) {
  switch(msg.type) {
    case 'etat': case 'joueur_rejoint': case 'joueur_parti': mettreAJourEtat(msg); break;
    case 'erreur': toast(msg.message, 'error'); if (msg.message?.startsWith('‚ùå')) setTimeout(() => { if (STATE.ws) { STATE.ws.close(); STATE.ws = null; } afficherEcran('screen-accueil'); }, 2500); break;
    case 'partie_demarree':
      if (msg.config) { STATE.langue = msg.config.langue || STATE.langue; STATE.modeMixte = msg.config.mode_mixte || false; STATE.tempsMax = msg.config.temps || STATE.tempsMax; STATE.modeJeu = msg.config.mode_jeu || 'classique'; }
      STATE.modeConnecte = true;
      if (msg.joueurs) { const moi = msg.joueurs.find(j => j.id === STATE.joueurId); if (!moi) { const parNom = msg.joueurs.find(j => j.nom === STATE.nom && !j.est_ia); if (parNom) STATE.joueurId = parNom.id; } }
      afficherEcran('screen-jeu'); construireClavier();
      const badge = document.getElementById('mode-badge');
      if (badge && STATE.modeJeu !== 'classique') { badge.textContent = { classique:'üéØ CLASSIQUE', blitz:'‚ö° BLITZ', survie:'üíÄ SURVIE', acceleration:'üî• ACC√âL√âRATION' }[STATE.modeJeu] || ''; badge.style.display = 'block'; } else if (badge) badge.style.display = 'none';
      mettreAJourEtat(msg); toast('üéÆ La partie commence !'); break;
    case 'nouveau_tour':
      stopChrono(); STATE.joueurFautif = msg.joueur_fautif || null;
      if (document.getElementById('screen-jeu').classList.contains('hidden')) afficherEcran('screen-jeu');
      if (!document.getElementById('keyboard').children.length) construireClavier();
      mettreAJourEtat(msg); STATE.nbTours++;
      if (STATE.modeJeu === 'acceleration') STATE.tempsMax = Math.max(3, (msg.config?.temps || STATE.tempsMax) - STATE.nbTours);
      lancerChrono(STATE.tempsMax);
      if (msg.sequence_est_pays) {
        if (msg.joueur_actuel === STATE.joueurId) ouvrirModalNiger(msg.sequence_pays_nom);
        else toast(`üëÄ ¬´ ${msg.sequence_pays_nom} ¬ª est un pays ‚Äî ${(msg.joueurs?.find(j => j.id === msg.joueur_actuel)?.nom || 'Le joueur')} doit d√©cider !`, '');
      }
      break;
    case 'sequence_invalide':
      jouerSon('erreur'); stopChrono(); STATE.joueurFautif = msg.joueur_fautif || null; mettreAJourEtat(msg);
      document.getElementById('letters-seq').classList.add('invalid'); setTimeout(() => document.getElementById('letters-seq').classList.remove('invalid'), 600);
      if (!STATE.modeConnecte) toast(`‚ö†Ô∏è ${msg.message}`, 'warn'); break;
    case 'mot_complet':
      jouerSon('complet'); stopChrono(); document.querySelectorAll('.key').forEach(k => k.disabled = true); document.getElementById('btn-langue').disabled = true;
      mettreAJourEtat(msg); document.getElementById('letters-seq').classList.add('complete'); ajouterDrapeau(msg.pays); toast(`üíÄ ${msg.message}`, 'warn'); break;
    case 'langue_au_chat':
      jouerSon('langue'); mettreAJourEtat(msg);
      if (msg.interpelle === STATE.joueurId) ouvrirModalLangueAuChat(msg.message, msg.delai || 20); else toast(`üó£Ô∏è ${msg.message}`, 'warn'); break;
    case 'verdict_langue_au_chat':
      document.getElementById('modal-langue').classList.add('hidden'); if (_lacCountdownInterval) { clearInterval(_lacCountdownInterval); _lacCountdownInterval = null; }
      afficherVerdict(msg); mettreAJourEtat(msg); break;
    case 'perte_vie':
      jouerSon('vie'); stopChrono(); ['modal-langue','modal-verdict','modal-niger'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
      if (_lacCountdownInterval) { clearInterval(_lacCountdownInterval); _lacCountdownInterval = null; }
      mettreAJourEtat(msg); toast(msg.raison === 'AFK' ? `üí§ ${msg.message}` : msg.message, msg.elimine ? 'error' : 'warn'); break;
    case 'fin_partie': jouerSon('victoire'); mettreAJourEtat(msg); afficherFinDePartie(msg); break;
    case 'chat': ajouterMessageChat(msg); break;
    case 'ia_langue_au_chat': toast(msg.message, 'warn'); break;
  }
}

function afficherLobby() {
  afficherEcran('screen-lobby'); document.getElementById('lobby-code').textContent = STATE.roomId; document.getElementById('lien-partage').textContent = `${window.location.href.split('?')[0]}?room=${STATE.roomId}`;
  const lienWrap = document.querySelector('.link-share'); if (lienWrap) lienWrap.style.display = '';
  mettreAJourBoutonsLobby(); document.getElementById('chat-toggle-btn').classList.remove('hidden');
}

function mettreAJourBoutonsLobby() {
  const actions = document.getElementById('lobby-actions'); const btnDemarrer = document.getElementById('btn-demarrer');
  const old = document.getElementById('btn-lobby-action'); if (old) old.remove();
  const btn = document.createElement('button'); btn.id = 'btn-lobby-action'; btn.className = 'btn btn-secondary';
  if (STATE.estCreateur) { btn.innerHTML = 'ü§ñ Ajouter un bot'; btn.onclick = ajouterIA; btnDemarrer.style.display = ''; }
  else { btn.innerHTML = '‚Üê Quitter la salle'; btn.onclick = () => { if (STATE.ws) { STATE.ws.close(); STATE.ws = null; } afficherEcran('screen-accueil'); document.getElementById('chat-toggle-btn').classList.add('hidden'); }; btnDemarrer.style.display = 'none'; }
  actions.insertBefore(btn, btnDemarrer);
}

function mettreAJourEtat(msg) {
  STATE.etat = msg;
  if (!document.getElementById('screen-lobby').classList.contains('hidden')) mettreAJourLobby(msg);
  if (!document.getElementById('screen-jeu').classList.contains('hidden')) mettreAJourJeu(msg);
}

function mettreAJourLobby(msg) {
  const joueurs = msg.joueurs || []; const grid = document.getElementById('players-grid'); grid.innerHTML = ''; const avatars = ['üßë','üë©','üßî','üë±','üßï','üë®‚Äçüíª','üßô','ü¶ä'];
  joueurs.forEach((j, i) => { const div = document.createElement('div'); div.className = 'player-slot filled'; div.innerHTML = `<div class="slot-avatar">${j.est_ia ? 'ü§ñ' : avatars[i % avatars.length]}</div><div class="slot-name">${escapeHtml(j.nom)}</div><div class="slot-tag">${j.est_ia ? 'BOT' : (j.id === STATE.joueurId || (!j.est_ia && j.nom === STATE.nom)) ? 'MOI' : 'EN LIGNE'}</div>`; grid.appendChild(div); });
  for (let i = joueurs.length; i < (msg.config?.max_joueurs || 4); i++) { const div = document.createElement('div'); div.className = 'player-slot'; div.innerHTML = `<div class="slot-avatar" style="opacity:.2">üë§</div><div class="slot-name" style="opacity:.2;font-size:11px">En attente‚Ä¶</div>`; grid.appendChild(div); }
}

async function ajouterIA() { if (STATE.ws) { try { await fetch(`${SERVEUR_HTTP}/parties/${STATE.roomId}/ia`, { method: 'POST' }); } catch { toast('Serveur indisponible', 'error'); } } else ajouterIALocale(); }

async function demarrerPartie() {
  if (STATE.modeConnecte && STATE.ws) { try { const r = await fetch(`${SERVEUR_HTTP}/parties/${STATE.roomId}/demarrer?joueur_id=${STATE.joueurId}`, { method: 'POST', signal: AbortSignal.timeout(5000) }); if (!r.ok) toast(`Erreur : ${(await r.json().catch(() => ({}))).detail || r.status}`, 'error'); } catch { toast('Erreur serveur ‚Äî r√©essaie', 'error'); } }
  else if (!STATE.modeConnecte) demarrerSolo();
}

function copierLien() { navigator.clipboard.writeText(document.getElementById('lien-partage').textContent).then(() => toast('üîó Lien copi√© !')); }

function mettreAJourJeu(msg) {
  const seq = msg.sequence || ''; const monTour = msg.joueur_actuel === STATE.joueurId;
  const el = document.getElementById('letters-seq'); el.textContent = seq ? seq.split('').join(' - ') : '‚Ä¶'; el.className = 'letters-sequence';
  STATE.estMonTour = monTour; document.getElementById('turn-indicator').textContent = monTour ? '‚¨á Ton tour !' : (msg.joueurs?.find(j => j.id === msg.joueur_actuel) ? `Tour de ${msg.joueurs.find(j => j.id === msg.joueur_actuel).nom}` : '');
  if (STATE.modeConnecte) {
    if ('joueur_fautif' in msg) STATE.joueurFautif = msg.joueur_fautif;
    document.querySelectorAll('.key').forEach(k => k.disabled = !monTour);
    document.getElementById('btn-langue').disabled = !(monTour && (msg.sequence || '').length > 0 && STATE.joueurFautif !== STATE.joueurId);
  }
  if (seq && !STATE.modeConnecte) { const poss = chercherPossibilites(seq); document.getElementById('poss-count').textContent = poss.length ? `${poss.length} pays possible${poss.length > 1 ? 's' : ''}` : ''; } else document.getElementById('poss-count').textContent = '';
  mettreAJourScores(msg);
}

function mettreAJourScores(msg) {
  const joueurs = msg.joueurs || []; const viesMax = msg.config?.vies || 10;
  function playerCard(j, side) {
    const dots = Array.from({ length: viesMax }, (_, k) => `<span class="tp-dot${k >= j.vies ? ' lost' : ''}"></span>`).join('');
    return `<div class="topbar-player${j.id === msg.joueur_actuel ? ' active' : ''}${side === 'right' ? ' right' : ''}"><div class="tp-name">${(j.est_ia ? 'ü§ñ ' : '') + j.nom}</div><div class="tp-dots">${dots}</div></div>`;
  }
  const chronoHtml = `<div class="chrono-pill" id="chrono-pill"><span class="hourglass-icon">‚è≥</span><span class="chrono-val" id="chrono-val">${STATE.tempsRestant || STATE.tempsMax}</span></div>`;
  const row = document.getElementById('topbar-row'); const extra = document.getElementById('topbar-row-extra');
  if (joueurs.length <= 2) { row.innerHTML = (joueurs[0] ? playerCard(joueurs[0], 'left') : '<div class="topbar-player"></div>') + chronoHtml + (joueurs[1] ? playerCard(joueurs[1], 'right') : '<div class="topbar-player"></div>'); extra.style.display = 'none'; }
  else { row.innerHTML = playerCard(joueurs[0], 'left') + chronoHtml + playerCard(joueurs[1], 'right'); extra.style.display = 'flex'; extra.innerHTML = joueurs.slice(2).map(j => playerCard(j, '')).join(''); }
}

function ajouterDrapeau(pays, valeurJouee = null) {
  const label = (valeurJouee && valeurJouee !== pays.nom) ? `${valeurJouee} (${pays.nom})` : pays.nom;
  const inner = document.getElementById('flags-inner'); document.getElementById('flags-label').style.display = '';
  const div = document.createElement('div'); div.className = 'flag-item'; div.innerHTML = `<img src="https://flagcdn.com/w80/${pays.code}.png" alt="${pays.nom}" onerror="this.style.display='none'"><div class="flag-name">${label}</div>`;
  inner.appendChild(div); inner.parentElement.scrollLeft = inner.scrollWidth;
}

function construireClavier() {
  const kb = document.getElementById('keyboard'); kb.innerHTML = '';
  ['AZERTYUIOP', 'QSDFGHJKLM', 'WXCVBN'].forEach(rangee => {
    const row = document.createElement('div'); row.className = 'kb-row';
    rangee.split('').forEach(l => {
      const btn = document.createElement('button'); btn.className = 'key'; btn.textContent = l; btn.dataset.lettre = l; btn.disabled = false; btn.onclick = () => appuyerTouche(l); row.appendChild(btn);
    });
    kb.appendChild(row);
  });
}

function appuyerTouche(lettre) { jouerSon('touche'); if (!STATE.estMonTour) return; if (STATE.modeConnecte) envoyerWS({ action: 'lettre', lettre }); else traiterLettreLocal(lettre); }

function lancerChrono(secondes) {
  clearInterval(STATE.chronoInterval); STATE.tempsRestant = secondes; STATE.tempsMax = secondes; actualiserChrono();
  STATE.chronoInterval = setInterval(() => { STATE.tempsRestant--; actualiserChrono(); if (STATE.tempsRestant <= 0) { clearInterval(STATE.chronoInterval); if (!STATE.modeConnecte && STATE.estMonTour) perdreVieLocal('‚è∞ Temps √©coul√© !'); } }, 1000);
}

function actualiserChrono() {
  const pct = (STATE.tempsRestant / STATE.tempsMax) * 100; const urgent = STATE.tempsRestant <= 5;
  const fill = document.getElementById('chrono-fill'); fill.style.width = pct + '%'; fill.classList.toggle('urgent', urgent);
  const pill = document.getElementById('chrono-pill'); const val = document.getElementById('chrono-val');
  if (pill) { pill.classList.toggle('urgent', urgent); if (val) val.textContent = STATE.tempsRestant; }
  const hg = document.getElementById('hourglass-display'); if (hg) hg.style.animationDuration = urgent ? '0.5s' : '3s';
}

function demanderLangueAuChat() { if (STATE.modeConnecte) envoyerWS({ action: 'langue_au_chat' }); else demanderLangueAuChatLocal(); }

function ouvrirModalNiger(nomPays) { document.getElementById('modal-niger-pays').textContent = nomPays.toUpperCase(); document.getElementById('modal-niger').classList.remove('hidden'); }
function choixNigerContinuer() { document.getElementById('modal-niger').classList.add('hidden'); toast('‚å®Ô∏è Continue la s√©quence !', ''); }
function choixNigerStopper() { document.getElementById('modal-niger').classList.add('hidden'); stopChrono(); if (STATE.modeConnecte) envoyerWS({ action: 'stopper_sequence' }); else stopperSequenceLocal(); }

function stopperSequenceLocal() {
  stopChrono(); const seqNorm = normaliser(SOLO.sequence); const paysExact = PAYS_LOCAL ? PAYS_LOCAL.find(p => p.nom_normalise === seqNorm) : null;
  if (!paysExact) { toast('La s√©quence ne forme pas un pays !', 'error'); return; }
  const fautif = SOLO.joueurs.find(j => j.id === (SOLO.joueurFautif || 'ia')) || SOLO.joueurs.find(j => j.est_ia); if (!fautif) return;
  SOLO.paysJoues.add(paysExact.nom_normalise); SOLO.paysJouesList.push(paysExact); ajouterDrapeau(paysExact);
  afficherVerdict({ valide: false, message: `üõë S√©quence stopp√©e sur ¬´ ${paysExact.nom} ¬ª ! ${fautif.nom} perd une vie.` });
  setTimeout(() => { fermerVerdict(); perdreVieSolo(fautif.id, `S√©quence stopp√©e`); }, 2000);
}

let _lacCountdownInterval = null;
function ouvrirModalLangueAuChat(texte, delai) {
  document.getElementById('modal-langue-text').textContent = texte || 'Quel pays avais-tu en t√™te ?'; document.getElementById('modal-langue-input').value = ''; document.getElementById('modal-langue').classList.remove('hidden'); setTimeout(() => document.getElementById('modal-langue-input').focus(), 100);
  const totalSec = delai || 20; let restant = totalSec; const elNum = document.getElementById('lac-countdown'); const elBar = document.getElementById('lac-progress');
  if (_lacCountdownInterval) clearInterval(_lacCountdownInterval);
  function majCountdown() { if (elNum) { elNum.textContent = restant; elNum.style.color = restant <= 5 ? 'var(--crimson)' : restant <= 10 ? 'var(--amber)' : 'var(--teal)'; } if (elBar) elBar.style.width = (restant / totalSec * 100) + '%'; }
  majCountdown();
  _lacCountdownInterval = setInterval(() => { restant--; majCountdown(); if (restant <= 0) { clearInterval(_lacCountdownInterval); document.getElementById('modal-langue').classList.add('hidden'); } }, 1000);
}

function validerLangueAuChat() { const pays = document.getElementById('modal-langue-input').value.trim(); if (!pays) return; document.getElementById('modal-langue').classList.add('hidden'); if (_lacCountdownInterval) { clearInterval(_lacCountdownInterval); _lacCountdownInterval = null; } if (STATE.modeConnecte) envoyerWS({ action: 'reponse_langue_au_chat', pays }); else evaluerReponseLocal(pays); }
function afficherVerdict(msg) { document.getElementById('verdict-emoji').textContent = msg.valide ? '‚úÖ' : 'üòÇ'; document.getElementById('verdict-title').textContent = msg.valide ? 'Bravo !' : "C'est Nul üòÇ"; document.getElementById('verdict-text').textContent = msg.message; document.getElementById('modal-verdict').classList.remove('hidden'); }
function fermerVerdict() { document.getElementById('modal-verdict').classList.add('hidden'); }

function toggleChat() {
  const panel = document.getElementById('chat-panel'); panel.classList.toggle('open'); document.getElementById('chat-notif').classList.remove('show');
  const emojiBar = document.getElementById('emoji-bar'); const enJeu = !document.getElementById('screen-jeu').classList.contains('hidden');
  if (emojiBar) emojiBar.style.display = panel.classList.contains('open') && enJeu ? 'flex' : 'none';
}

const EMOJIS_RAPIDES = ['üòÇ','üëè','üî•','üíÄ','üò±','ü§î','üëç','üòÆ','üéâ','üò§','üôå','üëÄ'];
function construireBarreEmojis() {
  const bar = document.getElementById('emoji-bar'); if (!bar) return; const label = bar.children[0]; bar.innerHTML = ''; bar.appendChild(label);
  EMOJIS_RAPIDES.forEach(e => { const btn = document.createElement('button'); btn.textContent = e; btn.style.cssText = 'background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:4px 6px;font-size:18px;cursor:pointer;transition:transform .1s'; btn.onmouseenter = () => btn.style.transform = 'scale(1.2)'; btn.onmouseleave = () => btn.style.transform = ''; btn.onclick = () => envoyerEmojiRapide(e); bar.appendChild(btn); });
}

function envoyerEmoji() { const bar = document.getElementById('emoji-bar'); if (!bar) return; const visible = bar.style.display !== 'none' && bar.style.display !== ''; bar.style.display = visible ? 'none' : 'flex'; if (!visible && bar.children.length <= 1) construireBarreEmojis(); }
function envoyerEmojiRapide(emoji) { jouerSon('emoji'); const heure = new Date().toLocaleTimeString('fr', {hour:'2-digit',minute:'2-digit'}); if (STATE.modeConnecte) envoyerWS({ action: 'chat', texte: emoji }); else ajouterMessageChat({ joueur_id: STATE.joueurId, nom: STATE.nom, texte: emoji, heure }); }
function envoyerChat() { const input = document.getElementById('chat-input'); const texte = input.value.trim(); if (!texte) return; input.value = ''; const heure = new Date().toLocaleTimeString('fr', {hour:'2-digit',minute:'2-digit'}); if (STATE.modeConnecte) envoyerWS({ action: 'chat', texte }); else ajouterMessageChat({ joueur_id: STATE.joueurId, nom: STATE.nom, texte, heure }); }

function ajouterMessageChat(msg) {
  const el = document.getElementById('chat-messages'); const div = document.createElement('div'); const estMoi = msg.joueur_id === STATE.joueurId;
  const estEmoji = msg.texte && [...msg.texte].length === 1 && /\p{Emoji}/u.test(msg.texte);
  if (msg.joueur_id) { div.className = 'chat-msg' + (estMoi ? ' moi' : ''); if (estEmoji) div.innerHTML = `<div class="msg-author">${escapeHtml(msg.nom)} ¬∑ ${msg.heure}</div><div style="font-size:32px;line-height:1.2">${escapeHtml(msg.texte)}</div>`; else div.innerHTML = `<div class="msg-author">${escapeHtml(msg.nom)} ¬∑ ${msg.heure}</div><div class="msg-text">${escapeHtml(msg.texte)}</div>`; }
  else { div.className = 'chat-msg system'; div.innerHTML = `<div class="msg-text">${msg.message || escapeHtml(msg.texte || '')}</div>`; }
  el.appendChild(div); el.scrollTop = el.scrollHeight;
  if (!document.getElementById('chat-panel').classList.contains('open')) { document.getElementById('chat-notif').classList.add('show'); if (estEmoji && msg.joueur_id && !estMoi) toast(`${msg.nom} : ${msg.texte}`, ''); }
}

function escapeHtml(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

let SOLO = { joueurs: [], indexTour: 0, sequence: '', paysJoues: new Set(), paysJouesList:[], joueurFautif: null, viesDepart: 10 };

function lancerModeSolo(viesParam) {
  const vies = viesParam || parseInt(document.getElementById('solo-vies')?.value) || 10; STATE.modeConnecte = false; STATE.nbTours = 0; if (!STATE.tempsMax) STATE.tempsMax = 15;
  SOLO.viesDepart = vies; SOLO.joueurs = [{ id: STATE.joueurId, nom: STATE.nom || 'Joueur', vies, en_vie: true, est_ia: false }, { id: 'ia', nom: 'ü§ñ Ordinateur', vies, en_vie: true, est_ia: true }]; SOLO.indexTour = 0; SOLO.sequence = ''; SOLO.paysJoues = new Set(); SOLO.paysJouesList = []; SOLO.joueurFautif = null;
  afficherEcran('screen-lobby'); document.getElementById('lobby-code').textContent = 'SOLO'; const lienWrap = document.querySelector('.link-share'); if (lienWrap) lienWrap.style.display = 'none';
  const btnDem = document.getElementById('btn-demarrer'); btnDem.style.display = ''; btnDem.onclick = demarrerSolo;
  const actions = document.getElementById('lobby-actions'); const oldBtn = document.getElementById('btn-lobby-action'); if (oldBtn) oldBtn.remove();
  const btnBot = document.createElement('button'); btnBot.id = 'btn-lobby-action'; btnBot.className = 'btn btn-secondary'; btnBot.innerHTML = 'ü§ñ Ajouter un bot'; btnBot.onclick = ajouterIALocale; actions.insertBefore(btnBot, btnDem);
  document.getElementById('chat-toggle-btn').classList.add('hidden'); mettreAJourLobbyLocal();
}

function ajouterIALocale() { if (SOLO.joueurs.length >= 4) return; SOLO.joueurs.push({ id: `ia${SOLO.joueurs.length}`, nom: 'ü§ñ Bot', vies: SOLO.viesDepart, en_vie: true, est_ia: true }); mettreAJourLobbyLocal(); }
function mettreAJourLobbyLocal() { mettreAJourLobby({ joueurs: SOLO.joueurs, config: { max_joueurs: 4 } }); }
function demarrerSolo() { document.getElementById('flags-inner').innerHTML = ''; afficherEcran('screen-jeu'); construireClavier(); const badge = document.getElementById('mode-badge'); if (badge && STATE.modeJeu !== 'classique') { badge.textContent = { classique:'üéØ CLASSIQUE', blitz:'‚ö° BLITZ', survie:'üíÄ SURVIE', acceleration:'üî• ACC√âL√âRATION' }[STATE.modeJeu] || ''; badge.style.display = 'block'; } else if (badge) badge.style.display = 'none'; nouveauTourSolo(true); }
function joueurActuelSolo() { return SOLO.joueurs[SOLO.indexTour]; }

function nouveauTourSolo(reset) {
  if (reset === undefined) reset = true; if (reset) { SOLO.sequence = ''; SOLO.joueurFautif = null; } STATE.nbTours++;
  const j = joueurActuelSolo(); STATE.estMonTour = (j.id === STATE.joueurId);
  mettreAJourJeu({ sequence: SOLO.sequence, joueur_actuel: j.id, joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart } });
  if (STATE.modeJeu === 'acceleration') STATE.tempsMax = Math.max(3, (SOLO.tempsDepart || 15) - STATE.nbTours);
  lancerChrono(STATE.tempsMax);
  if (j.est_ia) { activerClavier(false); setTimeout(iaJouerSolo, 1000 + Math.random() * 1200); } else activerClavier(true);
}

function activerClavier(actif) { document.querySelectorAll('.key').forEach(k => { k.disabled = !actif; }); document.getElementById('btn-langue').disabled = !(actif && SOLO.sequence.length > 0 && SOLO.joueurFautif !== STATE.joueurId); }

function traiterLettreLocal(lettre) {
  if (!STATE.estMonTour) return;
  const nouvelleSeq = normaliser(SOLO.sequence) + normaliser(lettre); const possibilites = soloChercherPossibilites(nouvelleSeq);
  if (possibilites.length === 0) { jouerSon('erreur'); flashSequence('invalid'); SOLO.sequence = nouvelleSeq; SOLO.joueurFautif = STATE.joueurId; mettreAJourJeu({ sequence: nouvelleSeq, joueur_actuel: STATE.joueurId, joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart } }); toast("‚ö†Ô∏è S√©quence invalide ‚Äî l'IA peut demander une langue au chat", 'warn'); passerAuSuivantSolo(); return; }
  SOLO.sequence = nouvelleSeq; const match = soloEstComplet(nouvelleSeq);
  if (match) {
    if (SOLO.paysJoues.has(match.nom_normalise)) { toast(`üîÅ ${match.nom} d√©j√† jou√© ! Tu perds une vie.`, 'error'); stopChrono(); setTimeout(() => perdreVieSolo(STATE.joueurId, 'Pays d√©j√† jou√©'), 500); return; }
    const valeur = soloValeurJouee(match, nouvelleSeq); SOLO.paysJoues.add(match.nom_normalise); SOLO.paysJouesList.push({ ...match, _valeur_jouee: valeur }); ajouterDrapeau(match, valeur); flashSequence('complete'); toast(`üíÄ Tu as compl√©t√© ¬´ ${valeur} ¬ª ‚Äî tu perds une vie !`, 'warn'); stopChrono(); setTimeout(() => perdreVieSolo(STATE.joueurId, 'Mot complet'), 1500);
  } else { mettreAJourJeu({ sequence: nouvelleSeq, joueur_actuel: STATE.joueurId, joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart } }); passerAuSuivantSolo(); }
}

function iaJouerSolo() {
  const j = joueurActuelSolo(); if (!j || !j.est_ia) return;
  const seqNorm = normaliser(SOLO.sequence); const possibilites = soloChercherPossibilites(seqNorm);
  if (possibilites.length === 0) { if (SOLO.joueurFautif === STATE.joueurId) ouvrirModalLangueAuChat("L'IA te demande : quel pays visais-tu ?"); else { toast("ü§ñ L'IA donne sa langue au chat ! Elle perd une vie.", 'warn'); stopChrono(); perdreVieSolo('ia', 'IA pi√©g√©e'); } return; }
  const nonJoues = possibilites.filter(p => !SOLO.paysJoues.has(p.nom_normalise));
  if (nonJoues.length === 0) { toast("ü§ñ L'IA est pi√©g√©e (tous les pays d√©j√† jou√©s) ! Elle perd une vie.", 'warn'); stopChrono(); perdreVieSolo('ia', 'Tous pays jou√©s'); return; }
  const longues = nonJoues.filter(p => p[p._cible].length > seqNorm.length + 1); const cibles = longues.length > 0 ? longues : nonJoues; const cible = cibles[Math.floor(Math.random() * cibles.length)];
  const nouvelleSeq = seqNorm + cible[cible._cible][seqNorm.length]; SOLO.sequence = nouvelleSeq; SOLO.joueurFautif = 'ia';
  const match = soloEstComplet(nouvelleSeq);
  if (match) {
    if (SOLO.paysJoues.has(match.nom_normalise)) { toast(`üîÅ L'IA a jou√© ${match.nom} d√©j√† jou√© ! Elle perd une vie.`, 'warn'); stopChrono(); setTimeout(() => perdreVieSolo('ia', 'Pays d√©j√† jou√©'), 500); return; }
    const valeur = soloValeurJouee(match, nouvelleSeq); SOLO.paysJoues.add(match.nom_normalise); SOLO.paysJouesList.push({ ...match, _valeur_jouee: valeur }); ajouterDrapeau(match, valeur); mettreAJourJeu({ sequence: nouvelleSeq, joueur_actuel: 'ia', joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart } }); flashSequence('complete'); toast(`üíÄ L'IA a compl√©t√© ¬´ ${valeur} ¬ª ‚Äî elle perd une vie !`, 'warn'); stopChrono(); setTimeout(() => perdreVieSolo('ia', 'Mot complet'), 1500);
  } else { mettreAJourJeu({ sequence: nouvelleSeq, joueur_actuel: 'ia', joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart } }); passerAuSuivantSolo(); }
}

function demanderLangueAuChatLocal() {
  stopChrono(); const seqNorm = normaliser(SOLO.sequence); const possibilites = soloChercherPossibilites(seqNorm).filter(p => p[p._cible].startsWith(seqNorm) && !SOLO.paysJoues.has(p.nom_normalise));
  setTimeout(() => {
    if (possibilites.length > 0) { const pays = possibilites[Math.floor(Math.random() * possibilites.length)]; const valeur = pays._cible === 'nom_normalise' ? pays.nom : pays.capitale; SOLO.paysJoues.add(pays.nom_normalise); SOLO.paysJouesList.push({ ...pays, _valeur_jouee: valeur }); ajouterDrapeau(pays, valeur); afficherVerdict({ valide: true, message: `L'IA visait ¬´ ${valeur} ¬ª (${SOLO.sequence}‚Ä¶). Valide ! Tu perds une vie.` }); setTimeout(() => { fermerVerdict(); perdreVieSolo(STATE.joueurId, 'Langue au chat perdue'); }, 2000); }
    else { afficherVerdict({ valide: false, message: `L'IA ne peut pas justifier ¬´ ${SOLO.sequence} ¬ª ! Elle perd une vie.` }); setTimeout(() => { fermerVerdict(); perdreVieSolo('ia', 'IA sans r√©ponse'); }, 2000); }
  }, 800);
}

function evaluerReponseLocal(paysPropose) {
  const norm = normaliser(paysPropose); const seqNorm = normaliser(SOLO.sequence); let match = PAYS_LOCAL ? (PAYS_LOCAL.find(p => p.nom_normalise === norm) || null) : null; let champMatch = 'nom_normalise'; let valeurAff = paysPropose;
  if (!match && STATE.modeMixte && PAYS_LOCAL) { match = PAYS_LOCAL.find(p => p.capitale_normalisee === norm) || null; if (match) { champMatch = 'capitale_normalisee'; valeurAff = match.capitale || paysPropose; } }
  if (!match) { afficherVerdict({ valide: false, message: `¬´ ${paysPropose} ¬ª n'existe pas ! Tu perds une vie.` }); setTimeout(() => { fermerVerdict(); perdreVieSolo(STATE.joueurId, 'Pays inexistant'); }, 2000); }
  else if (SOLO.paysJoues.has(match.nom_normalise)) { afficherVerdict({ valide: false, message: `¬´ ${valeurAff} ¬ª a d√©j√† √©t√© jou√© ! Tu perds une vie.` }); setTimeout(() => { fermerVerdict(); perdreVieSolo(STATE.joueurId, 'Pays d√©j√† jou√©'); }, 2000); }
  else if (!match[champMatch].startsWith(seqNorm)) { afficherVerdict({ valide: false, message: `¬´ ${valeurAff} ¬ª ne commence pas par ¬´ ${SOLO.sequence} ¬ª ! Tu perds une vie.` }); setTimeout(() => { fermerVerdict(); perdreVieSolo(STATE.joueurId, 'Pays incoh√©rent'); }, 2000); }
  else { SOLO.paysJoues.add(match.nom_normalise); SOLO.paysJouesList.push({ ...match, _valeur_jouee: valeurAff }); ajouterDrapeau(match, valeurAff); afficherVerdict({ valide: true, message: `‚úÖ ¬´ ${valeurAff} ¬ª commence bien par ¬´ ${SOLO.sequence} ¬ª ! L'IA perd une vie.` }); setTimeout(() => { fermerVerdict(); perdreVieSolo('ia', 'Langue au chat perdue'); }, 2000); }
}

function perdreVieLocal(raison) { perdreVieSolo(STATE.joueurId, raison); }
function perdreVieSolo(joueurId, raison) {
  stopChrono(); const j = SOLO.joueurs.find(x => x.id === joueurId); if (!j) return;
  j.vies--; if (j.vies <= 0) { j.vies = 0; j.en_vie = false; toast(`üòÇ ${j.nom} est OUTTT !`, 'error'); }
  mettreAJourScores({ sequence: SOLO.sequence, joueur_actuel: null, joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart } });
  const vivants = SOLO.joueurs.filter(x => x.en_vie); if (vivants.length <= 1) { setTimeout(() => afficherFinDePartieLocal(vivants[0] || null), 800); return; }
  const idxJ = SOLO.joueurs.indexOf(j); if (j.en_vie) SOLO.indexTour = idxJ; else { const n = SOLO.joueurs.length; let idx = idxJ; for (let i = 0; i < n; i++) { idx = (idx + 1) % n; if (SOLO.joueurs[idx].en_vie) break; } SOLO.indexTour = idx; }
  setTimeout(() => nouveauTourSolo(true), 800);
}

function passerAuSuivantSolo() {
  const n = SOLO.joueurs.length; for (let i = 0; i < n; i++) { SOLO.indexTour = (SOLO.indexTour + 1) % n; if (SOLO.joueurs[SOLO.indexTour].en_vie) break; }
  setTimeout(() => nouveauTourSolo(false), 150);
}

function stopChrono() { clearInterval(STATE.chronoInterval); STATE.chronoInterval = null; }
function flashSequence(type) { const el = document.getElementById('letters-seq'); el.classList.add(type); setTimeout(() => el.classList.remove(type), 600); }
function soloValeurJouee(match, seqNorm) { return (STATE.modeMixte && seqNorm === match.capitale_normalisee) ? match.capitale : match.nom; }
function soloChercherPossibilites(seq) {
  if (!PAYS_LOCAL || !PAYS_LOCAL.length) return []; const s = normaliser(seq); if (!s) return PAYS_LOCAL.map(p => ({ ...p, _cible: 'nom_normalise' })); const res = [];
  for (const p of PAYS_LOCAL) { if (p.nom_normalise.startsWith(s)) res.push({ ...p, _cible: 'nom_normalise' }); else if (STATE.modeMixte && p.capitale_normalisee && p.capitale_normalisee.startsWith(s)) res.push({ ...p, _cible: 'capitale_normalisee' }); } return res;
}
function soloEstComplet(seq) { const s = normaliser(seq); if (!PAYS_LOCAL) return null; for (const p of PAYS_LOCAL) { if (p.nom_normalise === s) return p; if (STATE.modeMixte && p.capitale_normalisee === s) return p; } return null; }

function afficherFinDePartie(msg) {
  const moi = msg.joueurs?.find(j => j.id === STATE.joueurId); if (moi) sauvegarderScore(moi.nom, moi.vies, msg.pays_joues?.length || 0, STATE.nbTours, msg.gagnant === STATE.joueurId ? 1 : 0);
  clearInterval(STATE.chronoInterval); const gagnant = msg.joueurs?.find(j => j.id === msg.gagnant);
  document.getElementById('winner-name').textContent = gagnant ? gagnant.nom : '‚Äî'; document.getElementById('stat-pays').textContent = msg.pays_joues?.length || 0; document.getElementById('stat-tours').textContent = STATE.nbTours; document.getElementById('stat-vies').textContent = gagnant?.vies || 0;
  STATE.paysJouesList = (msg.pays_joues || []).map(p => ({ ...p, _valeur_jouee: p.nom })); setTimeout(() => afficherEcran('screen-fin'), 600);
}

function afficherFinDePartieLocal(gagnant) {
  const joueurHumain = SOLO.joueurs.find(j => j.id === STATE.joueurId); if (joueurHumain) sauvegarderScore(joueurHumain.nom, joueurHumain.vies, SOLO.paysJouesList.length, STATE.nbTours, gagnant && gagnant.id === STATE.joueurId ? 1 : 0);
  document.getElementById('winner-name').textContent = gagnant ? gagnant.nom : '‚Äî'; document.getElementById('stat-pays').textContent = SOLO.paysJouesList.length; document.getElementById('stat-tours').textContent = STATE.nbTours; document.getElementById('stat-vies').textContent = gagnant?.vies || 0;
  afficherEcran('screen-fin');
}

function retourAccueil() { stopChrono(); EN_PAUSE = false; if (STATE.ws) { STATE.ws.close(); STATE.ws = null; } document.getElementById('flags-inner').innerHTML = ''; ['modal-pause','modal-quitter'].forEach(id => document.getElementById(id).classList.add('hidden')); afficherEcran('screen-accueil'); }
function rejouerMeme() { stopChrono(); if (STATE.modeConnecte) retourAccueil(); else { const vies = SOLO.viesDepart; SOLO.joueurs = SOLO.joueurs.map(j => ({ ...j, vies, en_vie: true })); SOLO.indexTour = 0; SOLO.sequence = ''; SOLO.paysJoues = new Set(); SOLO.paysJouesList= []; SOLO.joueurFautif = null; STATE.nbTours = 0; demarrerSolo(); } }

let EN_PAUSE = false;
function basculerPause() {
  if (STATE.modeConnecte) return; // S√©curit√© : pas de pause en multijoueur
  EN_PAUSE = !EN_PAUSE; const btn = document.getElementById('btn-pause');
  if (EN_PAUSE) { clearInterval(STATE.chronoInterval); document.querySelectorAll('.key').forEach(k => k.disabled = true); document.getElementById('btn-langue').disabled = true; btn.textContent = '‚ñ∂ Reprendre'; btn.style.background = 'rgba(0,201,167,0.12)'; btn.style.color = 'var(--teal)'; btn.style.borderColor = 'rgba(0,201,167,0.3)'; document.getElementById('modal-pause').classList.remove('hidden'); }
  else reprendreDepuisPause();
}

function reprendreDepuisPause() {
  EN_PAUSE = false; document.getElementById('modal-pause').classList.add('hidden'); const btn = document.getElementById('btn-pause'); btn.textContent = '‚è∏ Pause'; btn.style.background = 'rgba(255,255,255,0.06)'; btn.style.color = 'var(--paper)'; btn.style.borderColor = 'rgba(255,255,255,0.1)';
  if (STATE.tempsRestant > 0) STATE.chronoInterval = setInterval(() => { STATE.tempsRestant--; actualiserChrono(); if (STATE.tempsRestant <= 0) { clearInterval(STATE.chronoInterval); if (!STATE.modeConnecte && STATE.estMonTour) perdreVieLocal('‚è∞ Temps √©coul√© !'); } }, 1000);
  document.querySelectorAll('.key').forEach(k => k.disabled = !STATE.estMonTour);
}

function confirmerQuitter() { clearInterval(STATE.chronoInterval); document.getElementById('modal-quitter').classList.remove('hidden'); }
function annulerQuitter() {
  document.getElementById('modal-quitter').classList.add('hidden');
  if (!EN_PAUSE && STATE.tempsRestant > 0) STATE.chronoInterval = setInterval(() => { STATE.tempsRestant--; actualiserChrono(); if (STATE.tempsRestant <= 0) { clearInterval(STATE.chronoInterval); if (!STATE.modeConnecte && STATE.estMonTour) perdreVieLocal('‚è∞ Temps √©coul√© !'); } }, 1000);
}

function afficherPaysJoues() {
  const liste = STATE.modeConnecte ? (STATE.paysJouesList || []) : SOLO.paysJouesList; const modal = document.getElementById('modal-pays-joues'); const content = document.getElementById('pays-joues-list'); content.innerHTML = '';
  document.getElementById('pays-joues-count').textContent = `üó∫Ô∏è ${liste.length} mot${liste.length > 1 ? 's' : ''} jou√©${liste.length > 1 ? 's' : ''}`;
  if (!liste.length) content.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px;font-size:13px">Aucun pays jou√©</div>';
  else liste.forEach(item => { const valeur = item._valeur_jouee || item.nom || ''; const code = item.code || 'fr'; const div = document.createElement('div'); div.style.cssText = 'display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05)'; const affichage = (STATE.modeMixte && item._valeur_jouee && item._valeur_jouee !== item.nom) ? `${item._valeur_jouee} <span style="color:var(--muted);font-size:11px">(${item.nom})</span>` : valeur; div.innerHTML = `<img src="https://flagcdn.com/w80/${code}.png" style="width:48px;height:32px;object-fit:cover;border-radius:4px;border:1px solid rgba(255,255,255,0.1);flex-shrink:0" onerror="this.style.display='none'"><span style="font-size:14px">${affichage}</span>`; content.appendChild(div); });
  modal.classList.remove('hidden');
}

function toast(msg, type = '') { const container = document.getElementById('toast-container'); const div = document.createElement('div'); div.className = 'toast' + (type ? ` ${type}` : ''); div.textContent = msg; container.appendChild(div); setTimeout(() => { div.classList.add('exit'); setTimeout(() => div.remove(), 300); }, 3500); }

let _tutoStep = 0; const TUTO_TOTAL = 3;
function afficherTuto() { _tutoStep = 0; document.getElementById('tuto-overlay').classList.remove('hidden'); document.getElementById('tuto-overlay').style.display = 'flex'; _syncTuto(); }
function fermerTuto() { document.getElementById('tuto-overlay').classList.add('hidden'); document.getElementById('tuto-overlay').style.display = ''; localStorage.setItem('paysfatal_tuto', '1'); }
function tutoSuivant() { _tutoStep++; if (_tutoStep >= TUTO_TOTAL) { fermerTuto(); return; } _syncTuto(); }
function _syncTuto() { document.querySelectorAll('.tuto-slide').forEach((s, i) => s.classList.toggle('hidden', i !== _tutoStep)); document.querySelectorAll('.tuto-dot').forEach((d, i) => d.classList.toggle('active', i === _tutoStep)); const btn = document.getElementById('tuto-next'); if (btn) btn.textContent = _tutoStep === TUTO_TOTAL - 1 ? 'üéÆ Jouer !' : 'Suivant ‚Üí'; }

const AudioCtx = window.AudioContext || window.webkitAudioContext; let _actx = null; function getACtx() { if (!_actx) _actx = new AudioCtx(); return _actx; }
let sonsActifs = localStorage.getItem('sons') !== 'off';
function jouerSon(type) {
  if (!sonsActifs) return; try {
    const ctx = getACtx(); const g = ctx.createGain(); g.connect(ctx.destination);
    switch(type) {
      case 'touche': const o1 = ctx.createOscillator(); o1.connect(g); o1.type = 'sine'; o1.frequency.setValueAtTime(880, ctx.currentTime); o1.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.06); g.gain.setValueAtTime(0.18, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.07); o1.start(); o1.stop(ctx.currentTime + 0.07); break;
      case 'erreur': const o2 = ctx.createOscillator(); o2.connect(g); o2.type = 'sawtooth'; o2.frequency.setValueAtTime(180, ctx.currentTime); o2.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.25); g.gain.setValueAtTime(0.22, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25); o2.start(); o2.stop(ctx.currentTime + 0.25); break;
      case 'vie': const o3 = ctx.createOscillator(); o3.connect(g); o3.type = 'square'; o3.frequency.setValueAtTime(220, ctx.currentTime); o3.frequency.exponentialRampToValueAtTime(60, ctx.currentTime + 0.3); g.gain.setValueAtTime(0.3, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3); o3.start(); o3.stop(ctx.currentTime + 0.3); break;
      case 'complet': [0, 0.08, 0.18].forEach((t, i) => { const o = ctx.createOscillator(); const gn = ctx.createGain(); o.connect(gn); gn.connect(ctx.destination); o.type = 'sine'; o.frequency.value = [523, 659, 784][i]; gn.gain.setValueAtTime(0.15, ctx.currentTime + t); gn.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + t + 0.18); o.start(ctx.currentTime + t); o.stop(ctx.currentTime + t + 0.18); }); break;
      case 'victoire': [523,659,784,1047].forEach((freq, i) => { const o = ctx.createOscillator(); const gn = ctx.createGain(); o.connect(gn); gn.connect(ctx.destination); o.type = 'triangle'; o.frequency.value = freq; gn.gain.setValueAtTime(0.18, ctx.currentTime + i * 0.12); gn.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.12 + 0.25); o.start(ctx.currentTime + i * 0.12); o.stop(ctx.currentTime + i * 0.12 + 0.25); }); break;
      case 'langue': const o4 = ctx.createOscillator(); o4.connect(g); o4.type = 'sine'; o4.frequency.setValueAtTime(660, ctx.currentTime); o4.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.15); g.gain.setValueAtTime(0.2, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2); o4.start(); o4.stop(ctx.currentTime + 0.2); break;
      case 'emoji': const o5 = ctx.createOscillator(); o5.connect(g); o5.type = 'sine'; o5.frequency.setValueAtTime(1200, ctx.currentTime); o5.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.08); g.gain.setValueAtTime(0.12, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.08); o5.start(); o5.stop(ctx.currentTime + 0.08); break;
    }
  } catch(e) {}
}

const _AMBIANCE_URL = "https://raw.githubusercontent.com/LAantaaa/pays-game/main/ambiance.mp3"; let _ambianceAudio = null;
function demarrerAmbiance() { if (!sonsActifs || _ambianceAudio) return; try { const audio = new Audio(_AMBIANCE_URL); audio.volume = 0.18; audio.loop = true; audio.play().catch(() => {}); _ambianceAudio = audio; } catch(e) {} }
function arreterAmbiance() { if (_ambianceAudio) { _ambianceAudio.pause(); _ambianceAudio = null; } }
function toggleSons() { sonsActifs = !sonsActifs; localStorage.setItem('sons', sonsActifs ? 'on' : 'off'); const btn = document.getElementById('btn-sons'); if (btn) btn.textContent = sonsActifs ? 'üîä' : 'üîá'; if (sonsActifs) demarrerAmbiance(); else arreterAmbiance(); toast(sonsActifs ? 'üîä Sons activ√©s' : 'üîá Sons d√©sactiv√©s', ''); }

function sauvegarderScore(nomJoueur, viesRestantes, nbPays, nbTours, gagne) {
  try { const scores = JSON.parse(localStorage.getItem('paysfatal_scores') || '[]'); scores.push({ nom: nomJoueur, vies: viesRestantes, pays: nbPays, tours: nbTours, gagne, date: new Date().toLocaleDateString('fr'), ts: Date.now() }); scores.sort((a, b) => { if (b.gagne !== a.gagne) return b.gagne - a.gagne; if (b.vies !== a.vies) return b.vies - a.vies; return b.pays - a.pays; }); localStorage.setItem('paysfatal_scores', JSON.stringify(scores.slice(0, 10))); } catch(e) {}
}

function afficherScores() {
  try {
    const scores = JSON.parse(localStorage.getItem('paysfatal_scores') || '[]'); const modal = document.createElement('div'); modal.className = 'modal-overlay'; modal.style.cssText = 'z-index:9999;display:flex';
    const rows = scores.length ? scores.map((s, i) => `<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.06);color:${i < 3 ? 'var(--amber)' : 'var(--paper)'}"><span style="font-family:'Bebas Neue',sans-serif;font-size:22px;width:28px;text-align:center">${['ü•á','ü•à','ü•â'][i] || (i+1)}</span><div style="flex:1"><div style="font-weight:600">${escapeHtml(s.nom)} ${s.gagne ? 'üëë' : ''}</div><div style="font-size:11px;color:var(--muted)">${s.date}</div></div><div style="text-align:right;font-size:12px;font-family:'DM Mono',monospace"><div>‚ù§Ô∏è ${s.vies}</div><div>üåç ${s.pays}</div></div></div>`).join('') : '<div style="color:var(--muted);text-align:center;padding:20px">Aucun score enregistr√©.</div>';
    modal.innerHTML = `<div class="modal-box" style="max-height:80vh;overflow:hidden;display:flex;flex-direction:column"><span class="modal-emoji">üèÜ</span><div class="modal-title">MEILLEURS SCORES</div><div style="overflow-y:auto;flex:1">${rows}</div><div class="modal-actions" style="margin-top:12px;gap:8px"><button class="btn btn-secondary" onclick="localStorage.removeItem('paysfatal_scores');this.closest('.modal-overlay').remove();toast('Scores effac√©s','warn')">Effacer</button><button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Fermer</button></div></div>`;
    document.body.appendChild(modal);
  } catch(e) { toast('Erreur lecture scores', 'error'); }
}

function init() {
  construireClavier(); STATE.modeConnecte = false; allerStep('step-choix');
  if (!localStorage.getItem('paysfatal_tuto')) setTimeout(afficherTuto, 600);
  document.addEventListener('click', () => { if (sonsActifs) demarrerAmbiance(); }, { once: true });
  chargerPaysLocal('fr');
  const roomFromUrl = new URLSearchParams(window.location.search).get('room');
  if (roomFromUrl && roomFromUrl.length === 6) { allerStep('step-rejoindre'); document.getElementById('rejoindre-code').value = roomFromUrl.toUpperCase(); toast(`üîó Code d√©tect√© : ${roomFromUrl.toUpperCase()} ‚Äî entrez votre nom et rejoignez !`, ''); }
}

init();
