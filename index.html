<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PAYS GAME ğŸŒ</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Mono:wght@400;500&family=Crimson+Pro:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VARIABLES & RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --ink:       #0d0f14;
  --paper:     #f5f0e8;
  --ocean:     #0a1628;
  --ocean-mid: #112240;
  --teal:      #00c9a7;
  --amber:     #f4a947;
  --crimson:   #e63946;
  --gold:      #d4a853;
  --muted:     #4a5568;
  --grid:      rgba(0,201,167,0.06);

  --r-sm: 6px;
  --r-md: 12px;
  --r-lg: 20px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  background: var(--ocean);
  color: var(--paper);
  font-family: 'Crimson Pro', Georgia, serif;
  font-size: 16px;
  overflow-x: hidden;
}

/* Grille cartographique en fond */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(var(--grid) 1px, transparent 1px),
    linear-gradient(90deg, var(--grid) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: 0;
}

body::after {
  content: '';
  position: fixed;
  inset: 0;
  background: radial-gradient(ellipse at 20% 50%, rgba(0,201,167,0.05) 0%, transparent 60%),
              radial-gradient(ellipse at 80% 20%, rgba(244,169,71,0.05) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILITAIRES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hidden { display: none !important; }

button {
  cursor: pointer;
  border: none;
  font-family: 'DM Mono', monospace;
  transition: all .18s ease;
}

input, select {
  font-family: 'DM Mono', monospace;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.12);
  color: var(--paper);
  border-radius: var(--r-sm);
  padding: 10px 14px;
  outline: none;
  transition: border-color .2s;
}
input:focus, select:focus { border-color: var(--teal); }
input::placeholder { color: var(--muted); }
select option { background: var(--ocean-mid); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT PRINCIPAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  overflow-y: auto;
  padding: 20px 16px;
  padding-bottom: 40px;
  z-index: 1;
  /* Centre verticalement si le contenu est plus petit que l'Ã©cran */
  min-height: 100%;
}

/* Wrapper centrant uniquement quand il y a de la place */
#screen-accueil {
  justify-content: center;
}
@media (max-height: 700px) {
  #screen-accueil {
    justify-content: flex-start;
    padding-top: 16px;
  }
  .logo-wrap {
    margin-bottom: 16px;
  }
  .logo-title {
    font-size: clamp(36px, 8vw, 60px);
  }
  .logo-globe {
    font-size: 32px;
  }
}

.logo-wrap {
  text-align: center;
  margin-bottom: 48px;
  animation: floatIn .8s cubic-bezier(.16,1,.3,1) both;
}

.logo-sub {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  letter-spacing: 4px;
  color: var(--teal);
  text-transform: uppercase;
  margin-bottom: 10px;
}

.logo-title {
  font-family: 'Playfair Display', serif;
  font-size: clamp(52px, 10vw, 88px);
  font-weight: 900;
  line-height: .9;
  background: linear-gradient(135deg, var(--paper) 0%, var(--gold) 60%, var(--amber) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -2px;
}

.logo-globe {
  font-size: 48px;
  display: block;
  margin-bottom: 8px;
  animation: spin-slow 20s linear infinite;
  display: inline-block;
}

.card {
  background: rgba(17,34,64,.85);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--r-lg);
  padding: clamp(16px, 5vw, 32px);
  width: 100%;
  max-width: 420px;
  backdrop-filter: blur(20px);
  box-shadow: 0 24px 64px rgba(0,0,0,.5);
  animation: floatIn .8s .15s cubic-bezier(.16,1,.3,1) both;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

.form-group label {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  letter-spacing: 2px;
  color: var(--teal);
  text-transform: uppercase;
}

.form-group input,
.form-group select {
  width: 100%;
  font-size: 15px;
}

.row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

.toggle-wrap {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 0;
  border-top: 1px solid rgba(255,255,255,0.07);
  margin-top: 4px;
}

.toggle-wrap span {
  font-size: 14px;
  color: rgba(245,240,232,0.7);
}

.toggle {
  position: relative;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
}
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,0.1);
  border-radius: 24px;
  cursor: pointer;
  transition: .3s;
}
.toggle-slider::before {
  content: '';
  position: absolute;
  left: 3px; top: 3px;
  width: 18px; height: 18px;
  background: var(--paper);
  border-radius: 50%;
  transition: .3s;
}
.toggle input:checked + .toggle-slider { background: var(--teal); }
.toggle input:checked + .toggle-slider::before { transform: translateX(20px); }

.separator {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 20px 0;
  color: var(--muted);
  font-size: 13px;
}
.separator::before, .separator::after {
  content: '';
  flex: 1;
  height: 1px;
  background: rgba(255,255,255,0.08);
}

.btn {
  width: 100%;
  padding: 14px;
  border-radius: var(--r-md);
  font-size: 13px;
  font-weight: 500;
  letter-spacing: 1.5px;
  text-transform: uppercase;
}

.btn-primary {
  background: linear-gradient(135deg, var(--teal), #00a88d);
  color: var(--ink);
  font-weight: 700;
}
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,201,167,.3); }
.btn-primary:active { transform: translateY(0); }

.btn-secondary {
  background: rgba(255,255,255,0.06);
  color: var(--paper);
  border: 1px solid rgba(255,255,255,0.12);
}
.btn-secondary:hover { background: rgba(255,255,255,0.1); }

.btn-ghost {
  background: transparent;
  color: var(--teal);
  padding: 10px;
  font-size: 12px;
}
.btn-ghost:hover { color: var(--amber); }

.rooms-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 200px;
  overflow-y: auto;
  margin-top: 8px;
}

.room-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--r-sm);
  cursor: pointer;
  transition: all .15s;
}
.room-item:hover { background: rgba(0,201,167,0.08); border-color: var(--teal); }
.room-item .room-id { font-family: 'DM Mono', monospace; font-size: 13px; color: var(--gold); }
.room-item .room-info { font-size: 12px; color: var(--muted); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ã‰CRAN 2 â€” LOBBY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-lobby {
  gap: 16px;
  justify-content: flex-start;
  padding-top: 20px;
}

.lobby-header {
  display: flex;
  align-items: center;
  gap: 12px;
  width: 100%;
  max-width: 480px;
  animation: floatIn .5s cubic-bezier(.16,1,.3,1) both;
}

.lobby-header h2 {
  font-family: 'Playfair Display', serif;
  font-size: clamp(20px, 5vw, 28px);
  font-weight: 700;
  flex: 1;
  text-align: center;
}

.room-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: rgba(212,168,83,0.15);
  border: 1px solid rgba(212,168,83,0.3);
  border-radius: 30px;
  padding: 6px 16px;
  font-family: 'DM Mono', monospace;
  font-size: 18px;
  color: var(--gold);
  letter-spacing: 4px;
  margin-top: 8px;
}

.link-share {
  display: flex;
  gap: 8px;
  align-items: center;
  background: rgba(255,255,255,0.05);
  border: 1px dashed rgba(255,255,255,0.15);
  border-radius: var(--r-sm);
  padding: 10px 14px;
  font-family: 'DM Mono', monospace;
  font-size: 12px;
  color: var(--muted);
  cursor: pointer;
  width: 100%;
  max-width: 420px;
  text-align: left;
  transition: all .15s;
}
.link-share:hover { border-color: var(--teal); color: var(--teal); }
.link-share .link-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.players-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 10px;
  width: 100%;
  max-width: 480px;
}

.player-slot {
  background: rgba(255,255,255,0.04);
  border: 1px dashed rgba(255,255,255,0.1);
  border-radius: var(--r-md);
  padding: 16px 10px;
  text-align: center;
  transition: all .3s;
}
.player-slot.filled {
  border: 1px solid rgba(0,201,167,0.3);
  background: rgba(0,201,167,0.06);
  animation: popIn .3s cubic-bezier(.16,1,.3,1);
}
.player-slot .slot-avatar { font-size: 28px; margin-bottom: 6px; }
.player-slot .slot-name { font-size: 13px; font-weight: 600; }
.player-slot .slot-tag { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--teal); }

.lobby-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
  width: 100%;
  max-width: 420px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ã‰CRAN 3 â€” JEU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-jeu {
  justify-content: flex-start;
  padding: 0;
  overflow: hidden; /* le scroll est gÃ©rÃ© en interne par game-main */
}

/* Bandeau scores */
.scores-bar {
  width: 100%;
  display: flex;
  align-items: stretch;
  background: rgba(17,34,64,.95);
  border-bottom: 1px solid rgba(255,255,255,0.08);
  backdrop-filter: blur(20px);
  position: sticky;
  top: 0;
  z-index: 10;
}

.score-player {
  flex: 1;
  padding: 12px 14px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  transition: background .3s;
}
.score-player.active { background: rgba(0,201,167,0.08); }

.score-player .player-name {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  letter-spacing: 1px;
  opacity: 0.6;
  text-transform: uppercase;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.score-player.active .player-name { opacity: 1; color: var(--teal); }

.lives-dots {
  display: flex;
  gap: 3px;
  flex-wrap: wrap;
}
.life-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--crimson);
  transition: all .3s;
}
.life-dot.lost { background: rgba(255,255,255,0.1); }

.score-vs {
  padding: 12px 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  color: var(--muted);
}

/* Chrono */
.chrono-bar {
  width: 100%;
  height: 3px;
  background: rgba(255,255,255,0.06);
  overflow: hidden;
}
.chrono-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--teal), var(--amber));
  width: 100%;
  transition: width 1s linear, background .5s;
  transform-origin: left;
}
.chrono-fill.urgent { background: linear-gradient(90deg, var(--amber), var(--crimson)); }

/* Zone de jeu centrale */
.game-main {
  flex: 1;
  width: 100%;
  max-width: 520px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 16px;
  gap: 14px;
  overflow-y: auto;
}

/* Lettres en cours */
.letters-display {
  text-align: center;
  min-height: 80px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.letters-sequence {
  font-family: 'Playfair Display', serif;
  font-size: clamp(32px, 8vw, 52px);
  font-weight: 700;
  letter-spacing: 8px;
  color: var(--paper);
  text-shadow: 0 0 30px rgba(0,201,167,.3);
  min-height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color .3s;
}
.letters-sequence.invalid { color: var(--crimson); animation: shake .3s ease; }
.letters-sequence.complete { color: var(--teal); }

.turn-indicator {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  letter-spacing: 2px;
  color: var(--teal);
  text-transform: uppercase;
  animation: pulse 2s infinite;
}

.possibilities-count {
  font-size: 12px;
  color: var(--muted);
  font-family: 'DM Mono', monospace;
}

/* Historique drapeaux */
.flags-scroll {
  width: 100%;
  overflow-x: auto;
  padding: 8px 0;
}
.flags-scroll::-webkit-scrollbar { height: 3px; }
.flags-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

.flags-inner {
  display: flex;
  gap: 10px;
  padding: 0 4px;
  min-height: 52px;
  align-items: center;
}

.flag-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  flex-shrink: 0;
  animation: popIn .3s cubic-bezier(.16,1,.3,1);
}
.flag-item img {
  width: 48px;
  height: 32px;
  object-fit: cover;
  border-radius: 4px;
  border: 1px solid rgba(255,255,255,0.12);
}
.flag-item .flag-name {
  font-family: 'DM Mono', monospace;
  font-size: 8px;
  color: var(--muted);
  max-width: 48px;
  text-align: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Clavier */
.keyboard-wrap {
  width: 100%;
  padding: 0 4px;
}

.keyboard {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 5px;
}

.key {
  aspect-ratio: 1;
  border-radius: var(--r-sm);
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.08);
  color: var(--paper);
  font-family: 'DM Mono', monospace;
  font-size: 13px;
  font-weight: 500;
  transition: all .12s;
  position: relative;
  overflow: hidden;
}
.key::after {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at center, rgba(0,201,167,.3) 0%, transparent 70%);
  opacity: 0;
  transition: opacity .12s;
}
.key:hover:not(:disabled) { background: rgba(0,201,167,0.12); border-color: rgba(0,201,167,.4); transform: scale(1.05); }
.key:hover::after { opacity: 1; }
.key:active:not(:disabled) { transform: scale(0.95); }
.key:disabled { opacity: 0.25; cursor: not-allowed; }

/* Bouton langue au chat */
.btn-langue {
  width: 100%;
  padding: 12px;
  border-radius: var(--r-md);
  background: rgba(230,57,70,0.12);
  border: 1px solid rgba(230,57,70,0.25);
  color: var(--crimson);
  font-size: 12px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  transition: all .2s;
}
.btn-langue:hover { background: rgba(230,57,70,0.2); border-color: var(--crimson); }
.btn-langue:disabled { opacity: 0.3; cursor: not-allowed; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT EN COURS DE PARTIE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chat-panel {
  position: fixed;
  right: 0;
  top: 0;
  bottom: 0;
  width: 260px;
  background: rgba(10,22,40,.95);
  border-left: 1px solid rgba(255,255,255,0.07);
  display: flex;
  flex-direction: column;
  transform: translateX(100%);
  transition: transform .3s cubic-bezier(.16,1,.3,1);
  z-index: 20;
  backdrop-filter: blur(20px);
}
.chat-panel.open { transform: translateX(0); }

.chat-toggle {
  position: fixed;
  right: 16px;
  bottom: 80px;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: rgba(17,34,64,.9);
  border: 1px solid rgba(255,255,255,.12);
  color: var(--paper);
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 21;
  transition: all .2s;
  cursor: pointer;
}
.chat-toggle:hover { background: rgba(0,201,167,0.15); border-color: var(--teal); }
.chat-toggle .notif {
  position: absolute;
  top: -2px; right: -2px;
  width: 12px; height: 12px;
  background: var(--crimson);
  border-radius: 50%;
  border: 2px solid var(--ocean);
  display: none;
}
.chat-toggle .notif.show { display: block; }

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.chat-messages::-webkit-scrollbar { width: 3px; }
.chat-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); }

.chat-msg {
  font-size: 13px;
  line-height: 1.4;
}
.chat-msg .msg-author {
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  color: var(--teal);
  margin-bottom: 2px;
}
.chat-msg.system .msg-text {
  color: var(--amber);
  font-style: italic;
  font-size: 12px;
}

.chat-input-wrap {
  padding: 12px;
  border-top: 1px solid rgba(255,255,255,0.07);
  display: flex;
  gap: 8px;
}
.chat-input-wrap input { flex: 1; font-size: 13px; padding: 8px 10px; }
.chat-input-wrap button {
  background: var(--teal);
  color: var(--ink);
  border-radius: var(--r-sm);
  padding: 8px 12px;
  font-size: 13px;
  font-weight: 700;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL (langue au chat, fin de partie)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  padding: 20px;
  animation: fadeIn .2s ease;
}
.modal-overlay.hidden { display: none; }

.modal-box {
  background: var(--ocean-mid);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: var(--r-lg);
  padding: 32px;
  width: 100%;
  max-width: 380px;
  text-align: center;
  box-shadow: 0 32px 80px rgba(0,0,0,.6);
  animation: floatIn .3s cubic-bezier(.16,1,.3,1);
}

.modal-emoji { font-size: 48px; margin-bottom: 12px; display: block; }

.modal-title {
  font-family: 'Playfair Display', serif;
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 8px;
}

.modal-text {
  color: rgba(245,240,232,0.7);
  font-size: 15px;
  line-height: 1.5;
  margin-bottom: 24px;
}

.modal-input {
  width: 100%;
  font-size: 18px;
  font-family: 'Playfair Display', serif;
  text-align: center;
  padding: 12px;
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 16px;
}

.modal-actions { display: flex; flex-direction: column; gap: 10px; }

/* Verdict */
.verdict-valid   { color: var(--teal); }
.verdict-invalid { color: var(--crimson); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIN DE PARTIE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-fin {
  gap: 24px;
}

.winner-display {
  text-align: center;
  animation: floatIn .6s cubic-bezier(.16,1,.3,1) both;
}

.winner-crown { font-size: 64px; animation: bounce 1s ease infinite alternate; }

.winner-name {
  font-family: 'Playfair Display', serif;
  font-size: 36px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--gold), var(--amber));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin: 8px 0;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  width: 100%;
  max-width: 360px;
}

.stat-cell {
  background: rgba(255,255,255,0.04);
  border-radius: var(--r-md);
  padding: 16px 10px;
  text-align: center;
}
.stat-cell .stat-val {
  font-family: 'Playfair Display', serif;
  font-size: 28px;
  font-weight: 700;
  color: var(--teal);
}
.stat-cell .stat-lbl {
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  color: var(--muted);
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-top: 4px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTIFICATIONS TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast-container {
  position: fixed;
  top: 70px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 200;
  pointer-events: none;
  width: min(400px, 90vw);
}

.toast {
  background: rgba(17,34,64,.95);
  border-radius: var(--r-md);
  padding: 12px 16px;
  font-size: 14px;
  border-left: 3px solid var(--teal);
  backdrop-filter: blur(20px);
  animation: toastIn .3s cubic-bezier(.16,1,.3,1);
  box-shadow: 0 8px 24px rgba(0,0,0,.4);
}
.toast.warn  { border-color: var(--amber); }
.toast.error { border-color: var(--crimson); }
.toast.exit  { animation: toastOut .3s ease forwards; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes floatIn {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes fadeIn {
  from { opacity: 0; } to { opacity: 1; }
}
@keyframes popIn {
  from { opacity: 0; transform: scale(0.7); }
  to   { opacity: 1; transform: scale(1); }
}
@keyframes shake {
  0%,100% { transform: translateX(0); }
  20%,60% { transform: translateX(-6px); }
  40%,80% { transform: translateX(6px); }
}
@keyframes pulse {
  0%,100% { opacity: 1; } 50% { opacity: 0.5; }
}
@keyframes bounce {
  from { transform: translateY(0); } to { transform: translateY(-10px); }
}
@keyframes spin-slow {
  from { transform: rotate(0deg); } to { transform: rotate(360deg); }
}
@keyframes toastIn {
  from { opacity: 0; transform: translateY(-10px) scale(0.95); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
@keyframes toastOut {
  from { opacity: 1; transform: translateY(0); }
  to   { opacity: 0; transform: translateY(-10px); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (min-width: 768px) {
  #screen-jeu { max-width: 520px; margin: 0 auto; }
  #screen-lobby { align-items: center; }
}

/* Petits mobiles : taille des touches du clavier */
@media (max-width: 360px) {
  .keyboard { gap: 3px; }
  .key { font-size: 11px; }
  .game-main { padding: 12px 8px; gap: 10px; }
  .letters-sequence { font-size: 28px; letter-spacing: 4px; }
}

/* TrÃ¨s petits mobiles en hauteur : compresser l'Ã©cran de jeu */
@media (max-height: 600px) {
  .game-main { padding: 8px; gap: 8px; }
  .letters-display { min-height: 50px; }
  .flags-scroll { display: none; } /* masquer l'historique si vraiment trop petit */
}

/* Accueil : input et select plein largeur sur mobile */
@media (max-width: 400px) {
  .row-2 { flex-direction: column; }
  .card { border-radius: var(--r-md); }
}

/* â”€â”€ Wizard accueil â”€â”€ */
.step-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  padding-bottom: 14px;
  border-bottom: 1px solid rgba(255,255,255,0.07);
}
.step-header span {
  font-family: 'Playfair Display', serif;
  font-size: 18px;
  font-weight: 700;
  flex: 1;
}
.btn-retour {
  background: none;
  border: none;
  color: var(--muted);
  font-family: 'DM Mono', monospace;
  font-size: 12px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: color .15s;
  white-space: nowrap;
}
.btn-retour:hover { color: var(--paper); }
/* Animation de transition entre Ã©tapes */
.card { transition: opacity .15s; }
</style>
</head>
<body>
<!-- Panneau debug â€” Ctrl+D pour afficher -->
<div id="debug-panel" style="display:none;position:fixed;bottom:0;left:0;right:0;background:#000d;color:#0f0;font-family:monospace;padding:6px;z-index:9999;max-height:180px;overflow-y:auto"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Ã‰CRAN 1 â€” ACCUEIL (wizard 3 Ã©tapes)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-accueil" class="screen">
  <div class="logo-wrap">
    <div class="logo-sub">Le jeu des nations</div>
    <span class="logo-globe">ğŸŒ</span>
    <div class="logo-title">PAYS<br>GAME</div>
  </div>

  <!-- Ã‰TAPE 0 â€” Choix Solo ou Multijoueur -->
  <div id="step-choix" class="card" style="text-align:center">
    <p style="color:var(--muted);font-size:13px;margin-bottom:20px;font-family:'DM Mono',monospace;letter-spacing:1px">CHOISIR UN MODE</p>
    <button class="btn btn-primary" style="font-size:16px;height:60px" onclick="allerStep('step-solo')">
      ğŸ¤– Solo vs Ordinateur
    </button>
    <div class="separator">ou</div>
    <button class="btn btn-secondary" style="font-size:16px;height:60px" onclick="allerStep('step-multi')">
      ğŸŒ Multijoueur en ligne
    </button>
  </div>

  <!-- Ã‰TAPE 1 â€” Solo -->
  <div id="step-solo" class="card hidden">
    <div class="step-header">
      <button class="btn-retour" onclick="allerStep('step-choix')">â† Retour</button>
      <span>Mode Solo</span>
    </div>
    <div class="form-group">
      <label>Ton nom</label>
      <input id="solo-nom" type="text" placeholder="Ex: Alice" maxlength="20">
    </div>
    <div class="row-2">
      <div class="form-group">
        <label>Langue</label>
        <select id="solo-langue">
          <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
          <option value="en">ğŸ‡¬ğŸ‡§ English</option>
        </select>
      </div>
      <div class="form-group">
        <label>Vies</label>
        <select id="solo-vies">
          <option value="5">5 vies</option>
          <option value="10" selected>10 vies</option>
          <option value="15">15 vies</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Chrono</label>
      <select id="solo-temps">
        <option value="10">10 sec</option>
        <option value="15" selected>15 sec</option>
        <option value="30">30 sec</option>
        <option value="60">60 sec</option>
      </select>
    </div>
    <div class="toggle-wrap">
      <label class="toggle">
        <input type="checkbox" id="solo-mixte">
        <span class="toggle-slider"></span>
      </label>
      <span>Mode mixte â€” pays <em>&</em> capitales</span>
    </div>
    <button class="btn btn-primary" onclick="lancerSolo()">
      â–¶ Jouer
    </button>
  </div>

  <!-- Ã‰TAPE 2 â€” Choix CrÃ©er / Rejoindre -->
  <div id="step-multi" class="card hidden">
    <div class="step-header">
      <button class="btn-retour" onclick="allerStep('step-choix')">â† Retour</button>
      <span>Multijoueur</span>
    </div>
    <button class="btn btn-primary" style="height:56px" onclick="allerStep('step-creer')">
      ğŸ—ºï¸ CrÃ©er une partie
    </button>
    <div class="separator">ou</div>
    <button class="btn btn-secondary" style="height:56px" onclick="allerStep('step-rejoindre')">
      ğŸ”— Rejoindre avec un code
    </button>
    <div style="margin-top:12px">
      <button class="btn btn-ghost" onclick="rafraichirRooms()">âŸ³ Parties publiques disponibles</button>
      <div id="rooms-list" class="rooms-list"></div>
    </div>
  </div>

  <!-- Ã‰TAPE 3a â€” CrÃ©er -->
  <div id="step-creer" class="card hidden">
    <div class="step-header">
      <button class="btn-retour" onclick="allerStep('step-multi')">â† Retour</button>
      <span>CrÃ©er une partie</span>
    </div>
    <div class="form-group">
      <label>Ton nom</label>
      <input id="creer-nom" type="text" placeholder="Ex: Alice" maxlength="20">
    </div>
    <div class="row-2">
      <div class="form-group">
        <label>Langue</label>
        <select id="creer-langue">
          <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
          <option value="en">ğŸ‡¬ğŸ‡§ English</option>
        </select>
      </div>
      <div class="form-group">
        <label>Vies</label>
        <select id="creer-vies">
          <option value="5">5 vies</option>
          <option value="10" selected>10 vies</option>
          <option value="15">15 vies</option>
        </select>
      </div>
    </div>
    <div class="row-2">
      <div class="form-group">
        <label>Chrono</label>
        <select id="creer-temps">
          <option value="10">10 sec</option>
          <option value="15" selected>15 sec</option>
          <option value="30">30 sec</option>
          <option value="60">60 sec</option>
        </select>
      </div>
      <div class="form-group">
        <label>Joueurs max</label>
        <select id="creer-max">
          <option value="2">2</option>
          <option value="4" selected>4</option>
          <option value="8">8</option>
        </select>
      </div>
    </div>
    <div class="toggle-wrap">
      <label class="toggle">
        <input type="checkbox" id="creer-mixte">
        <span class="toggle-slider"></span>
      </label>
      <span>Mode mixte â€” pays <em>&</em> capitales</span>
    </div>
    <button class="btn btn-primary" onclick="creerPartie()" id="btn-creer">
      ğŸ—ºï¸ CrÃ©er la partie
    </button>
  </div>

  <!-- Ã‰TAPE 3b â€” Rejoindre -->
  <div id="step-rejoindre" class="card hidden">
    <div class="step-header">
      <button class="btn-retour" onclick="allerStep('step-multi')">â† Retour</button>
      <span>Rejoindre</span>
    </div>
    <div class="form-group">
      <label>Ton nom</label>
      <input id="rejoindre-nom" type="text" placeholder="Ex: Bob" maxlength="20">
    </div>
    <div class="form-group">
      <label>Code de la salle</label>
      <input id="rejoindre-code" type="text" placeholder="Ex: ABCDEF" maxlength="6"
             style="text-transform:uppercase;letter-spacing:6px;font-size:22px;text-align:center"
             oninput="this.value=this.value.toUpperCase()"
             onkeydown="if(event.key==='Enter')rejoindreParCode()">
    </div>
    <button class="btn btn-primary" onclick="rejoindreParCode()">
      Rejoindre â†’
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Ã‰CRAN 2 â€” LOBBY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-lobby" class="screen hidden">
  <div class="lobby-header">
    <button onclick="retourAccueil()" style="background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;padding:0;line-height:1" title="Retour Ã  l'accueil">â†</button>
    <h2>Salle d'attente</h2>
    <div class="room-badge" id="lobby-code">â€”â€”</div>
  </div>

  <button class="link-share" onclick="copierLien()">
    <span>ğŸ”—</span>
    <span class="link-text" id="lien-partage">Chargementâ€¦</span>
    <span style="color:var(--teal);font-size:11px">COPIER</span>
  </button>

  <div id="players-grid" class="players-grid"></div>

  <div class="lobby-actions">
    <button class="btn btn-secondary" onclick="ajouterIA()">
      ğŸ¤– Ajouter un bot
    </button>
    <button class="btn btn-primary" id="btn-demarrer" onclick="demarrerPartie()">
      â–¶ Lancer la partie
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Ã‰CRAN 3 â€” JEU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-jeu" class="screen hidden" style="padding:0">

  <!-- BUG05 FIX â€” Barre d'actions pause / quitter -->
  <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 12px;background:rgba(10,22,40,.95);border-bottom:1px solid rgba(255,255,255,0.06)">
    <button id="btn-pause" onclick="basculerPause()" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:var(--paper);border-radius:8px;padding:6px 14px;font-family:'DM Mono',monospace;font-size:12px;cursor:pointer;transition:all .2s">â¸ Pause</button>
    <button onclick="confirmerQuitter()" style="background:rgba(230,57,70,0.1);border:1px solid rgba(230,57,70,0.25);color:var(--crimson);border-radius:8px;padding:6px 14px;font-family:'DM Mono',monospace;font-size:12px;cursor:pointer;transition:all .2s">âœ• Quitter</button>
  </div>

  <!-- Scores -->
  <div class="scores-bar" id="scores-bar"></div>

  <!-- Chrono -->
  <div class="chrono-bar">
    <div class="chrono-fill" id="chrono-fill"></div>
  </div>

  <!-- Zone principale -->
  <div class="game-main">
    <div class="letters-display">
      <div class="letters-sequence" id="letters-seq">â€¦</div>
      <div class="turn-indicator" id="turn-indicator">En attente</div>
      <div class="possibilities-count" id="poss-count"></div>
    </div>

    <!-- Historique drapeaux -->
    <div class="flags-scroll">
      <div class="flags-inner" id="flags-inner"></div>
    </div>

    <!-- Clavier -->
    <div class="keyboard-wrap">
      <div class="keyboard" id="keyboard"></div>
    </div>

    <!-- Langue au chat -->
    <button class="btn-langue" id="btn-langue" onclick="demanderLangueAuChat()">
      ğŸ—£ Donner ma langue au chat
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Ã‰CRAN 4 â€” FIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-fin" class="screen hidden">
  <div class="winner-display">
    <div class="winner-crown">ğŸ‘‘</div>
    <div style="font-family:'DM Mono',monospace;font-size:11px;letter-spacing:3px;color:var(--teal)">VAINQUEUR</div>
    <div class="winner-name" id="winner-name">â€”</div>
  </div>

  <div class="stats-grid">
    <div class="stat-cell">
      <div class="stat-val" id="stat-pays">0</div>
      <div class="stat-lbl">Pays jouÃ©s</div>
    </div>
    <div class="stat-cell">
      <div class="stat-val" id="stat-tours">0</div>
      <div class="stat-lbl">Tours</div>
    </div>
    <div class="stat-cell">
      <div class="stat-val" id="stat-vies">0</div>
      <div class="stat-lbl">Vies restantes</div>
    </div>
  </div>

  <div style="display:flex;gap:12px;width:100%;max-width:360px">
    <button class="btn btn-secondary" style="flex:1" onclick="retourAccueil()">â† Accueil</button>
    <button class="btn btn-primary" style="flex:1" onclick="rejouerMeme()">â†º Rejouer</button>
  </div>

  <!-- BUG04 FIX â€” Bouton voir pays jouÃ©s -->
  <button class="btn btn-secondary" style="width:100%;max-width:360px" onclick="afficherPaysJoues()">
    ğŸ—ºï¸ Voir les pays jouÃ©s
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<button class="chat-toggle" onclick="toggleChat()">
  ğŸ’¬
  <span class="notif" id="chat-notif"></span>
</button>

<div class="chat-panel" id="chat-panel">
  <div style="padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;justify-content:space-between;align-items:center">
    <span style="font-family:'DM Mono',monospace;font-size:11px;letter-spacing:2px;color:var(--teal)">CHAT</span>
    <button onclick="toggleChat()" style="background:none;color:var(--muted);font-size:18px;line-height:1">Ã—</button>
  </div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-input-wrap">
    <input id="chat-input" type="text" placeholder="Messageâ€¦" maxlength="200" onkeydown="if(e.key==='Enter')envoyerChat()">
    <button onclick="envoyerChat()">â†‘</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL â€” LANGUE AU CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay hidden" id="modal-langue">
  <div class="modal-box">
    <span class="modal-emoji">ğŸ—£ï¸</span>
    <div class="modal-title">Langue au chat !</div>
    <div class="modal-text" id="modal-langue-text">Quel pays avais-tu en tÃªte ?</div>
    <input class="modal-input" id="modal-langue-input" type="text" placeholder="FRANCEâ€¦"
      onkeydown="if(event.key==='Enter')validerLangueAuChat()">
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="validerLangueAuChat()">Valider</button>
    </div>
  </div>
</div>

<!-- MODAL â€” VERDICT -->
<div class="modal-overlay hidden" id="modal-verdict">
  <div class="modal-box">
    <span class="modal-emoji" id="verdict-emoji">âš–ï¸</span>
    <div class="modal-title" id="verdict-title">Verdict</div>
    <div class="modal-text" id="verdict-text"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="fermerVerdict()">OK</button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<!-- BUG05 FIX â€” MODAL PAUSE -->
<div class="modal-overlay hidden" id="modal-pause">
  <div class="modal-box" style="text-align:center">
    <span class="modal-emoji">â¸</span>
    <div class="modal-title">Partie en pause</div>
    <div class="modal-text">Le chrono est arrÃªtÃ©.</div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="reprendreDepuisPause()">â–¶ Reprendre</button>
    </div>
  </div>
</div>

<!-- BUG05 FIX â€” MODAL QUITTER -->
<div class="modal-overlay hidden" id="modal-quitter">
  <div class="modal-box" style="text-align:center">
    <span class="modal-emoji">ğŸšª</span>
    <div class="modal-title">Quitter la partie ?</div>
    <div class="modal-text">La partie sera abandonnÃ©e.</div>
    <div class="modal-actions" style="flex-direction:row;gap:10px">
      <button class="btn btn-secondary" style="flex:1" onclick="annulerQuitter()">Continuer</button>
      <button class="btn btn-primary" style="flex:1;background:var(--crimson);color:#fff" onclick="retourAccueil()">Quitter</button>
    </div>
  </div>
</div>

<!-- BUG04 FIX â€” MODAL PAYS JOUÃ‰S -->
<div class="modal-overlay hidden" id="modal-pays-joues">
  <div class="modal-box" style="max-width:460px;text-align:left">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div id="pays-joues-count" style="font-family:'DM Mono',monospace;font-size:13px;color:var(--teal)"></div>
      <button onclick="document.getElementById('modal-pays-joues').classList.add('hidden')"
        style="background:none;color:var(--muted);font-size:20px;cursor:pointer;line-height:1">Ã—</button>
    </div>
    <div id="pays-joues-list" style="max-height:340px;overflow-y:auto;padding-right:4px"></div>
    <div style="margin-top:16px">
      <button class="btn btn-primary" onclick="document.getElementById('modal-pays-joues').classList.add('hidden')">Fermer</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ã‰TAT GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATE = {
  // Connexion
  ws: null,
  serveur: null,           // URL WebSocket du serveur
  roomId: null,
  joueurId: crypto.randomUUID(),
  nom: 'Joueur',
  estCreateur: false,
  modeConnecte: false,     // false = mode solo, true = connectÃ© au serveur
  joueurFautif: null,      // id du joueur qui a posÃ© la sÃ©quence courante

  // Partie
  etat: null,              // snapshot serveur
  tempsMax: 15,
  tempsRestant: 15,
  chronoInterval: null,
  estMonTour: false,
  nbTours: 0,

  // Config
  langue: 'fr',
  modeMixte: false,
};

// URL du serveur â€” modifier selon ton hÃ©bergement
// En local : ws://localhost:8000
// En prod  : wss://ton-app.onrender.com
const SERVEUR_HTTP = window.location.hostname === 'localhost'
  ? 'http://localhost:8000'
  : 'https://pays-game.onrender.com';   // â† Ã€ CHANGER EN PROD

const SERVEUR_WS = SERVEUR_HTTP.replace('http', 'ws');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODE SOLO (sans serveur) â€” donnÃ©es locales
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let PAYS_LOCAL = null;

async function chargerPaysLocal(langue) {
  try {
    const r = await fetch(`pays_${langue}.json`);
    PAYS_LOCAL = await r.json();
  } catch {
    // Fallback minimal
    PAYS_LOCAL = [
      { nom: 'FRANCE', capitale: 'PARIS', code: 'fr', nom_normalise: 'FRANCE', capitale_normalisee: 'PARIS' },
      { nom: 'ALLEMAGNE', capitale: 'BERLIN', code: 'de', nom_normalise: 'ALLEMAGNE', capitale_normalisee: 'BERLIN' },
      { nom: 'ESPAGNE', capitale: 'MADRID', code: 'es', nom_normalise: 'ESPAGNE', capitale_normalisee: 'MADRID' },
      { nom: 'ITALIE', capitale: 'ROME', code: 'it', nom_normalise: 'ITALIE', capitale_normalisee: 'ROME' },
      { nom: 'BELGIQUE', capitale: 'BRUXELLES', code: 'be', nom_normalise: 'BELGIQUE', capitale_normalisee: 'BRUXELLES' },
      { nom: 'PORTUGAL', capitale: 'LISBONNE', code: 'pt', nom_normalise: 'PORTUGAL', capitale_normalisee: 'LISBONNE' },
      { nom: 'PAYS-BAS', capitale: 'AMSTERDAM', code: 'nl', nom_normalise: 'PAYS-BAS', capitale_normalisee: 'AMSTERDAM' },
      { nom: 'SUISSE', capitale: 'BERNE', code: 'ch', nom_normalise: 'SUISSE', capitale_normalisee: 'BERNE' },
      { nom: 'CANADA', capitale: 'OTTAWA', code: 'ca', nom_normalise: 'CANADA', capitale_normalisee: 'OTTAWA' },
      { nom: 'CHINE', capitale: 'PÃ‰KIN', code: 'cn', nom_normalise: 'CHINE', capitale_normalisee: 'PEKIN' },
      { nom: 'JAPON', capitale: 'TOKYO', code: 'jp', nom_normalise: 'JAPON', capitale_normalisee: 'TOKYO' },
    ];
    toast('âš ï¸ Fichier pays non trouvÃ© â€” mode dÃ©mo avec pays limitÃ©s', 'warn');
  }
}

function normaliser(s) {
  return s.toUpperCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .replace(/[^A-Z]/g, ''); // BUG02 FIX â€” supprime espaces, tirets, apostrophes (alignÃ© sur main.py)
}

function chercherPossibilites(seq) {
  if (!PAYS_LOCAL || !seq) return PAYS_LOCAL || [];
  const s = normaliser(seq);
  return PAYS_LOCAL.filter(p =>
    p.nom_normalise.startsWith(s) ||
    (STATE.modeMixte && p.capitale_normalisee.startsWith(s))
  );
}

function estComplet(seq) {
  const s = normaliser(seq);
  return PAYS_LOCAL?.find(p =>
    p.nom_normalise === s ||
    (STATE.modeMixte && p.capitale_normalisee === s)
  ) || null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function afficherEcran(id) {
  ['screen-accueil','screen-lobby','screen-jeu','screen-fin'].forEach(s => {
    document.getElementById(s).classList.toggle('hidden', s !== id);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WIZARD ACCUEIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STEPS = ['step-choix','step-solo','step-multi','step-creer','step-rejoindre'];

function allerStep(id) {
  STEPS.forEach(s => document.getElementById(s)?.classList.add('hidden'));
  document.getElementById(id)?.classList.remove('hidden');
  setTimeout(() => {
    const input = document.getElementById(id)?.querySelector('input[type="text"]');
    if (input) input.focus();
  }, 50);
}

// â”€â”€ Solo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lancerSolo() {
  const nom    = document.getElementById('solo-nom').value.trim()  || 'Joueur';
  const langue = document.getElementById('solo-langue').value;
  STATE.nom       = nom;
  STATE.langue    = langue;
  STATE.modeMixte = document.getElementById('solo-mixte').checked;
  STATE.tempsMax  = parseInt(document.getElementById('solo-temps').value);
  // Solo lit ses propres vies
  const vies = parseInt(document.getElementById('solo-vies').value) || 10;
  SOLO.viesDepart = vies;

  if (!PAYS_LOCAL || PAYS_LOCAL._langue !== langue) {
    chargerPaysLocal(langue).then(() => lancerModeSolo(vies));
  } else {
    lancerModeSolo(vies);
  }
}

// â”€â”€ CrÃ©er â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function creerPartie() {
  const nom    = document.getElementById('creer-nom').value.trim() || 'Joueur';
  const langue = document.getElementById('creer-langue').value;
  STATE.nom       = nom;
  STATE.langue    = langue;
  STATE.modeMixte = document.getElementById('creer-mixte').checked;
  STATE.tempsMax  = parseInt(document.getElementById('creer-temps').value);
  STATE.estCreateur = true;

  const btn = document.getElementById('btn-creer');
  btn.disabled = true;
  btn.textContent = 'â³ Connexionâ€¦';

  if (!PAYS_LOCAL || PAYS_LOCAL._langue !== langue) await chargerPaysLocal(langue);

  const connecte = await tenterConnexionServeur(true, {
    langue,
    mode_mixte: STATE.modeMixte,
    vies:        parseInt(document.getElementById('creer-vies').value),
    temps:       STATE.tempsMax,
    max_joueurs: parseInt(document.getElementById('creer-max').value),
  });

  btn.disabled = false;
  btn.textContent = 'ğŸ—ºï¸ CrÃ©er la partie';

  if (!connecte) {
    toast('ğŸ”Œ Serveur non disponible', 'error');
  }
}

// â”€â”€ Rejoindre â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function rejoindreParCode(codeForce) {
  const code = (codeForce || document.getElementById('rejoindre-code')?.value || '').trim().toUpperCase();
  const nom  = (document.getElementById('rejoindre-nom')?.value || '').trim() || 'Joueur';
  if (!code || code.length !== 6) { toast('Code invalide (6 lettres)', 'error'); return; }

  STATE.nom         = nom;
  STATE.estCreateur = false;

  const btn = document.querySelector('#step-rejoindre .btn-primary');
  if (btn) { btn.disabled = true; btn.textContent = 'â³ Connexionâ€¦'; }

  // RÃ©cupÃ©rer la config du serveur â€” l'invitÃ© ne choisit pas vies/chrono
  try {
    const r = await fetch(`${SERVEUR_HTTP}/parties/${code}`, { signal: AbortSignal.timeout(5000) });
    if (!r.ok) { toast('Salle introuvable ou serveur en dÃ©marrage', 'error'); resetBtnRejoindre(); return; }
    const data = await r.json();
    const cfg = data.config || {};
    STATE.langue    = cfg.langue    || 'fr';
    STATE.modeMixte = cfg.mode_mixte || false;
    STATE.tempsMax  = cfg.temps      || 15;
  } catch {
    toast('Serveur non disponible', 'error'); resetBtnRejoindre(); return;
  }

  if (!PAYS_LOCAL || PAYS_LOCAL._langue !== STATE.langue) await chargerPaysLocal(STATE.langue);

  const connecte = await tenterConnexionServeur(false, null, code);
  if (!connecte) toast('Impossible de rejoindre', 'error');
  resetBtnRejoindre();
}

function resetBtnRejoindre() {
  const btn = document.querySelector('#step-rejoindre .btn-primary');
  if (btn) { btn.disabled = false; btn.textContent = 'Rejoindre â†’'; }
}

// â”€â”€ Parties publiques â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function rafraichirRooms() {
  const list = document.getElementById('rooms-list');
  list.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px;text-align:center">Rechercheâ€¦</div>';
  try {
    const r = await fetch(`${SERVEUR_HTTP}/parties`, { signal: AbortSignal.timeout(4000) });
    const rooms = await r.json();
    list.innerHTML = '';
    if (!rooms.length) {
      list.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px;text-align:center">Aucune partie disponible</div>';
      return;
    }
    rooms.forEach(room => {
      const div = document.createElement('div');
      div.className = 'room-item';
      div.innerHTML = `<span class="room-id">${room.room_id}</span><span class="room-info">${room.joueurs}/${room.max_joueurs} joueurs Â· ${room.langue === 'fr' ? 'ğŸ‡«ğŸ‡·' : 'ğŸ‡¬ğŸ‡§'}</span>`;
      div.onclick = () => {
        // PrÃ©-remplir le code et aller sur l'Ã©tape rejoindre
        allerStep('step-rejoindre');
        document.getElementById('rejoindre-code').value = room.room_id;
      };
      list.appendChild(div);
    });
  } catch {
    list.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px;text-align:center">Serveur non disponible</div>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONNEXION WEBSOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function tenterConnexionServeur(creer, config, roomId = null) {
  try {
    if (creer) {
      const r = await fetch(`${SERVEUR_HTTP}/parties`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config),
        signal: AbortSignal.timeout(4000),
      });
      const data = await r.json();
      STATE.roomId = data.room_id;
    } else {
      STATE.roomId = roomId;
    }

    const ws = new WebSocket(
      `${SERVEUR_WS}/ws/${STATE.roomId}/${STATE.joueurId}/${encodeURIComponent(STATE.nom)}`
    );

    return await new Promise((resolve) => {
      const timer = setTimeout(() => { ws.close(); resolve(false); }, 5000);

      ws.onopen = () => {
        clearTimeout(timer);
        STATE.ws = ws;
        STATE.modeConnecte = true; // â† CRITIQUE : active le mode multijoueur
        ws.onmessage = onMessage;
        ws.onclose   = onClose;
        ws.onerror   = () => {};
        afficherLobby();
        resolve(true);
      };
      ws.onerror = () => { clearTimeout(timer); resolve(false); };
    });
  } catch {
    return false;
  }
}

function envoyerWS(data) {
  if (STATE.ws && STATE.ws.readyState === WebSocket.OPEN) {
    STATE.ws.send(JSON.stringify(data));
  }
}

function onMessage(evt) {
  const msg = JSON.parse(evt.data);
  debugLog(`ğŸ“¨ ${msg.type} | actuel=${msg.joueur_actuel?.slice(0,8)} | seq="${msg.sequence}"`);
  traiterMessage(msg);
}

// â”€â”€ Panneau debug (appuyer D pour toggle) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let DEBUG_ON = false;
function debugLog(txt) {
  if (!DEBUG_ON) return;
  const el = document.getElementById('debug-panel');
  if (!el) return;
  const line = document.createElement('div');
  line.textContent = new Date().toLocaleTimeString('fr') + ' ' + txt;
  line.style.cssText = 'font-size:10px;border-bottom:1px solid #333;padding:2px 0;word-break:break-all';
  el.prepend(line);
  while (el.children.length > 20) el.lastChild.remove();
}
document.addEventListener('keydown', e => {
  if (e.key === 'd' && e.ctrlKey) {
    DEBUG_ON = !DEBUG_ON;
    const el = document.getElementById('debug-panel');
    if (el) el.style.display = DEBUG_ON ? 'block' : 'none';
    if (DEBUG_ON) {
      debugLog(`ğŸ‘¤ monId=${STATE.joueurId.slice(0,8)} | connectÃ©=${STATE.modeConnecte}`);
    }
  }
});

function onClose() {
  STATE.ws = null;
  STATE.modeConnecte = false;
  if (!['screen-accueil','screen-fin'].some(s => !document.getElementById(s).classList.contains('hidden'))) {
    toast('ğŸ”Œ DÃ©connectÃ© du serveur', 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRAITEMENT DES MESSAGES SERVEUR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function traiterMessage(msg) {
  debugLog(`âš™ï¸ traiter: ${msg.type} | monTour=${msg.joueur_actuel === STATE.joueurId} | connectÃ©=${STATE.modeConnecte}`);
  switch(msg.type) {
    case 'etat':
    case 'joueur_rejoint':
    case 'joueur_parti':
      mettreAJourEtat(msg);
      break;

    case 'partie_demarree':
      // Synchroniser la config depuis le snapshot serveur (crucial pour le joueur qui rejoint)
      if (msg.config) {
        STATE.langue    = msg.config.langue     || STATE.langue;
        STATE.modeMixte = msg.config.mode_mixte || false;
        STATE.tempsMax  = msg.config.temps       || STATE.tempsMax;
      }
      // Afficher l'Ã©cran JEU avant mettreAJourEtat pour que mettreAJourJeu soit appelÃ©
      afficherEcran('screen-jeu');
      construireClavier(); // indispensable pour le joueur qui rejoint
      mettreAJourEtat(msg);
      toast('ğŸ® La partie commence !');
      break;

    case 'nouveau_tour':
      stopChrono();
      STATE.joueurFautif = msg.joueur_fautif || null;
      // S'assurer que l'Ã©cran de jeu et le clavier sont prÃªts
      if (!document.getElementById('screen-jeu').classList.contains('hidden')) {
        if (!document.getElementById('keyboard').children.length) construireClavier();
      } else {
        afficherEcran('screen-jeu');
        construireClavier();
      }
      mettreAJourEtat(msg);
      STATE.nbTours++;
      lancerChrono(msg.config?.temps || STATE.tempsMax);
      break;

    case 'sequence_invalide':
      stopChrono(); // le serveur envoie nouveau_tour juste aprÃ¨s
      STATE.joueurFautif = msg.joueur_fautif || null;
      mettreAJourEtat(msg);
      document.getElementById('letters-seq').classList.add('invalid');
      setTimeout(() => document.getElementById('letters-seq').classList.remove('invalid'), 600);
      toast(`âš ï¸ ${msg.message}`, 'warn');
      break;

    case 'mot_complet':
      stopChrono(); // le serveur attend 1.5s puis envoie perte_vie
      document.querySelectorAll('.key').forEach(k => k.disabled = true);
      document.getElementById('btn-langue').disabled = true;
      mettreAJourEtat(msg);
      document.getElementById('letters-seq').classList.add('complete');
      ajouterDrapeau(msg.pays);
      toast(`ğŸ’€ ${msg.message}`, 'warn');
      break;

    case 'langue_au_chat':
      stopChrono(); // on attend la rÃ©ponse, pas de chrono
      document.querySelectorAll('.key').forEach(k => k.disabled = true);
      document.getElementById('btn-langue').disabled = true;
      mettreAJourEtat(msg);
      if (msg.interpelle === STATE.joueurId) {
        ouvrirModalLangueAuChat(msg.message);
      } else {
        toast(`ğŸ—£ï¸ ${msg.message}`, 'warn');
      }
      break;

    case 'verdict_langue_au_chat':
      stopChrono();
      document.querySelectorAll('.key').forEach(k => k.disabled = true);
      document.getElementById('btn-langue').disabled = true;
      afficherVerdict(msg);
      break;

    case 'perte_vie':
      stopChrono(); // nouveau_tour arrive juste aprÃ¨s
      mettreAJourEtat(msg);
      toast(msg.message, msg.elimine ? 'error' : 'warn');
      break;

    case 'fin_partie':
      mettreAJourEtat(msg);
      afficherFinDePartie(msg);
      break;

    case 'chat':
      ajouterMessageChat(msg);
      break;

    case 'ia_langue_au_chat':
      toast(msg.message, 'warn');
      break;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOBBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function afficherLobby() {
  afficherEcran('screen-lobby');
  document.getElementById('lobby-code').textContent = STATE.roomId;
  const lien = `${window.location.href.split('?')[0]}?room=${STATE.roomId}`;
  document.getElementById('lien-partage').textContent = lien;
  document.getElementById('btn-demarrer').style.display = STATE.estCreateur ? '' : 'none';
}

function mettreAJourEtat(msg) {
  STATE.etat = msg;

  // Mettre Ã  jour lobby
  if (!document.getElementById('screen-lobby').classList.contains('hidden')) {
    mettreAJourLobby(msg);
  }

  // Mettre Ã  jour jeu
  if (!document.getElementById('screen-jeu').classList.contains('hidden')) {
    mettreAJourJeu(msg);
  }
}

function mettreAJourLobby(msg) {
  const joueurs = msg.joueurs || [];
  const grid = document.getElementById('players-grid');
  grid.innerHTML = '';

  const avatars = ['ğŸ§‘','ğŸ‘©','ğŸ§”','ğŸ‘±','ğŸ§•','ğŸ‘¨â€ğŸ’»','ğŸ§™','ğŸ¦Š'];
  joueurs.forEach((j, i) => {
    const div = document.createElement('div');
    div.className = 'player-slot filled';
    div.innerHTML = `
      <div class="slot-avatar">${j.est_ia ? 'ğŸ¤–' : avatars[i % avatars.length]}</div>
      <div class="slot-name">${j.nom}</div>
      <div class="slot-tag">${j.est_ia ? 'BOT' : j.id === STATE.joueurId ? 'MOI' : 'EN LIGNE'}</div>
    `;
    grid.appendChild(div);
  });

  // Slots vides
  const max = msg.config?.max_joueurs || 4;
  for (let i = joueurs.length; i < Math.min(max, 4); i++) {
    const div = document.createElement('div');
    div.className = 'player-slot';
    div.innerHTML = `<div class="slot-avatar" style="opacity:.2">ğŸ‘¤</div><div class="slot-name" style="opacity:.2;font-size:11px">En attenteâ€¦</div>`;
    grid.appendChild(div);
  }
}

async function ajouterIA() {
  if (STATE.ws) {
    try {
      await fetch(`${SERVEUR_HTTP}/parties/${STATE.roomId}/ia`, { method: 'POST' });
    } catch { toast('Serveur indisponible', 'error'); }
  } else {
    // Mode solo â€” ajouter IA locale
    ajouterIALocale();
  }
}

async function demarrerPartie() {
  if (STATE.ws) {
    try {
      await fetch(`${SERVEUR_HTTP}/parties/${STATE.roomId}/demarrer?joueur_id=${STATE.joueurId}`, { method: 'POST' });
    } catch { toast('Erreur serveur', 'error'); }
  } else {
    demarrerSolo(); // INFO02 FIX â€” fallback explicite si pas connectÃ©
  }
}

function copierLien() {
  const lien = document.getElementById('lien-partage').textContent;
  navigator.clipboard.writeText(lien).then(() => toast('ğŸ”— Lien copiÃ© !'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MISE Ã€ JOUR DE L'INTERFACE DE JEU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mettreAJourJeu(msg) {
  const seq = msg.sequence || '';
  const monTour = msg.joueur_actuel === STATE.joueurId;
  debugLog(`ğŸ® mettreAJourJeu | monId=${STATE.joueurId.slice(0,8)} | actuel=${msg.joueur_actuel?.slice(0,8)} | monTour=${monTour} | connectÃ©=${STATE.modeConnecte}`);

  // SÃ©quence
  const el = document.getElementById('letters-seq');
  el.textContent = seq ? seq.split('').join(' Â· ') : 'â€¦';
  el.className = 'letters-sequence';

  // Indicateur de tour
  const monTour = msg.joueur_actuel === STATE.joueurId;
  STATE.estMonTour = monTour;
  document.getElementById('turn-indicator').textContent =
    monTour ? 'â¬‡ Ton tour !' :
    msg.joueurs?.find(j => j.id === msg.joueur_actuel)
      ? `Tour de ${msg.joueurs.find(j => j.id === msg.joueur_actuel).nom}`
      : '';

  // Activer/dÃ©sactiver clavier â€” gÃ©rÃ© par activerClavier() en mode solo
  // En mode connectÃ©, on l'applique ici directement
  if (STATE.modeConnecte) {
    // Lire joueur_fautif depuis le snapshot serveur (field ajoutÃ© dans serveur corrigÃ©)
    if ('joueur_fautif' in msg) STATE.joueurFautif = msg.joueur_fautif;
    document.querySelectorAll('.key').forEach(k => k.disabled = !monTour);
    const seqEnCours = (msg.sequence || '').length > 0;
    const jeSuisFautif = STATE.joueurFautif === STATE.joueurId;
    document.getElementById('btn-langue').disabled = !(monTour && seqEnCours && !jeSuisFautif);
  }

  // PossibilitÃ©s
  if (seq) {
    const poss = chercherPossibilites(seq);
    document.getElementById('poss-count').textContent =
      poss.length ? `${poss.length} pays possible${poss.length > 1 ? 's' : ''}` : '';
  } else {
    document.getElementById('poss-count').textContent = '';
  }

  // Scores
  mettreAJourScores(msg);
}

function mettreAJourScores(msg) {
  const bar = document.getElementById('scores-bar');
  bar.innerHTML = '';
  const joueurs = msg.joueurs || [];

  joueurs.forEach((j, i) => {
    const div = document.createElement('div');
    div.className = 'score-player' + (j.id === msg.joueur_actuel ? ' active' : '');

    const dots = Array.from({ length: msg.config?.vies || 10 }, (_, k) => {
      const perdu = k >= j.vies;
      return `<div class="life-dot${perdu ? ' lost' : ''}"></div>`;
    }).join('');

    div.innerHTML = `
      <div class="player-name">${j.est_ia ? 'ğŸ¤–' : ''}${j.nom}</div>
      <div class="lives-dots">${dots}</div>
    `;
    bar.appendChild(div);

    if (i < joueurs.length - 1) {
      const vs = document.createElement('div');
      vs.className = 'score-vs';
      vs.textContent = 'VS';
      bar.appendChild(vs);
    }
  });
}

function ajouterDrapeau(pays, valeurJouee = null) {
  // BUG03 FIX â€” en mode mixte, afficher la valeur jouÃ©e (nom ou capitale)
  const label = (valeurJouee && valeurJouee !== pays.nom)
    ? `${valeurJouee} (${pays.nom})`
    : pays.nom;
  const inner = document.getElementById('flags-inner');
  const div = document.createElement('div');
  div.className = 'flag-item';
  div.innerHTML = `
    <img src="https://flagcdn.com/w80/${pays.code}.png" alt="${pays.nom}"
         onerror="this.style.display='none'">
    <div class="flag-name">${label}</div>
  `;
  inner.appendChild(div);
  inner.parentElement.scrollLeft = inner.scrollWidth;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLAVIER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function construireClavier() {
  const kb = document.getElementById('keyboard');
  kb.innerHTML = '';
  'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(l => {
    const btn = document.createElement('button');
    btn.className = 'key';
    btn.textContent = l;
    btn.disabled = false; // activerClavier() gÃ¨re l'Ã©tat aprÃ¨s
    btn.onclick = () => appuyerTouche(l);
    kb.appendChild(btn);
  });
}

function appuyerTouche(lettre) {
  debugLog(`âŒ¨ï¸ appuyerTouche(${lettre}) | estMonTour=${STATE.estMonTour} | connectÃ©=${STATE.modeConnecte}`);
  if (!STATE.estMonTour) return;

  if (STATE.modeConnecte) {
    envoyerWS({ action: 'lettre', lettre });
  } else {
    traiterLettreLocal(lettre);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHRONO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function lancerChrono(secondes) {
  clearInterval(STATE.chronoInterval);
  STATE.tempsRestant = secondes;
  STATE.tempsMax = secondes;
  actualiserChrono();

  STATE.chronoInterval = setInterval(() => {
    STATE.tempsRestant--;
    actualiserChrono();
    if (STATE.tempsRestant <= 0) {
      clearInterval(STATE.chronoInterval);
      if (!STATE.modeConnecte && STATE.estMonTour) {
        // Mode solo â€” temps Ã©coulÃ©
        perdreVieLocal('â° Temps Ã©coulÃ© !');
      }
    }
  }, 1000);
}

function actualiserChrono() {
  const pct = (STATE.tempsRestant / STATE.tempsMax) * 100;
  const fill = document.getElementById('chrono-fill');
  fill.style.width = pct + '%';
  fill.classList.toggle('urgent', STATE.tempsRestant <= 5);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LANGUE AU CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function demanderLangueAuChat() {
  if (STATE.modeConnecte) {
    envoyerWS({ action: 'langue_au_chat' });
  } else {
    demanderLangueAuChatLocal();
  }
}

function ouvrirModalLangueAuChat(texte) {
  document.getElementById('modal-langue-text').textContent = texte || 'Quel pays avais-tu en tÃªte ?';
  document.getElementById('modal-langue-input').value = '';
  document.getElementById('modal-langue').classList.remove('hidden');
  setTimeout(() => document.getElementById('modal-langue-input').focus(), 100);
}

function validerLangueAuChat() {
  const pays = document.getElementById('modal-langue-input').value.trim();
  if (!pays) return;
  document.getElementById('modal-langue').classList.add('hidden');

  if (STATE.modeConnecte) {
    envoyerWS({ action: 'reponse_langue_au_chat', pays });
  } else {
    evaluerReponseLocal(pays);
  }
}

function afficherVerdict(msg) {
  document.getElementById('verdict-emoji').textContent = msg.valide ? 'âœ…' : 'âŒ';
  document.getElementById('verdict-title').textContent = msg.valide ? 'Bravo !' : 'Perdu !';
  document.getElementById('verdict-text').textContent = msg.message;
  document.getElementById('modal-verdict').classList.remove('hidden');
}

function fermerVerdict() {
  document.getElementById('modal-verdict').classList.add('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleChat() {
  document.getElementById('chat-panel').classList.toggle('open');
  document.getElementById('chat-notif').classList.remove('show');
}

function envoyerChat() {
  const input = document.getElementById('chat-input');
  const texte = input.value.trim();
  if (!texte) return;
  input.value = '';
  if (STATE.modeConnecte) {
    envoyerWS({ action: 'chat', texte });
  } else {
    ajouterMessageChat({ type: 'chat', nom: STATE.nom, texte, heure: new Date().toLocaleTimeString('fr',{hour:'2-digit',minute:'2-digit'}) });
  }
}

function ajouterMessageChat(msg) {
  const el = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = 'chat-msg' + (msg.joueur_id ? '' : ' system');
  div.innerHTML = msg.joueur_id
    ? `<div class="msg-author">${msg.nom} Â· ${msg.heure}</div><div class="msg-text">${escapeHtml(msg.texte)}</div>`
    : `<div class="msg-text">${msg.message || msg.texte}</div>`;
  el.appendChild(div);
  el.scrollTop = el.scrollHeight;

  if (document.getElementById('chat-panel').classList.contains('open') === false) {
    document.getElementById('chat-notif').classList.add('show');
  }
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODE SOLO (sans serveur) â€” IA locale
//  RÃ©Ã©criture complÃ¨te et fidÃ¨le Ã  main.py
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Ã‰tat solo â€” miroir des attributs self.* de PaysGameApp
let SOLO = {
  joueurs:      [],
  indexTour:    0,
  sequence:     '',
  paysJoues:    new Set(),
  paysJouesList:[],
  joueurFautif: null,
  viesDepart:   10,
};

// â”€â”€ _lancer_mode_solo() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lancerModeSolo(viesParam) {
  const vies = viesParam || parseInt(document.getElementById('solo-vies')?.value) || 10;
  STATE.modeConnecte = false;
  STATE.nbTours      = 0;
  // tempsMax et modeMixte dÃ©jÃ  dÃ©finis par lancerSolo() ou STATE
  if (!STATE.tempsMax) STATE.tempsMax = 15;

  SOLO.viesDepart    = vies;
  SOLO.joueurs       = [
    { id: STATE.joueurId, nom: STATE.nom || 'Joueur', vies, en_vie: true, est_ia: false },
    { id: 'ia', nom: 'ğŸ¤– Ordinateur', vies, en_vie: true, est_ia: true },
  ];
  SOLO.indexTour     = 0;
  SOLO.sequence      = '';
  SOLO.paysJoues     = new Set();
  SOLO.paysJouesList = [];
  SOLO.joueurFautif  = null;

  afficherEcran('screen-lobby');
  document.getElementById('lobby-code').textContent = 'SOLO';
  document.getElementById('lien-partage').textContent = 'Mode solo â€” pas de lien disponible';
  const btnDem = document.getElementById('btn-demarrer');
  btnDem.style.display = '';
  btnDem.onclick = demarrerSolo;
  mettreAJourLobbyLocal();
}

// â”€â”€ _ajouter_ia_locale() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ajouterIALocale() {
  if (SOLO.joueurs.length >= 4) return;
  SOLO.joueurs.push({
    id: `ia${SOLO.joueurs.length}`,
    nom: 'ğŸ¤– Bot',
    vies: SOLO.viesDepart,
    en_vie: true,
    est_ia: true,
  });
  mettreAJourLobbyLocal();
}

function mettreAJourLobbyLocal() {
  mettreAJourLobby({ joueurs: SOLO.joueurs, config: { max_joueurs: 4 } });
}

// â”€â”€ _demarrer_solo() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function demarrerSolo() {
  document.getElementById('flags-inner').innerHTML = '';
  afficherEcran('screen-jeu');
  construireClavier();
  nouveauTourSolo(true);
}

// â”€â”€ _joueur_actuel_solo() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function joueurActuelSolo() {
  return SOLO.joueurs[SOLO.indexTour];
}

// â”€â”€ _nouveau_tour_solo(reset_sequence) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nouveauTourSolo(reset) {
  if (reset === undefined) reset = true;
  if (reset) {
    SOLO.sequence     = '';
    SOLO.joueurFautif = null;
  }
  STATE.nbTours++;

  const j = joueurActuelSolo();
  STATE.estMonTour = (j.id === STATE.joueurId);

  mettreAJourJeu({
    sequence:      SOLO.sequence,
    joueur_actuel: j.id,
    joueurs:       SOLO.joueurs,
    config:        { vies: SOLO.viesDepart },
  });
  lancerChrono(STATE.tempsMax);

  if (j.est_ia) {
    activerClavier(false);
    setTimeout(iaJouerSolo, 1000 + Math.random() * 1200);
  } else {
    activerClavier(true);
  }
}

// â”€â”€ _activer_clavier(actif) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function activerClavier(actif) {
  document.querySelectorAll('.key').forEach(k => { k.disabled = !actif; });
  const languePossible = actif
    && SOLO.sequence.length > 0
    && SOLO.joueurFautif !== STATE.joueurId;
  document.getElementById('btn-langue').disabled = !languePossible;
}

// â”€â”€ _traiter_lettre_solo(lettre) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function traiterLettreLocal(lettre) {
  if (!STATE.estMonTour) return;

  const nouvelleSeq  = normaliser(SOLO.sequence) + normaliser(lettre);
  const possibilites = soloChercherPossibilites(nouvelleSeq);

  if (possibilites.length === 0) {
    flashSequence('invalid');
    SOLO.sequence     = nouvelleSeq;
    SOLO.joueurFautif = STATE.joueurId;
    mettreAJourJeu({
      sequence: nouvelleSeq, joueur_actuel: STATE.joueurId,
      joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart },
    });
    toast("âš ï¸ SÃ©quence invalide â€” l'IA peut demander une langue au chat", 'warn');
    passerAuSuivantSolo();
    return;
  }

  SOLO.sequence = nouvelleSeq;
  const match   = soloEstComplet(nouvelleSeq);

  if (match) {
    if (SOLO.paysJoues.has(match.nom_normalise)) {
      toast(`ğŸ” ${match.nom} dÃ©jÃ  jouÃ© ! Tu perds une vie.`, 'error');
      stopChrono();
      setTimeout(() => perdreVieSolo(STATE.joueurId, 'Pays dÃ©jÃ  jouÃ©'), 500);
      return;
    }
    const valeur = soloValeurJouee(match, nouvelleSeq);
    SOLO.paysJoues.add(match.nom_normalise);
    SOLO.paysJouesList.push({ ...match, _valeur_jouee: valeur });
    ajouterDrapeau(match, valeur);
    flashSequence('complete');
    toast(`ğŸ’€ Tu as complÃ©tÃ© Â« ${valeur} Â» â€” tu perds une vie !`, 'warn');
    stopChrono();
    setTimeout(() => perdreVieSolo(STATE.joueurId, 'Mot complet'), 1500);
  } else {
    mettreAJourJeu({
      sequence: nouvelleSeq, joueur_actuel: STATE.joueurId,
      joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart },
    });
    passerAuSuivantSolo();
  }
}

// â”€â”€ _ia_jouer_solo() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function iaJouerSolo() {
  // VÃ©rifier que c'est encore le tour de l'IA
  const j = joueurActuelSolo();
  if (!j || !j.est_ia) return;

  const seqNorm      = normaliser(SOLO.sequence);
  const possibilites = soloChercherPossibilites(seqNorm);

  if (possibilites.length === 0) {
    if (SOLO.joueurFautif === STATE.joueurId) {
      ouvrirModalLangueAuChat("L'IA te demande : quel pays visais-tu ?");
    } else {
      toast("ğŸ¤– L'IA donne sa langue au chat ! Elle perd une vie.", 'warn');
      stopChrono();
      perdreVieSolo('ia', 'IA piÃ©gÃ©e');
    }
    return;
  }

  const nonJoues = possibilites.filter(p => !SOLO.paysJoues.has(p.nom_normalise));

  if (nonJoues.length === 0) {
    toast("ğŸ¤– L'IA est piÃ©gÃ©e (tous les pays dÃ©jÃ  jouÃ©s) ! Elle perd une vie.", 'warn');
    stopChrono();
    perdreVieSolo('ia', 'Tous pays jouÃ©s');
    return;
  }

  const longues = nonJoues.filter(p => p[p._cible].length > seqNorm.length + 1);
  const cibles  = longues.length > 0 ? longues : nonJoues;
  const cible   = cibles[Math.floor(Math.random() * cibles.length)];

  const lettreSuivante = cible[cible._cible][seqNorm.length];
  const nouvelleSeq    = seqNorm + lettreSuivante;

  SOLO.sequence     = nouvelleSeq;
  SOLO.joueurFautif = 'ia';

  const match = soloEstComplet(nouvelleSeq);
  if (match) {
    if (SOLO.paysJoues.has(match.nom_normalise)) {
      toast(`ğŸ” L'IA a jouÃ© ${match.nom} dÃ©jÃ  jouÃ© ! Elle perd une vie.`, 'warn');
      stopChrono();
      setTimeout(() => perdreVieSolo('ia', 'Pays dÃ©jÃ  jouÃ©'), 500);
      return;
    }
    const valeur = soloValeurJouee(match, nouvelleSeq);
    SOLO.paysJoues.add(match.nom_normalise);
    SOLO.paysJouesList.push({ ...match, _valeur_jouee: valeur });
    ajouterDrapeau(match, valeur);
    mettreAJourJeu({
      sequence: nouvelleSeq, joueur_actuel: 'ia',
      joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart },
    });
    flashSequence('complete');
    toast(`ğŸ’€ L'IA a complÃ©tÃ© Â« ${valeur} Â» â€” elle perd une vie !`, 'warn');
    stopChrono();
    setTimeout(() => perdreVieSolo('ia', 'Mot complet'), 1500);
  } else {
    mettreAJourJeu({
      sequence: nouvelleSeq, joueur_actuel: 'ia',
      joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart },
    });
    passerAuSuivantSolo();
  }
}

// â”€â”€ _demander_langue_locale() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function demanderLangueAuChatLocal() {
  stopChrono();
  const seqNorm      = normaliser(SOLO.sequence);
  const possibilites = soloChercherPossibilites(seqNorm).filter(
    p => p[p._cible].startsWith(seqNorm) && !SOLO.paysJoues.has(p.nom_normalise)
  );
  setTimeout(() => {
    if (possibilites.length > 0) {
      const pays   = possibilites[Math.floor(Math.random() * possibilites.length)];
      const valeur = pays._cible === 'nom_normalise' ? pays.nom : pays.capitale;
      SOLO.paysJoues.add(pays.nom_normalise);
      SOLO.paysJouesList.push({ ...pays, _valeur_jouee: valeur });
      ajouterDrapeau(pays, valeur);
      afficherVerdict({ valide: true, message: `L'IA visait Â« ${valeur} Â» (${SOLO.sequence}â€¦). Valide ! Tu perds une vie.` });
      setTimeout(() => { fermerVerdict(); perdreVieSolo(STATE.joueurId, 'Langue au chat perdue'); }, 2000);
    } else {
      afficherVerdict({ valide: false, message: `L'IA ne peut pas justifier Â« ${SOLO.sequence} Â» ! Elle perd une vie.` });
      setTimeout(() => { fermerVerdict(); perdreVieSolo('ia', 'IA sans rÃ©ponse'); }, 2000);
    }
  }, 800);
}

// â”€â”€ _evaluer_reponse_locale(pays_propose) â”€â”€â”€â”€â”€â”€â”€â”€â”€
function evaluerReponseLocal(paysPropose) {
  const norm    = normaliser(paysPropose);
  const seqNorm = normaliser(SOLO.sequence);

  let match      = PAYS_LOCAL ? (PAYS_LOCAL.find(p => p.nom_normalise === norm) || null) : null;
  let champMatch = 'nom_normalise';
  let valeurAff  = paysPropose;

  if (!match && STATE.modeMixte && PAYS_LOCAL) {
    match = PAYS_LOCAL.find(p => p.capitale_normalisee === norm) || null;
    if (match) { champMatch = 'capitale_normalisee'; valeurAff = match.capitale || paysPropose; }
  }

  if (!match) {
    afficherVerdict({ valide: false, message: `Â« ${paysPropose} Â» n'existe pas ! Tu perds une vie.` });
    setTimeout(() => { fermerVerdict(); perdreVieSolo(STATE.joueurId, 'Pays inexistant'); }, 2000);
  } else if (SOLO.paysJoues.has(match.nom_normalise)) {
    afficherVerdict({ valide: false, message: `Â« ${valeurAff} Â» a dÃ©jÃ  Ã©tÃ© jouÃ© ! Tu perds une vie.` });
    setTimeout(() => { fermerVerdict(); perdreVieSolo(STATE.joueurId, 'Pays dÃ©jÃ  jouÃ©'); }, 2000);
  } else if (!match[champMatch].startsWith(seqNorm)) {
    afficherVerdict({ valide: false, message: `Â« ${valeurAff} Â» ne commence pas par Â« ${SOLO.sequence} Â» ! Tu perds une vie.` });
    setTimeout(() => { fermerVerdict(); perdreVieSolo(STATE.joueurId, 'Pays incohÃ©rent'); }, 2000);
  } else {
    SOLO.paysJoues.add(match.nom_normalise);
    SOLO.paysJouesList.push({ ...match, _valeur_jouee: valeurAff });
    ajouterDrapeau(match, valeurAff);
    afficherVerdict({ valide: true, message: `âœ… Â« ${valeurAff} Â» commence bien par Â« ${SOLO.sequence} Â» ! L'IA perd une vie.` });
    setTimeout(() => { fermerVerdict(); perdreVieSolo('ia', 'Langue au chat perdue'); }, 2000);
  }
}

// â”€â”€ _perdre_vie_solo(joueur_id, raison) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function perdreVieLocal(raison) { perdreVieSolo(STATE.joueurId, raison); }

function perdreVieSolo(joueurId, raison) {
  stopChrono();
  const j = SOLO.joueurs.find(x => x.id === joueurId);
  if (!j) return;

  j.vies--;
  if (j.vies <= 0) { j.vies = 0; j.en_vie = false; toast(`ğŸ’€ ${j.nom} est Ã©liminÃ© !`, 'error'); }

  mettreAJourScores({
    sequence: SOLO.sequence, joueur_actuel: null,
    joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart },
  });

  const vivants = SOLO.joueurs.filter(x => x.en_vie);
  if (vivants.length <= 1) {
    setTimeout(() => afficherFinDePartieLocal(vivants[0] || null), 800);
    return;
  }

  const idxJ = SOLO.joueurs.indexOf(j);
  if (j.en_vie) {
    SOLO.indexTour = idxJ;
  } else {
    const n = SOLO.joueurs.length;
    let idx = idxJ;
    for (let i = 0; i < n; i++) { idx = (idx + 1) % n; if (SOLO.joueurs[idx].en_vie) break; }
    SOLO.indexTour = idx;
  }
  setTimeout(() => nouveauTourSolo(true), 800);
}

// â”€â”€ _passer_suivant_solo() â€” NE reset PAS la sÃ©quence
function passerAuSuivantSolo() {
  const n = SOLO.joueurs.length;
  for (let i = 0; i < n; i++) {
    SOLO.indexTour = (SOLO.indexTour + 1) % n;
    if (SOLO.joueurs[SOLO.indexTour].en_vie) break;
  }
  setTimeout(() => nouveauTourSolo(false), 150);
}

// â”€â”€ Utilitaires â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function stopChrono() {
  clearInterval(STATE.chronoInterval);
  STATE.chronoInterval = null;
}

function flashSequence(type) {
  const el = document.getElementById('letters-seq');
  el.classList.add(type);
  setTimeout(() => el.classList.remove(type), 600);
}

function soloValeurJouee(match, seqNorm) {
  if (STATE.modeMixte && seqNorm === match.capitale_normalisee) return match.capitale;
  return match.nom;
}

function soloChercherPossibilites(seq) {
  if (!PAYS_LOCAL || !PAYS_LOCAL.length) return [];
  const s = normaliser(seq);
  if (!s) return PAYS_LOCAL.map(p => ({ ...p, _cible: 'nom_normalise' }));
  const res = [];
  for (const p of PAYS_LOCAL) {
    if (p.nom_normalise.startsWith(s)) {
      res.push({ ...p, _cible: 'nom_normalise' });
    } else if (STATE.modeMixte && p.capitale_normalisee && p.capitale_normalisee.startsWith(s)) {
      res.push({ ...p, _cible: 'capitale_normalisee' });
    }
  }
  return res;
}

function soloEstComplet(seq) {
  const s = normaliser(seq);
  if (!PAYS_LOCAL) return null;
  for (const p of PAYS_LOCAL) {
    if (p.nom_normalise === s) return p;
    if (STATE.modeMixte && p.capitale_normalisee === s) return p;
  }
  return null;
}

// estComplet et chercherPossibilites â€” alias pour compatibilitÃ© mode connectÃ©
function estComplet(seq) { return soloEstComplet(seq); }
function chercherPossibilites(seq) { return soloChercherPossibilites(seq); }


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIN DE PARTIE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function afficherFinDePartie(msg) {
  clearInterval(STATE.chronoInterval);
  const gagnant = msg.joueurs?.find(j => j.id === msg.gagnant);
  document.getElementById('winner-name').textContent = gagnant ? gagnant.nom : 'â€”';
  document.getElementById('stat-pays').textContent = msg.pays_joues?.length || 0;
  document.getElementById('stat-tours').textContent = STATE.nbTours;
  document.getElementById('stat-vies').textContent = gagnant?.vies || 0;
  setTimeout(() => afficherEcran('screen-fin'), 600);
}

function afficherFinDePartieLocal(gagnant) {
  document.getElementById('winner-name').textContent = gagnant ? gagnant.nom : 'â€”';
  document.getElementById('stat-pays').textContent = SOLO.paysJouesList.length;
  document.getElementById('stat-tours').textContent = STATE.nbTours;
  document.getElementById('stat-vies').textContent = gagnant?.vies || 0;
  afficherEcran('screen-fin');
}

function retourAccueil() {
  stopChrono();
  EN_PAUSE = false;
  if (STATE.ws) { STATE.ws.close(); STATE.ws = null; }
  document.getElementById('flags-inner').innerHTML = '';
  document.getElementById('modal-pause').classList.add('hidden');
  document.getElementById('modal-quitter').classList.add('hidden');
  afficherEcran('screen-accueil');
}

function rejouerMeme() {
  stopChrono();
  if (STATE.modeConnecte) {
    retourAccueil();
  } else {
    // RÃ©initialiser SOLO sans passer par le lobby
    const vies = SOLO.viesDepart;
    SOLO.joueurs = SOLO.joueurs.map(j => ({ ...j, vies, en_vie: true }));
    SOLO.indexTour    = 0;
    SOLO.sequence     = '';
    SOLO.paysJoues    = new Set();
    SOLO.paysJouesList= [];
    SOLO.joueurFautif = null;
    STATE.nbTours     = 0;
    demarrerSolo();  // repart directement en jeu
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUG05 FIX â€” PAUSE & QUITTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let EN_PAUSE = false;

function basculerPause() {
  EN_PAUSE = !EN_PAUSE;
  const btn = document.getElementById('btn-pause');
  if (EN_PAUSE) {
    clearInterval(STATE.chronoInterval);
    document.querySelectorAll('.key').forEach(k => k.disabled = true);
    document.getElementById('btn-langue').disabled = true;
    btn.textContent = 'â–¶ Reprendre';
    btn.style.background = 'rgba(0,201,167,0.12)';
    btn.style.color = 'var(--teal)';
    btn.style.borderColor = 'rgba(0,201,167,0.3)';
    // Modal pause
    document.getElementById('modal-pause').classList.remove('hidden');
  } else {
    reprendreDepuisPause();
  }
}

function reprendreDepuisPause() {
  EN_PAUSE = false;
  document.getElementById('modal-pause').classList.add('hidden');
  const btn = document.getElementById('btn-pause');
  btn.textContent = 'â¸ Pause';
  btn.style.background = 'rgba(255,255,255,0.06)';
  btn.style.color = 'var(--paper)';
  btn.style.borderColor = 'rgba(255,255,255,0.1)';
  // Relancer chrono si temps restant
  if (STATE.tempsRestant > 0) {
    STATE.chronoInterval = setInterval(() => {
      STATE.tempsRestant--;
      actualiserChrono();
      if (STATE.tempsRestant <= 0) {
        clearInterval(STATE.chronoInterval);
        if (!STATE.modeConnecte && STATE.estMonTour) perdreVieLocal('â° Temps Ã©coulÃ© !');
      }
    }, 1000);
  }
  // RÃ©activer clavier selon le tour
  document.querySelectorAll('.key').forEach(k => k.disabled = !STATE.estMonTour);
}

function confirmerQuitter() {
  // Mettre en pause le chrono pendant la popup
  clearInterval(STATE.chronoInterval);
  document.getElementById('modal-quitter').classList.remove('hidden');
}

function annulerQuitter() {
  document.getElementById('modal-quitter').classList.add('hidden');
  // Reprendre le chrono si pas en pause
  if (!EN_PAUSE && STATE.tempsRestant > 0) {
    STATE.chronoInterval = setInterval(() => {
      STATE.tempsRestant--;
      actualiserChrono();
      if (STATE.tempsRestant <= 0) {
        clearInterval(STATE.chronoInterval);
        if (!STATE.modeConnecte && STATE.estMonTour) perdreVieLocal('â° Temps Ã©coulÃ© !');
      }
    }, 1000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUG04 FIX â€” VOIR LES PAYS JOUÃ‰S
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function afficherPaysJoues() {
  const liste = SOLO.paysJouesList;
  const modal = document.getElementById('modal-pays-joues');
  const content = document.getElementById('pays-joues-list');
  content.innerHTML = '';

  document.getElementById('pays-joues-count').textContent =
    `ğŸ—ºï¸ ${liste.length} mot${liste.length > 1 ? 's' : ''} jouÃ©${liste.length > 1 ? 's' : ''}`;

  if (!liste.length) {
    content.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px;font-size:13px">Aucun pays jouÃ©</div>';
  } else {
    liste.forEach(item => {
      const valeur = item._valeur_jouee || item.nom || '';
      const code = item.code || 'fr';
      const div = document.createElement('div');
      div.style.cssText = 'display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05)';

      const affichage = (STATE.modeMixte && item._valeur_jouee && item._valeur_jouee !== item.nom)
        ? `${item._valeur_jouee} <span style="color:var(--muted);font-size:11px">(${item.nom})</span>`
        : valeur;

      div.innerHTML = `
        <img src="https://flagcdn.com/w80/${code}.png"
             style="width:48px;height:32px;object-fit:cover;border-radius:4px;border:1px solid rgba(255,255,255,0.1);flex-shrink:0"
             onerror="this.style.display='none'">
        <span style="font-size:14px">${affichage}</span>
      `;
      content.appendChild(div);
    });
  }

  modal.classList.remove('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOASTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type = '') {
  const container = document.getElementById('toast-container');
  const div = document.createElement('div');
  div.className = 'toast' + (type ? ` ${type}` : '');
  div.textContent = msg;
  container.appendChild(div);
  setTimeout(() => {
    div.classList.add('exit');
    setTimeout(() => div.remove(), 300);
  }, 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  construireClavier();
  STATE.modeConnecte = false;

  // Afficher le premier step
  allerStep('step-choix');

  // PrÃ©charger les pays en arriÃ¨re-plan dÃ¨s le dÃ©marrage
  // (Ã©vite le bug "sÃ©quences non reconnues" au premier lancement)
  chargerPaysLocal('fr');

  // Rejoindre via lien partagÃ© (?room=ABCDEF)
  const params = new URLSearchParams(window.location.search);
  const roomFromUrl = params.get('room');
  if (roomFromUrl && roomFromUrl.length === 6) {
    allerStep('step-rejoindre');
    document.getElementById('rejoindre-code').value = roomFromUrl.toUpperCase();
    toast(`ğŸ”— Code dÃ©tectÃ© : ${roomFromUrl.toUpperCase()} â€” entrez votre nom et rejoignez !`, '');
  }
}

init();
</script>
</body>
</html>