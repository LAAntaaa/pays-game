<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LE PAYS FATAL ğŸŒ</title>
<link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Nunito:wght@400;600;700;800;900&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LE PAYS FATAL â€” "Jeu de sociÃ©tÃ© premium"
   Fond bleu marine + carte + avatars + passeport + mÃ¨che
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:        #0d1b35;
  --bg2:       #091428;
  --panel:     #162040;
  --panel2:    #1c2a50;
  --card-bg:   #12203f;

  --orange:    #f07828;
  --orange2:   #e05c10;
  --gold:      #f5c840;
  --gold2:     #c89820;
  --crimson:   #e03040;
  --green:     #3aaa6a;
  --blue-btn:  #3680e8;
  --sky:       #5ab8f8;
  --teal:      #3aaa6a;
  --amber:     #f5c840;
  --paper:     #d4e4fa;
  --muted:     rgba(160,185,230,0.55);

  --border:    rgba(80,120,200,0.22);
  --border-hi: rgba(240,120,40,0.65);

  --r-sm:8px; --r-md:14px; --r-lg:20px; --r-xl:26px;
}

*,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }
html,body {
  height:100%; min-height:100dvh;
  background:var(--bg);
  color:var(--paper);
  font-family:'Nunito',sans-serif;
  font-size:15px;
  overflow-x:hidden;
  -webkit-tap-highlight-color:transparent;
}

/* â”€â”€ Fond : bleu profond + dÃ©gradÃ©s â”€â”€ */
body::before {
  content:''; position:fixed; inset:0;
  background:
    radial-gradient(ellipse 130% 80% at 50% -10%, rgba(25,75,180,0.55) 0%, transparent 55%),
    radial-gradient(ellipse 70% 70% at 5%  95%,  rgba(8,35,110,0.65)  0%, transparent 50%),
    radial-gradient(ellipse 70% 70% at 95% 85%,  rgba(15,45,130,0.45) 0%, transparent 50%);
  pointer-events:none; z-index:0;
}
/* â”€â”€ Grille coordonnÃ©es de carte du monde â”€â”€ */
body::after {
  content:''; position:fixed; inset:0;
  background-image:
    radial-gradient(circle, rgba(80,130,220,0.18) 1.5px, transparent 1.5px),
    linear-gradient(rgba(55,95,195,0.06) 1px, transparent 1px),
    linear-gradient(90deg, rgba(55,95,195,0.06) 1px, transparent 1px);
  background-size: 30px 30px, 60px 60px, 60px 60px;
  pointer-events:none; z-index:0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• UTILITAIRES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hidden { display:none !important; }
button { cursor:pointer; border:none; font-family:'Nunito',sans-serif; transition:all .14s; }
input, select {
  font-family:'Nunito',sans-serif; font-weight:700;
  background:rgba(8,16,45,0.7);
  border:2px solid var(--border);
  color:var(--paper); border-radius:var(--r-sm);
  padding:11px 14px; outline:none; font-size:15px; width:100%;
  transition:border-color .18s, box-shadow .18s;
}
input:focus, select:focus {
  border-color:var(--orange);
  box-shadow:0 0 0 3px rgba(240,120,40,0.18);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREENS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen {
  position:fixed; inset:0;
  display:flex; flex-direction:column; align-items:center;
  overflow-y:auto; overflow-x:hidden;
  z-index:1; padding-bottom:24px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.logo-wrap { text-align:center; padding:22px 20px 10px; }
.logo-globe {
  font-size:52px; display:block;
  animation:globe-float 4s ease-in-out infinite;
  filter:drop-shadow(0 0 18px rgba(58,170,106,0.55));
}
@keyframes globe-float {
  0%,100% { transform:translateY(0) rotate(-3deg); }
  50%      { transform:translateY(-8px) rotate(3deg); }
}
.logo-eyebrow { font-size:10px; letter-spacing:3px; color:var(--muted); font-weight:800; text-transform:uppercase; margin-bottom:4px; }
.logo-title {
  font-family:'Lilita One',cursive;
  font-size:clamp(40px,10vw,58px);
  line-height:1;
  background:linear-gradient(145deg, var(--gold) 0%, var(--orange) 45%, #ff5c30 100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  filter:drop-shadow(0 3px 10px rgba(240,120,40,0.38));
  letter-spacing:2px;
  margin-top:2px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card {
  background:linear-gradient(150deg, rgba(18,28,60,0.97) 0%, rgba(10,18,45,0.97) 100%);
  border:1.5px solid rgba(80,120,200,0.28);
  border-radius:var(--r-xl);
  padding:22px 20px;
  width:calc(100% - 32px); max-width:400px;
  display:flex; flex-direction:column; gap:14px;
  box-shadow:0 10px 40px rgba(0,0,20,0.55), inset 0 1px 0 rgba(255,255,255,0.04);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BOUTONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  width:100%; padding:13px 18px;
  border-radius:var(--r-md); font-size:15px; font-weight:800;
  letter-spacing:0.4px; position:relative; overflow:hidden;
}
.btn::after { content:''; position:absolute; inset:0; background:linear-gradient(rgba(255,255,255,0.06),transparent); pointer-events:none; }
.btn-primary {
  background:linear-gradient(155deg, var(--orange) 0%, var(--orange2) 100%);
  color:#fff;
  box-shadow:0 4px 0 #8a3206, 0 6px 22px rgba(240,120,40,0.32);
}
.btn-primary:hover  { transform:translateY(-2px); box-shadow:0 6px 0 #8a3206, 0 10px 28px rgba(240,120,40,0.42); }
.btn-primary:active { transform:translateY(2px);  box-shadow:0 1px 0 #8a3206; }
.btn-secondary {
  background:linear-gradient(155deg, rgba(32,50,110,0.92) 0%, rgba(20,36,85,0.92) 100%);
  color:var(--paper); border:1.5px solid rgba(70,110,210,0.35);
  box-shadow:0 3px 0 rgba(8,16,50,0.8);
}
.btn-secondary:hover  { transform:translateY(-2px); border-color:rgba(90,140,230,0.6); }
.btn-secondary:active { transform:translateY(2px); }
.btn-ghost { background:none; color:var(--muted); font-size:13px; padding:8px; }
.btn-ghost:hover { color:var(--paper); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FORMULAIRES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.form-group { display:flex; flex-direction:column; gap:6px; }
.form-group label { font-size:10px; font-weight:800; letter-spacing:2.2px; color:var(--muted); text-transform:uppercase; }
.row-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.separator { text-align:center; color:var(--muted); font-size:11px; font-weight:700; letter-spacing:2px; position:relative; }
.separator::before, .separator::after { content:''; position:absolute; top:50%; width:44%; height:1px; background:var(--border); }
.separator::before { left:0; } .separator::after { right:0; }
.toggle-wrap { display:flex; align-items:center; gap:12px; }
.toggle { position:relative; display:inline-block; width:46px; height:25px; flex-shrink:0; }
.toggle input { opacity:0; width:0; height:0; }
.toggle-slider {
  position:absolute; inset:0; border-radius:25px;
  background:rgba(30,48,95,0.85); border:1.5px solid rgba(70,110,200,0.3);
  transition:.28s; cursor:pointer;
}
.toggle-slider::before {
  content:''; position:absolute; height:17px; width:17px; left:3px; bottom:3px;
  background:#fff; border-radius:50%; transition:.28s; box-shadow:0 2px 4px rgba(0,0,0,0.3);
}
.toggle input:checked + .toggle-slider { background:var(--orange); border-color:var(--orange2); }
.toggle input:checked + .toggle-slider::before { transform:translateX(21px); }
.step-header { display:flex; align-items:center; gap:10px; font-family:'Bebas Neue',cursive; font-size:20px; letter-spacing:2px; }
.btn-retour { background:none; color:var(--muted); font-size:13px; padding:4px 8px; border-radius:6px; }
.btn-retour:hover { color:var(--paper); background:rgba(255,255,255,0.06); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AVATAR GRID â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.avatar-section {
  background:rgba(8,15,40,0.5); border:1.5px solid rgba(70,110,200,0.22);
  border-radius:var(--r-md); padding:13px;
}
.avatar-label { font-size:10px; font-weight:800; letter-spacing:2.5px; color:var(--muted); text-transform:uppercase; margin-bottom:10px; text-align:center; }
.avatar-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:7px; }
.av-btn {
  aspect-ratio:1; border-radius:10px;
  background:rgba(22,38,85,0.85); border:2px solid transparent;
  font-size:22px; display:flex; align-items:center; justify-content:center;
  transition:all .13s; position:relative;
}
.av-btn:hover { background:rgba(44,70,140,0.9); transform:scale(1.1); }
.av-btn.selected { border-color:var(--orange); background:rgba(240,120,40,0.18); box-shadow:0 0 14px rgba(240,120,40,0.38); }
.av-btn.selected::after {
  content:'âœ“'; position:absolute; top:-5px; right:-5px;
  width:16px; height:16px; background:var(--orange); color:#fff;
  border-radius:50%; font-size:9px; font-weight:900; display:flex; align-items:center; justify-content:center;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SLIDER CHRONO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.slider-wrap { display:flex; flex-direction:column; gap:7px; }
.slider-header { display:flex; justify-content:space-between; align-items:center; }
.slider-label { font-size:10px; font-weight:800; letter-spacing:2px; color:var(--muted); text-transform:uppercase; }
.slider-val { font-family:'Bebas Neue',cursive; font-size:22px; color:var(--orange); }
.game-slider {
  -webkit-appearance:none; appearance:none;
  width:100%; height:7px; border-radius:4px;
  background:linear-gradient(90deg, var(--orange) var(--fill,33%), rgba(30,48,95,0.85) var(--fill,33%));
  border:none; padding:0; cursor:pointer;
}
.game-slider::-webkit-slider-thumb {
  -webkit-appearance:none; width:22px; height:22px; border-radius:50%;
  background:radial-gradient(circle at 35% 35%, #fff8 0%, var(--orange) 65%);
  box-shadow:0 2px 8px rgba(240,120,40,0.55), 0 0 0 3px rgba(240,120,40,0.18);
  cursor:pointer;
}
.game-slider::-moz-range-thumb { width:22px; height:22px; border-radius:50%; border:none; background:var(--orange); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COMPTEUR JOUEURS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.counter-label { font-size:10px; font-weight:800; letter-spacing:2px; color:var(--muted); text-transform:uppercase; margin-bottom:6px; }
.joueurs-counter { display:flex; align-items:center; background:rgba(8,15,40,0.55); border:1.5px solid rgba(70,110,200,0.22); border-radius:var(--r-md); overflow:hidden; }
.ctr-btn { width:46px; height:44px; background:rgba(22,38,85,0.85); color:var(--paper); font-size:22px; font-weight:700; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.ctr-btn:hover { background:rgba(50,80,155,0.9); }
.ctr-val { flex:1; text-align:center; font-family:'Bebas Neue',cursive; font-size:24px; color:var(--orange); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ROOMS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rooms-list { display:flex; flex-direction:column; gap:6px; max-height:140px; overflow-y:auto; }
.room-item { display:flex; justify-content:space-between; align-items:center; background:rgba(22,38,85,0.6); border:1.5px solid rgba(70,110,200,0.18); border-radius:var(--r-sm); padding:10px 14px; cursor:pointer; transition:background .13s; }
.room-item:hover { background:rgba(44,70,140,0.7); border-color:rgba(90,140,230,0.45); }
.room-id { font-family:'Bebas Neue',cursive; font-size:18px; color:var(--gold); letter-spacing:3px; }
.room-info { font-size:12px; color:var(--muted); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOBBY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.lobby-header { display:flex; align-items:center; justify-content:space-between; width:100%; max-width:500px; padding:14px 18px 8px; }
.lobby-title { font-family:'Bebas Neue',cursive; font-size:28px; letter-spacing:3px; color:var(--gold); }
.room-badge { background:rgba(245,200,64,0.1); border:2px solid rgba(245,200,64,0.38); border-radius:8px; padding:6px 12px; font-family:'Bebas Neue',cursive; font-size:20px; color:var(--gold); letter-spacing:4px; }
.link-share { display:flex; align-items:center; gap:10px; background:rgba(22,38,85,0.6); border:1.5px solid rgba(70,110,200,0.22); border-radius:var(--r-sm); padding:10px 14px; width:calc(100% - 36px); max-width:464px; cursor:pointer; transition:background .13s; }
.link-share:hover { background:rgba(44,70,140,0.7); }
.link-text { flex:1; font-size:11px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.players-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(96px,1fr)); gap:9px; width:calc(100% - 36px); max-width:464px; }
.player-slot { background:rgba(16,28,65,0.7); border:2px dashed rgba(70,110,200,0.18); border-radius:var(--r-md); padding:12px 8px; text-align:center; min-height:88px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:5px; transition:all .18s; }
.player-slot.filled { background:linear-gradient(145deg,rgba(24,40,88,0.95) 0%,rgba(14,26,65,0.95) 100%); border-style:solid; border-color:rgba(80,120,200,0.38); box-shadow:0 4px 16px rgba(0,0,20,0.3); }
.slot-avatar { font-size:26px; }
.slot-name { font-size:12px; font-weight:800; color:var(--paper); }
.slot-tag { font-size:9px; letter-spacing:1.8px; color:var(--muted); text-transform:uppercase; font-weight:700; }
.lobby-actions { width:calc(100% - 36px); max-width:464px; padding:10px 0; display:flex; flex-direction:column; gap:10px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Ã‰CRAN JEU â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-jeu { padding:0; overflow:hidden; height:100dvh; }

/* Topbar actions */
.jeu-topbar {
  display:flex; justify-content:space-between; align-items:center;
  padding:5px 10px;
  background:linear-gradient(180deg,rgba(8,14,40,0.98) 0%,rgba(10,18,48,0.95) 100%);
  border-bottom:1px solid rgba(60,90,180,0.14);
  flex-shrink:0; gap:6px;
}
.jtb-btn { background:rgba(16,28,70,0.9); border:1px solid rgba(70,110,200,0.22); color:var(--paper); border-radius:8px; padding:5px 10px; font-size:11px; font-weight:700; flex-shrink:0; }
.jtb-btn:hover { background:rgba(36,58,130,0.9); }
.jtb-quit { border-color:rgba(200,40,40,0.22); color:#ff8888; }
.jtb-quit:hover { background:rgba(180,30,30,0.15); }

/* Mode badge */
.mode-strip { text-align:center; padding:3px 0; font-family:'Bebas Neue',cursive; font-size:11px; letter-spacing:3px; background:rgba(240,120,40,0.09); color:var(--orange); border-bottom:1px solid rgba(240,120,40,0.12); flex-shrink:0; }

/* â”€â”€ Header VS â”€â”€ */
.vs-header {
  display:grid; grid-template-columns:1fr auto 1fr;
  align-items:stretch;
  background:linear-gradient(180deg,rgba(10,18,48,0.99) 0%,rgba(14,24,58,0.97) 100%);
  border-bottom:2px solid rgba(100,60,15,0.45);
  flex-shrink:0;
  padding:8px 10px;
  gap:8px;
}
.vsp { display:flex; align-items:center; gap:8px; min-width:0; }
.vsp.right { flex-direction:row-reverse; }
.vsp-av {
  width:44px; height:44px; border-radius:12px;
  background:rgba(22,38,85,0.8); border:2px solid rgba(255,255,255,0.08);
  display:flex; align-items:center; justify-content:center;
  font-size:22px; flex-shrink:0; transition:all .2s;
}
.vsp-av.active {
  border-color:var(--orange);
  box-shadow:0 0 0 3px rgba(240,120,40,0.3), 0 0 18px rgba(240,120,40,0.4);
  animation:av-pulse 1s ease-in-out infinite alternate;
}
@keyframes av-pulse { from{box-shadow:0 0 0 2px rgba(240,120,40,0.25),0 0 10px rgba(240,120,40,0.3)} to{box-shadow:0 0 0 4px rgba(240,120,40,0.4),0 0 22px rgba(240,120,40,0.55)} }
.vsp-info { display:flex; flex-direction:column; gap:3px; min-width:0; }
.vsp.right .vsp-info { align-items:flex-end; }
.vsp-name { font-size:12px; font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:90px; }
.vsp-hearts { display:flex; gap:2px; flex-wrap:wrap; max-width:90px; }
.vsp.right .vsp-hearts { justify-content:flex-end; }
.hrt { font-size:13px; line-height:1; transition:transform .15s; }
.hrt.lost { opacity:0.18; filter:grayscale(1); }
.hrt.pop { animation:hrt-pop .3s ease; }
@keyframes hrt-pop { 0%{transform:scale(1)} 40%{transform:scale(1.45)} 100%{transform:scale(1)} }

/* Centre VS + chrono */
.vs-mid { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; flex-shrink:0; }
.vs-badge { background:linear-gradient(145deg,rgba(25,45,100,0.9),rgba(15,28,72,0.9)); border:2px solid rgba(75,115,220,0.38); border-radius:50%; width:38px; height:38px; display:flex; align-items:center; justify-content:center; font-family:'Bebas Neue',cursive; font-size:13px; letter-spacing:1px; color:var(--sky); }
.vs-chrono-val { font-family:'Bebas Neue',cursive; font-size:30px; color:var(--orange); line-height:1; }
.vs-chrono-val.urgent { color:var(--crimson); animation:chrono-blink .4s step-end infinite; }
@keyframes chrono-blink { 50%{opacity:0.25} }
.vs-sec { font-size:8px; letter-spacing:1.5px; color:var(--muted); font-weight:800; }

/* Extra joueurs (3+) */
.extra-strip { display:flex; gap:6px; flex-wrap:wrap; justify-content:center; padding:4px 10px; background:rgba(8,14,40,0.75); border-bottom:1px solid rgba(60,90,180,0.1); flex-shrink:0; }
.extra-chip { display:flex; align-items:center; gap:5px; background:rgba(18,32,78,0.85); border:1.5px solid rgba(70,110,200,0.22); border-radius:20px; padding:3px 10px; font-size:12px; }
.extra-chip.active { border-color:var(--orange); }

/* â”€â”€ Barre chrono Ã  mÃ¨che â”€â”€ */
.fuse-wrap { height:9px; background:rgba(14,22,58,0.9); position:relative; overflow:visible; flex-shrink:0; border-bottom:1px solid rgba(60,90,180,0.08); }
.fuse-bar {
  height:100%;
  background:linear-gradient(90deg, #dc2030 0%, #f07828 55%, #f5c840 100%);
  transition:width .95s linear;
  position:relative;
}
.fuse-bar::after {
  content:'âœ¨'; position:absolute; right:-12px; top:50%; transform:translateY(-50%);
  font-size:15px; animation:spark .35s ease infinite alternate; pointer-events:none;
}
@keyframes spark { from{transform:translateY(-50%) scale(.75) rotate(-10deg)} to{transform:translateY(-50%) scale(1.25) rotate(15deg)} }
.fuse-bar.urgent { background:var(--crimson); animation:fuse-pulse .28s ease infinite alternate; }
@keyframes fuse-pulse { from{opacity:.65} to{opacity:1} }

/* â”€â”€ Zone principale â”€â”€ */
.game-main {
  flex:1; display:flex; flex-direction:column; align-items:center;
  padding:10px 14px 6px; gap:8px; overflow:hidden; min-height:0;
}

/* BanniÃ¨re danger */
.danger-banner {
  display:flex; align-items:center; gap:8px;
  background:rgba(220,32,50,0.1); border:1.5px solid rgba(220,32,50,0.28);
  border-radius:var(--r-sm); padding:6px 14px;
  font-size:13px; font-weight:700; color:#ff8585;
  width:100%; max-width:380px; flex-shrink:0;
}

/* Lettres */
.letters-display { text-align:center; flex-shrink:0; }
.letters-sequence {
  font-family:'Lilita One',cursive;
  font-size:clamp(38px,10vw,60px);
  color:var(--paper);
  letter-spacing:5px; line-height:1.08;
  text-shadow:0 2px 24px rgba(80,130,220,0.35);
  transition:color .18s;
}
.letters-sequence.invalid { color:var(--crimson); animation:shake .32s ease; }
@keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-7px)} 40%{transform:translateX(7px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
.letters-sequence.complete { color:var(--crimson); }
.turn-indicator { font-size:13px; color:var(--muted); font-weight:700; margin-top:3px; }
.turn-indicator.actif { color:var(--gold); }
.possibilities-count { font-size:11px; color:rgba(58,170,106,0.65); margin-top:2px; }

/* â”€â”€ PASSEPORT â”€â”€ */
.passeport-wrap {
  width:100%; flex-shrink:0;
  background:linear-gradient(145deg,rgba(200,160,60,0.07),rgba(160,110,30,0.04));
  border:1.5px solid rgba(200,152,32,0.22);
  border-radius:var(--r-md); padding:8px 0 10px;
}
.passeport-title {
  font-family:'Bebas Neue',cursive; font-size:12px; letter-spacing:3px;
  color:var(--gold); text-align:center; margin-bottom:7px; opacity:0.8;
}
.stamps-row { display:flex; gap:9px; overflow-x:auto; padding:0 12px; scrollbar-width:none; }
.stamps-row::-webkit-scrollbar { display:none; }
.stamp { flex-shrink:0; width:64px; text-align:center; display:flex; flex-direction:column; align-items:center; gap:3px; }
.stamp-ring {
  width:52px; height:52px; border-radius:50%;
  border:2.5px dashed rgba(200,152,32,0.45);
  background:rgba(200,152,32,0.05);
  display:flex; align-items:center; justify-content:center; overflow:hidden;
  position:relative;
}
.stamp-ring img { width:44px; height:30px; object-fit:cover; border-radius:3px; }
.stamp-ring::after { content:''; position:absolute; inset:0; border-radius:50%; box-shadow:inset 0 0 8px rgba(200,152,32,0.18); }
.stamp-name { font-size:9px; font-weight:800; letter-spacing:.8px; color:var(--gold); text-transform:uppercase; max-width:64px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* â”€â”€ Clavier AZERTY â”€â”€ */
.keyboard-wrap { width:100%; flex-shrink:0; }
.keyboard { display:flex; flex-direction:column; align-items:center; gap:5px; width:100%; }
.kb-row { display:flex; flex-direction:row; justify-content:center; gap:4px; }
.kb-row .key {
  width:clamp(26px,7.5vw,36px); height:clamp(30px,8vw,40px);
  border-radius:7px;
  background:linear-gradient(155deg,rgba(24,42,95,0.98) 0%,rgba(16,28,72,0.98) 100%);
  border:1.5px solid rgba(70,110,200,0.28);
  color:var(--paper);
  font-family:'Nunito',sans-serif; font-size:clamp(11px,2.8vw,14px); font-weight:800;
  box-shadow:0 3px 0 rgba(0,0,10,0.55), inset 0 1px 0 rgba(255,255,255,0.06);
  transition:all .1s; flex-shrink:0;
}
.kb-row .key:hover:not(:disabled) {
  background:linear-gradient(155deg,rgba(240,120,40,0.22) 0%,rgba(200,80,15,0.18) 100%);
  border-color:rgba(240,120,40,0.55); color:var(--orange);
  transform:translateY(-2px);
  box-shadow:0 5px 0 rgba(0,0,10,0.55), 0 0 12px rgba(240,120,40,0.22);
}
.kb-row .key:active:not(:disabled) { transform:translateY(2px); box-shadow:0 1px 0 rgba(0,0,10,0.55); }
.kb-row .key:disabled { opacity:0.14; cursor:not-allowed; }

/* â”€â”€ Bouton langue au chat â”€â”€ */
.btn-langue {
  width:100%;
  background:linear-gradient(155deg,#2c72d4 0%,#1850a8 100%);
  color:#fff; border-radius:var(--r-md);
  padding:12px 18px; font-size:14px; font-weight:800;
  box-shadow:0 4px 0 #0c2d6a, 0 6px 20px rgba(44,114,212,0.32);
  letter-spacing:0.4px; flex-shrink:0;
}
.btn-langue:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 6px 0 #0c2d6a,0 8px 26px rgba(44,114,212,0.42); }
.btn-langue:active:not(:disabled) { transform:translateY(2px); box-shadow:0 2px 0 #0c2d6a; }
.btn-langue:disabled { opacity:0.28; cursor:not-allowed; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Ã‰CRAN FIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-fin { justify-content:center; padding:24px 16px; }
.winner-wrap { text-align:center; padding:22px; background:linear-gradient(145deg,rgba(245,200,64,0.07),rgba(200,150,30,0.04)); border:2px solid rgba(245,200,64,0.22); border-radius:var(--r-xl); width:100%; max-width:360px; margin-bottom:18px; }
.winner-crown { font-size:54px; animation:crown-bounce .65s ease infinite alternate; }
@keyframes crown-bounce { from{transform:translateY(0)} to{transform:translateY(-7px)} }
.winner-tag { font-size:10px; letter-spacing:3px; color:var(--teal); font-weight:800; margin:6px 0 4px; }
.winner-name { font-family:'Lilita One',cursive; font-size:36px; color:var(--gold); }
.stats-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:9px; width:100%; max-width:360px; margin-bottom:14px; }
.stat-cell { background:rgba(16,26,62,0.75); border:1.5px solid rgba(70,110,200,0.18); border-radius:var(--r-md); padding:12px 8px; text-align:center; }
.stat-val { font-family:'Bebas Neue',cursive; font-size:30px; color:var(--orange); }
.stat-lbl { font-size:10px; letter-spacing:1.4px; color:var(--muted); font-weight:700; text-transform:uppercase; margin-top:2px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHAT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chat-toggle { position:fixed; bottom:20px; right:16px; width:48px; height:48px; border-radius:50%; background:linear-gradient(145deg,var(--teal),#267a4a); color:#fff; font-size:20px; box-shadow:0 4px 16px rgba(58,170,106,0.48); z-index:100; display:flex; align-items:center; justify-content:center; transition:transform .18s; }
.chat-toggle:hover { transform:scale(1.1); }
.notif { position:absolute; top:-2px; right:-2px; width:12px; height:12px; border-radius:50%; background:var(--crimson); border:2px solid var(--bg); display:none; }
.notif.show { display:block; }
.chat-panel { position:fixed; bottom:0; right:0; width:min(320px,100vw); height:min(420px,60vh); background:rgba(10,18,50,0.97); border:1.5px solid rgba(70,110,200,0.22); border-radius:var(--r-lg) var(--r-lg) 0 0; display:flex; flex-direction:column; transform:translateY(100%); transition:transform .28s cubic-bezier(0.34,1.56,0.64,1); z-index:99; backdrop-filter:blur(12px); }
.chat-panel.open { transform:translateY(0); }
.chat-messages { flex:1; overflow-y:auto; padding:10px 12px; display:flex; flex-direction:column; gap:7px; }
.chat-input-wrap { display:flex; gap:7px; padding:9px 12px; border-top:1px solid rgba(255,255,255,0.06); }
.chat-input-wrap input { flex:1; padding:8px 11px; font-size:13px; }
.chat-input-wrap button { width:34px; height:34px; border-radius:8px; background:rgba(30,50,115,0.85); color:var(--paper); display:flex; align-items:center; justify-content:center; font-size:14px; flex-shrink:0; }
.chat-msg { background:rgba(22,38,85,0.65); border-radius:10px; padding:7px 10px; font-size:13px; }
.chat-msg.moi { background:rgba(240,120,40,0.1); border:1.5px solid rgba(240,120,40,0.18); }
.msg-author { font-size:10px; color:var(--muted); margin-bottom:2px; font-weight:700; letter-spacing:.4px; }
.msg-system { color:var(--muted); font-style:italic; font-size:12px; text-align:center; padding:3px 0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAUX â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,20,0.72); display:flex; align-items:center; justify-content:center; z-index:500; backdrop-filter:blur(5px); }
.modal-box { background:linear-gradient(145deg,rgba(18,30,72,0.99),rgba(10,20,52,0.99)); border:2px solid rgba(70,110,200,0.32); border-radius:var(--r-xl); padding:26px 22px; width:90%; max-width:380px; display:flex; flex-direction:column; align-items:center; gap:11px; box-shadow:0 22px 65px rgba(0,0,30,0.6); }
.modal-emoji { font-size:46px; }
.modal-title { font-family:'Bebas Neue',cursive; font-size:26px; letter-spacing:2px; color:var(--gold); text-align:center; }
.modal-text { font-size:14px; color:var(--paper); text-align:center; line-height:1.6; }
.modal-input { width:100%; text-align:center; font-size:18px; letter-spacing:4px; text-transform:uppercase; padding:13px; font-weight:700; }
.modal-actions { width:100%; display:flex; flex-direction:column; gap:8px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast-container { position:fixed; top:12px; left:50%; transform:translateX(-50%); z-index:9000; display:flex; flex-direction:column; align-items:center; gap:5px; width:min(360px,90vw); pointer-events:none; }
.toast { padding:10px 18px; border-radius:var(--r-md); font-size:13px; font-weight:700; background:rgba(16,26,65,0.96); border:1.5px solid rgba(70,110,200,0.28); color:var(--paper); backdrop-filter:blur(8px); animation:toast-in .28s cubic-bezier(0.34,1.56,0.64,1); text-align:center; box-shadow:0 4px 20px rgba(0,0,30,0.4); }
@keyframes toast-in { from{opacity:0;transform:translateY(-10px) scale(0.88)} to{opacity:1;transform:translateY(0) scale(1)} }
.toast.error { border-color:rgba(210,40,50,0.5); color:#ff9090; }
.toast.warn  { border-color:rgba(245,200,64,0.4); color:var(--gold); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DEBUG + TUTO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#debug-panel { display:none; position:fixed; bottom:0; left:0; width:300px; max-height:200px; overflow-y:auto; background:rgba(0,0,0,0.9); z-index:9999; padding:8px; font-family:monospace; color:#0f0; font-size:10px; }
.tuto-dot { width:8px; height:8px; border-radius:50%; background:rgba(255,255,255,0.2); cursor:pointer; transition:background .18s; }
.tuto-dot.active { background:var(--orange); }
.tuto-slide { animation:fade-up .28s ease; }
@keyframes fade-up { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:360px) {
  .logo-title { font-size:38px; }
  .vsp-av { width:38px; height:38px; font-size:18px; border-radius:9px; }
  .vsp-name { font-size:11px; max-width:72px; }
  .vs-chrono-val { font-size:24px; }
  .kb-row .key { width:24px; height:28px; font-size:11px; }
  .letters-sequence { font-size:34px; }
}
</style>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ACCUEIL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-accueil" class="screen">
  <div class="logo-wrap">
    <div class="logo-eyebrow">Je donne ma langue au chat</div>
    <span class="logo-globe">ğŸŒ</span>
    <div class="logo-title">LE PAYS<br>FATAL</div>
  </div>

  <!-- Ã‰TAPE 0 â€” Choix -->
  <div id="step-choix" class="card" style="text-align:center">
    <p style="color:var(--muted);font-size:10px;margin-bottom:2px;font-weight:800;letter-spacing:2.5px;text-transform:uppercase">Choisir un mode</p>
    <button class="btn btn-primary" style="height:58px;font-size:16px" onclick="allerStep('step-solo')">ğŸ¤– Solo vs Ordinateur</button>
    <div class="separator">ou</div>
    <button class="btn btn-secondary" style="height:58px;font-size:16px" onclick="allerStep('step-multi')">ğŸŒ Multijoueur en ligne</button>
  </div>

  <!-- Ã‰TAPE 1 â€” Solo -->
  <div id="step-solo" class="card hidden">
    <div class="step-header">
      <button class="btn-retour" onclick="allerStep('step-choix')">â† Retour</button>
      <span>Mode Solo</span>
    </div>
    <!-- SÃ©lection avatar -->
    <div class="avatar-section">
      <div class="avatar-label">Personnage</div>
      <div class="avatar-grid" id="solo-avatar-grid">
        <button class="av-btn selected" data-av="ğŸ§‘â€ğŸš€" onclick="pickAvatar(this,'solo')">ğŸ§‘â€ğŸš€</button>
        <button class="av-btn" data-av="ğŸ¤ " onclick="pickAvatar(this,'solo')">ğŸ¤ </button>
        <button class="av-btn" data-av="ğŸ´â€â˜ ï¸" onclick="pickAvatar(this,'solo')">ğŸ´â€â˜ ï¸</button>
        <button class="av-btn" data-av="ğŸ‘‘" onclick="pickAvatar(this,'solo')">ğŸ‘‘</button>
        <button class="av-btn" data-av="ğŸ§™" onclick="pickAvatar(this,'solo')">ğŸ§™</button>
        <button class="av-btn" data-av="ğŸ§”" onclick="pickAvatar(this,'solo')">ğŸ§”</button>
        <button class="av-btn" data-av="ğŸ‘©â€ğŸ’»" onclick="pickAvatar(this,'solo')">ğŸ‘©â€ğŸ’»</button>
        <button class="av-btn" data-av="ğŸ§•" onclick="pickAvatar(this,'solo')">ğŸ§•</button>
        <button class="av-btn" data-av="ğŸ§‘â€ğŸ¦±" onclick="pickAvatar(this,'solo')">ğŸ§‘â€ğŸ¦±</button>
        <button class="av-btn" data-av="ğŸ¤–" onclick="pickAvatar(this,'solo')">ğŸ¤–</button>
      </div>
    </div>
    <div class="form-group">
      <label>Ton nom</label>
      <input id="solo-nom" type="text" placeholder="Ex: Anta" maxlength="20">
    </div>
    <div class="toggle-wrap">
      <label class="toggle"><input type="checkbox" id="solo-mixte"><span class="toggle-slider"></span></label>
      <span style="font-size:13px;font-weight:700">Pays <em style="color:var(--gold)">&amp;</em> Capitales</span>
    </div>
    <!-- Slider chrono -->
    <div class="slider-wrap">
      <div class="slider-header">
        <span class="slider-label">ğŸ’£ Temps par tour</span>
        <span class="slider-val" id="solo-temps-lbl">15s</span>
      </div>
      <input type="range" class="game-slider" id="solo-temps-range" min="5" max="60" step="5" value="15"
        oninput="onSlider(this,'solo-temps-lbl','solo-temps')" style="--fill:33%">
      <input type="hidden" id="solo-temps" value="15">
    </div>
    <div class="row-2">
      <div class="form-group">
        <label>Langue</label>
        <select id="solo-langue"><option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option><option value="en">ğŸ‡¬ğŸ‡§ English</option></select>
      </div>
      <div class="form-group">
        <label>Vies</label>
        <select id="solo-vies"><option value="5">5 vies</option><option value="10" selected>10 vies</option><option value="15">15 vies</option></select>
      </div>
    </div>
    <div class="form-group">
      <label>Mode de jeu</label>
      <select id="solo-mode">
        <option value="classique" selected>ğŸ¯ Classique</option>
        <option value="blitz">âš¡ Blitz â€” 5 secondes</option>
        <option value="survie">ğŸ’€ Survie â€” 1 vie</option>
        <option value="acceleration">ğŸ”¥ AccÃ©lÃ©ration</option>
      </select>
    </div>
    <button class="btn btn-primary" style="height:56px;font-size:17px" onclick="lancerSolo()">ğŸ® Lancer le voyage !</button>
  </div>

  <!-- Ã‰TAPE 2 â€” Multi -->
  <div id="step-multi" class="card hidden">
    <div class="step-header">
      <button class="btn-retour" onclick="allerStep('step-choix')">â† Retour</button>
      <span>Multijoueur</span>
    </div>
    <button class="btn btn-primary" style="height:54px" onclick="allerStep('step-creer')">ğŸ—ºï¸ CrÃ©er une partie</button>
    <div class="separator">ou</div>
    <button class="btn btn-secondary" style="height:54px" onclick="allerStep('step-rejoindre')">ğŸ”— Rejoindre avec un code</button>
    <div style="margin-top:4px">
      <button class="btn btn-ghost" onclick="rafraichirRooms()">âŸ³ Parties publiques disponibles</button>
      <div id="rooms-list" class="rooms-list"></div>
    </div>
  </div>

  <!-- Ã‰TAPE 3a â€” CrÃ©er -->
  <div id="step-creer" class="card hidden">
    <div class="step-header">
      <button class="btn-retour" onclick="allerStep('step-multi')">â† Retour</button>
      <span>CrÃ©er une partie</span>
    </div>
    <div class="avatar-section">
      <div class="avatar-label">Personnage</div>
      <div class="avatar-grid" id="creer-avatar-grid">
        <button class="av-btn selected" data-av="ğŸ§‘â€ğŸš€" onclick="pickAvatar(this,'creer')">ğŸ§‘â€ğŸš€</button>
        <button class="av-btn" data-av="ğŸ¤ " onclick="pickAvatar(this,'creer')">ğŸ¤ </button>
        <button class="av-btn" data-av="ğŸ´â€â˜ ï¸" onclick="pickAvatar(this,'creer')">ğŸ´â€â˜ ï¸</button>
        <button class="av-btn" data-av="ğŸ‘‘" onclick="pickAvatar(this,'creer')">ğŸ‘‘</button>
        <button class="av-btn" data-av="ğŸ§™" onclick="pickAvatar(this,'creer')">ğŸ§™</button>
        <button class="av-btn" data-av="ğŸ§”" onclick="pickAvatar(this,'creer')">ğŸ§”</button>
        <button class="av-btn" data-av="ğŸ‘©â€ğŸ’»" onclick="pickAvatar(this,'creer')">ğŸ‘©â€ğŸ’»</button>
        <button class="av-btn" data-av="ğŸ§•" onclick="pickAvatar(this,'creer')">ğŸ§•</button>
        <button class="av-btn" data-av="ğŸ§‘â€ğŸ¦±" onclick="pickAvatar(this,'creer')">ğŸ§‘â€ğŸ¦±</button>
        <button class="av-btn" data-av="ğŸ¤–" onclick="pickAvatar(this,'creer')">ğŸ¤–</button>
      </div>
    </div>
    <div class="form-group">
      <label>Ton nom</label>
      <input id="creer-nom" type="text" placeholder="Ex: Anta" maxlength="20">
    </div>
    <div class="toggle-wrap">
      <label class="toggle"><input type="checkbox" id="creer-mixte"><span class="toggle-slider"></span></label>
      <span style="font-size:13px;font-weight:700">Pays <em style="color:var(--gold)">&amp;</em> Capitales</span>
    </div>
    <div class="slider-wrap">
      <div class="slider-header">
        <span class="slider-label">ğŸ’£ Temps par tour</span>
        <span class="slider-val" id="creer-temps-lbl">15s</span>
      </div>
      <input type="range" class="game-slider" id="creer-temps-range" min="5" max="60" step="5" value="15"
        oninput="onSlider(this,'creer-temps-lbl','creer-temps')" style="--fill:33%">
      <input type="hidden" id="creer-temps" value="15">
    </div>
    <div>
      <div class="counter-label">Nombre de joueurs max</div>
      <div class="joueurs-counter">
        <button class="ctr-btn" onclick="changeMax(-1)">âˆ’</button>
        <div class="ctr-val" id="creer-max-val">4</div>
        <button class="ctr-btn" onclick="changeMax(+1)">+</button>
      </div>
      <input type="hidden" id="creer-max" value="4">
    </div>
    <div class="row-2">
      <div class="form-group">
        <label>Langue</label>
        <select id="creer-langue"><option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option><option value="en">ğŸ‡¬ğŸ‡§ English</option></select>
      </div>
      <div class="form-group">
        <label>Vies</label>
        <select id="creer-vies"><option value="5">5 vies</option><option value="10" selected>10 vies</option><option value="15">15 vies</option></select>
      </div>
    </div>
    <div class="form-group">
      <label>Mode de jeu</label>
      <select id="creer-mode">
        <option value="classique" selected>ğŸ¯ Classique</option>
        <option value="blitz">âš¡ Blitz â€” 5 secondes</option>
        <option value="survie">ğŸ’€ Survie â€” 1 vie</option>
        <option value="acceleration">ğŸ”¥ AccÃ©lÃ©ration</option>
      </select>
    </div>
    <button class="btn btn-primary" style="height:56px;font-size:17px" onclick="creerPartie()" id="btn-creer">ğŸ—ºï¸ CrÃ©er la partie</button>
  </div>

  <!-- Ã‰TAPE 3b â€” Rejoindre -->
  <div id="step-rejoindre" class="card hidden">
    <div class="step-header">
      <button class="btn-retour" onclick="allerStep('step-multi')">â† Retour</button>
      <span>Rejoindre</span>
    </div>
    <div class="form-group">
      <label>Ton nom</label>
      <input id="rejoindre-nom" type="text" placeholder="Ex: Fatou" maxlength="20">
    </div>
    <div class="form-group">
      <label>Code de la salle</label>
      <input id="rejoindre-code" type="text" placeholder="ABCDEF" maxlength="6"
        style="text-transform:uppercase;letter-spacing:8px;font-size:26px;text-align:center"
        oninput="this.value=this.value.toUpperCase()"
        onkeydown="if(event.key==='Enter')rejoindreParCode()">
    </div>
    <button class="btn btn-primary" style="height:54px" onclick="rejoindreParCode()">Rejoindre â†’</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOBBY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-lobby" class="screen hidden">
  <div class="logo-wrap" style="padding:14px 20px 6px">
    <div class="logo-title" style="font-size:30px">LOBBY</div>
  </div>
  <div class="lobby-header">
    <button onclick="retourAccueil()" style="background:none;border:none;color:var(--muted);font-size:22px;cursor:pointer;padding:0;line-height:1">â†</button>
    <span class="lobby-title" style="font-size:18px;color:var(--muted)">Salle d'attente</span>
    <div class="room-badge" id="lobby-code">â€”â€”</div>
  </div>
  <button class="link-share" onclick="copierLien()">
    <span>ğŸ”—</span>
    <span class="link-text" id="lien-partage">Chargementâ€¦</span>
    <span style="color:var(--teal);font-size:10px;font-weight:800;letter-spacing:1.5px">COPIER</span>
  </button>
  <div id="players-grid" class="players-grid"></div>
  <div class="lobby-actions" id="lobby-actions">
    <button class="btn btn-primary" id="btn-demarrer" onclick="demarrerPartie()" style="display:none;height:56px;font-size:17px">ğŸ® Lancer le voyage !</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JEU â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-jeu" class="screen hidden" style="padding:0">

  <!-- Barre actions -->
  <div class="jeu-topbar">
    <button class="jtb-btn" onclick="toggleSons()" id="btn-sons">ğŸ”Š</button>
    <div id="mode-badge" style="display:none;font-family:'Bebas Neue',cursive;font-size:11px;letter-spacing:2.5px;color:var(--orange)"></div>
    <button class="jtb-btn" id="btn-pause" onclick="basculerPause()">â¸ Pause</button>
    <button class="jtb-btn jtb-quit" onclick="confirmerQuitter()">âœ• Quitter</button>
  </div>

  <!-- Header VS -->
  <div class="vs-header" id="vs-header">
    <div class="vsp" id="vsp-left">
      <div class="vsp-av" id="vsp-av-left">ğŸ§‘â€ğŸš€</div>
      <div class="vsp-info">
        <div class="vsp-name" id="vsp-name-left">â€”</div>
        <div class="vsp-hearts" id="vsp-hearts-left"></div>
      </div>
    </div>
    <div class="vs-mid">
      <div class="vs-badge">VS</div>
      <div class="vs-chrono-val" id="chrono-val">15</div>
      <div class="vs-sec">SEC</div>
    </div>
    <div class="vsp right" id="vsp-right">
      <div class="vsp-av" id="vsp-av-right">ğŸ¤–</div>
      <div class="vsp-info" style="align-items:flex-end">
        <div class="vsp-name" id="vsp-name-right">â€”</div>
        <div class="vsp-hearts" id="vsp-hearts-right" style="justify-content:flex-end"></div>
      </div>
    </div>
  </div>

  <!-- Joueurs extra (3+) -->
  <div id="extra-strip" class="extra-strip hidden"></div>

  <!-- Barre chrono Ã  mÃ¨che de dynamite -->
  <div class="fuse-wrap">
    <div class="fuse-bar" id="chrono-fill" style="width:100%"></div>
  </div>

  <!-- Zone jeu -->
  <div class="game-main">
    <!-- BanniÃ¨re "En danger" -->
    <div class="danger-banner hidden" id="danger-banner">ğŸ’£ <span id="danger-text">En danger</span></div>

    <!-- SÃ©quence -->
    <div class="letters-display">
      <div class="letters-sequence" id="letters-seq">â€¦</div>
      <div class="turn-indicator" id="turn-indicator">En attente</div>
      <div class="possibilities-count" id="poss-count"></div>
    </div>

    <!-- Passeport â€” historique -->
    <div class="passeport-wrap" id="passeport-wrap" style="display:none">
      <div class="passeport-title">âœˆ PASSEPORT</div>
      <div class="stamps-row" id="stamps-row"></div>
    </div>

    <!-- Clavier AZERTY -->
    <div class="keyboard-wrap">
      <div class="keyboard" id="keyboard"></div>
    </div>

    <!-- Bouton langue au chat -->
    <button class="btn-langue" id="btn-langue" onclick="demanderLangueAuChat()">
      ğŸ—£ï¸ Je m'arrÃªte lÃ  (Langue au chat)
    </button>
  </div>

  <!-- Ã‰lÃ©ments cachÃ©s pour compat JS legacy -->
  <div id="topbar-row"       style="display:none"></div>
  <div id="topbar-row-extra" style="display:none"></div>
  <div id="flags-inner"      style="display:none"></div>
  <div id="flags-label"      style="display:none"></div>
  <div id="hourglass-display" style="display:none">â³</div>
  <div id="chrono-pill"      style="display:none"><span id="chrono-val-pill">15</span></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-fin" class="screen hidden">
  <div class="winner-wrap">
    <div class="winner-crown">ğŸ‘‘</div>
    <div class="winner-tag">LE WINNERRRR ğŸ‰</div>
    <div class="winner-name" id="winner-name">â€”</div>
  </div>
  <div class="stats-grid">
    <div class="stat-cell"><div class="stat-val" id="stat-pays">0</div><div class="stat-lbl">Pays jouÃ©s</div></div>
    <div class="stat-cell"><div class="stat-val" id="stat-tours">0</div><div class="stat-lbl">Tours</div></div>
    <div class="stat-cell"><div class="stat-val" id="stat-vies">0</div><div class="stat-lbl">Vies restantes</div></div>
  </div>
  <div style="display:flex;gap:10px;width:calc(100% - 32px);max-width:360px">
    <button class="btn btn-secondary" style="flex:1" onclick="retourAccueil()">â† Accueil</button>
    <button class="btn btn-primary"   style="flex:1" onclick="rejouerMeme()">â†º Rejouer</button>
  </div>
  <div style="display:flex;flex-direction:column;gap:8px;width:calc(100% - 32px);max-width:360px;margin-top:8px">
    <button onclick="afficherScores()" style="width:100%;padding:12px;background:rgba(245,166,35,0.08);border:1.5px solid rgba(245,166,35,0.2);color:var(--amber);border-radius:10px;cursor:pointer;font-size:14px;font-family:'Nunito',sans-serif;font-weight:700">ğŸ† Meilleurs scores</button>
    <button class="btn btn-secondary" onclick="afficherPaysJoues()">ğŸ—ºï¸ Voir les pays jouÃ©s</button>
  </div>
</div>

<!-- CHAT -->
<button class="chat-toggle hidden" id="chat-toggle-btn" onclick="toggleChat()">ğŸ’¬<span class="notif" id="chat-notif"></span></button>
<div class="chat-panel" id="chat-panel">
  <div style="padding:13px 15px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center">
    <span style="font-family:'Bebas Neue',cursive;font-size:14px;letter-spacing:2px;color:var(--teal)">CHAT</span>
    <button onclick="toggleChat()" style="background:none;color:var(--muted);font-size:18px;line-height:1">Ã—</button>
  </div>
  <div class="chat-messages" id="chat-messages"></div>
  <div id="emoji-bar" style="display:none;flex-wrap:wrap;gap:4px;padding:7px 11px;border-top:1px solid rgba(255,255,255,.06)">
    <span style="font-size:9px;color:var(--muted);width:100%;font-family:'Bebas Neue',cursive;letter-spacing:1px">RÃ‰ACTION RAPIDE</span>
  </div>
  <div class="chat-input-wrap">
    <input id="chat-input" type="text" placeholder="Messageâ€¦" maxlength="200" onkeydown="if(event.key==='Enter')envoyerChat()">
    <button onclick="envoyerEmoji()" title="Emoji">ğŸ˜Š</button>
    <button onclick="envoyerChat()">â†‘</button>
  </div>
</div>

<!-- MODAUX -->
<div class="modal-overlay hidden" id="modal-langue">
  <div class="modal-box">
    <span class="modal-emoji">ğŸ—£ï¸</span>
    <div class="modal-title">Langue au chat !</div>
    <div class="modal-text" id="modal-langue-text">Quel pays avais-tu en tÃªte ?</div>
    <div id="lac-countdown" style="font-family:'Bebas Neue',cursive;font-size:52px;color:var(--amber);line-height:1;text-align:center">20</div>
    <div style="height:6px;background:rgba(255,255,255,0.07);border-radius:3px;margin-bottom:4px;overflow:hidden">
      <div id="lac-progress" style="height:100%;background:var(--amber);border-radius:3px;width:100%;transition:width 1s linear"></div>
    </div>
    <input class="modal-input" id="modal-langue-input" type="text" placeholder="FRANCEâ€¦" onkeydown="if(event.key==='Enter')validerLangueAuChat()">
    <div class="modal-actions"><button class="btn btn-primary" onclick="validerLangueAuChat()">Valider</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="modal-verdict">
  <div class="modal-box">
    <span class="modal-emoji" id="verdict-emoji">âš–ï¸</span>
    <div class="modal-title" id="verdict-title">Verdict</div>
    <div class="modal-text" id="verdict-text"></div>
    <div class="modal-actions"><button class="btn btn-primary" onclick="fermerVerdict()">OK</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="modal-pause">
  <div class="modal-box" style="text-align:center">
    <span class="modal-emoji">â¸</span>
    <div class="modal-title">Partie en pause</div>
    <div class="modal-text">Le chrono est arrÃªtÃ©.</div>
    <div class="modal-actions"><button class="btn btn-primary" onclick="reprendreDepuisPause()">â–¶ Reprendre</button></div>
  </div>
</div>

<div class="modal-overlay hidden" id="modal-quitter">
  <div class="modal-box" style="text-align:center">
    <span class="modal-emoji">ğŸšª</span>
    <div class="modal-title">Quitter la partie ?</div>
    <div class="modal-text">La partie sera abandonnÃ©e.</div>
    <div class="modal-actions" style="flex-direction:row;gap:10px">
      <button class="btn btn-secondary" style="flex:1" onclick="annulerQuitter()">Continuer</button>
      <button class="btn btn-primary" style="flex:1;background:var(--crimson)" onclick="retourAccueil()">Quitter</button>
    </div>
  </div>
</div>

<div class="modal-overlay hidden" id="modal-pays-joues">
  <div class="modal-box" style="max-width:460px;text-align:left">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;width:100%">
      <div id="pays-joues-count" style="font-family:'Bebas Neue',cursive;font-size:16px;color:var(--teal);letter-spacing:1px"></div>
      <button onclick="document.getElementById('modal-pays-joues').classList.add('hidden')" style="background:none;color:var(--muted);font-size:20px;cursor:pointer;line-height:1">Ã—</button>
    </div>
    <div id="pays-joues-list" style="max-height:340px;overflow-y:auto;padding-right:4px"></div>
    <div style="margin-top:14px"><button class="btn btn-primary" onclick="document.getElementById('modal-pays-joues').classList.add('hidden')">Fermer</button></div>
  </div>
</div>

<div id="toast-container"></div>
<div id="debug-panel"></div>

<script>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ã‰TAT GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATE = {
  // Connexion
  ws: null,
  serveur: null,           // URL WebSocket du serveur
  roomId: null,
  joueurId: crypto.randomUUID(),
  nom: 'Joueur',
  estCreateur: false,
  modeJeu: 'classique',  // classique | blitz | survie | acceleration
  modeConnecte: false,     // false = mode solo, true = connectÃ© au serveur
  joueurFautif: null,      // id du joueur qui a posÃ© la sÃ©quence courante

  // Partie
  etat: null,              // snapshot serveur
  tempsMax: 15,
  tempsRestant: 15,
  chronoInterval: null,
  estMonTour: false,
  nbTours: 0,

  // Config
  langue: 'fr',
  modeMixte: false,
  paysJouesList: [],   // pays jouÃ©s en mode connectÃ© (rempli Ã  fin_partie)
};

// URL du serveur â€” modifier selon ton hÃ©bergement
// En local : ws://localhost:8000
// En prod  : wss://ton-app.onrender.com
const SERVEUR_HTTP = window.location.hostname === 'localhost'
  ? 'http://localhost:8000'
  : 'https://pays-game.onrender.com';   // â† Ã€ CHANGER EN PROD

const SERVEUR_WS = SERVEUR_HTTP.replace('http', 'ws');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODE SOLO (sans serveur) â€” donnÃ©es locales
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let PAYS_LOCAL = null;

async function chargerPaysLocal(langue) {
  try {
    const r = await fetch(`pays_${langue}.json`);
    const pays = await r.json();
    // Re-normaliser pour garantir cohÃ©rence (supprime tirets, espaces, apostrophes)
    pays.forEach(p => {
      p.nom_normalise       = normaliser(p.nom_normalise || p.nom || '');
      p.capitale_normalisee = normaliser(p.capitale_normalisee || p.capitale || '');
    });
    pays._langue = langue; // marquer la langue chargÃ©e
    PAYS_LOCAL = pays;
  } catch {
    // Fallback minimal
    PAYS_LOCAL = [
      { nom: 'FRANCE', capitale: 'PARIS', code: 'fr', nom_normalise: 'FRANCE', capitale_normalisee: 'PARIS' },
      { nom: 'ALLEMAGNE', capitale: 'BERLIN', code: 'de', nom_normalise: 'ALLEMAGNE', capitale_normalisee: 'BERLIN' },
      { nom: 'ESPAGNE', capitale: 'MADRID', code: 'es', nom_normalise: 'ESPAGNE', capitale_normalisee: 'MADRID' },
      { nom: 'ITALIE', capitale: 'ROME', code: 'it', nom_normalise: 'ITALIE', capitale_normalisee: 'ROME' },
      { nom: 'BELGIQUE', capitale: 'BRUXELLES', code: 'be', nom_normalise: 'BELGIQUE', capitale_normalisee: 'BRUXELLES' },
      { nom: 'PORTUGAL', capitale: 'LISBONNE', code: 'pt', nom_normalise: 'PORTUGAL', capitale_normalisee: 'LISBONNE' },
      { nom: 'PAYS-BAS', capitale: 'AMSTERDAM', code: 'nl', nom_normalise: 'PAYS-BAS', capitale_normalisee: 'AMSTERDAM' },
      { nom: 'SUISSE', capitale: 'BERNE', code: 'ch', nom_normalise: 'SUISSE', capitale_normalisee: 'BERNE' },
      { nom: 'CANADA', capitale: 'OTTAWA', code: 'ca', nom_normalise: 'CANADA', capitale_normalisee: 'OTTAWA' },
      { nom: 'CHINE', capitale: 'PÃ‰KIN', code: 'cn', nom_normalise: 'CHINE', capitale_normalisee: 'PEKIN' },
      { nom: 'JAPON', capitale: 'TOKYO', code: 'jp', nom_normalise: 'JAPON', capitale_normalisee: 'TOKYO' },
    ];
    toast('âš ï¸ Fichier pays non trouvÃ© â€” mode dÃ©mo avec pays limitÃ©s', 'warn');
  }
}

function normaliser(s) {
  return s.toUpperCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .replace(/[^A-Z]/g, ''); // BUG02 FIX â€” supprime espaces, tirets, apostrophes (alignÃ© sur main.py)
}

function chercherPossibilites(seq) {
  if (!PAYS_LOCAL || !seq) return PAYS_LOCAL || [];
  const s = normaliser(seq);
  return PAYS_LOCAL.filter(p =>
    p.nom_normalise.startsWith(s) ||
    (STATE.modeMixte && p.capitale_normalisee.startsWith(s))
  );
}

function estComplet(seq) {
  const s = normaliser(seq);
  return PAYS_LOCAL?.find(p =>
    p.nom_normalise === s ||
    (STATE.modeMixte && p.capitale_normalisee === s)
  ) || null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function afficherEcran(id) {
  // Chat visible uniquement en lobby et en jeu
  const chatBtn = document.getElementById('chat-toggle-btn');
  if (chatBtn) {
    if (id === 'screen-lobby' || id === 'screen-jeu') {
      chatBtn.classList.remove('hidden');
    } else {
      chatBtn.classList.add('hidden');
      // Fermer le panel si ouvert
      document.getElementById('chat-panel').classList.remove('open');
    }
  }
  ['screen-accueil','screen-lobby','screen-jeu','screen-fin'].forEach(s => {
    document.getElementById(s).classList.toggle('hidden', s !== id);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WIZARD ACCUEIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STEPS = ['step-choix','step-solo','step-multi','step-creer','step-rejoindre'];

function allerStep(id) {
  STEPS.forEach(s => document.getElementById(s)?.classList.add('hidden'));
  document.getElementById(id)?.classList.remove('hidden');
  setTimeout(() => {
    const input = document.getElementById(id)?.querySelector('input[type="text"]');
    if (input) input.focus();
  }, 50);
}

// â”€â”€ Solo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lancerSolo() {
  const nom    = document.getElementById('solo-nom').value.trim()  || 'Joueur';
  const langue = document.getElementById('solo-langue').value;
  STATE.nom       = nom;
  STATE.langue    = langue;
  STATE.modeMixte = document.getElementById('solo-mixte').checked;
  STATE.modeJeu   = document.getElementById('solo-mode')?.value || 'classique';

  // Ajuster config selon le mode
  let vies = parseInt(document.getElementById('solo-vies').value) || 10;
  let temps = parseInt(document.getElementById('solo-temps').value) || 15;
  if (STATE.modeJeu === 'blitz')    { temps = 5; }
  if (STATE.modeJeu === 'survie')   { vies = 1; }
  STATE.tempsMax  = temps;
  SOLO.viesDepart = vies;
  SOLO.tempsDepart = temps;

  if (!PAYS_LOCAL || PAYS_LOCAL._langue !== langue) {
    chargerPaysLocal(langue).then(() => lancerModeSolo(vies));
  } else {
    lancerModeSolo(vies);
  }
}

// â”€â”€ CrÃ©er â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function creerPartie() {
  const nom    = document.getElementById('creer-nom').value.trim() || 'Joueur';
  const langue = document.getElementById('creer-langue').value;
  STATE.nom       = nom;
  STATE.langue    = langue;
  STATE.modeMixte = document.getElementById('creer-mixte').checked;
  STATE.tempsMax  = parseInt(document.getElementById('creer-temps').value);
  STATE.estCreateur = true;

  const btn = document.getElementById('btn-creer');
  btn.disabled = true;
  btn.textContent = 'â³ Connexionâ€¦';

  if (!PAYS_LOCAL || PAYS_LOCAL._langue !== langue) await chargerPaysLocal(langue);

  STATE.modeJeu = document.getElementById('creer-mode')?.value || 'classique';
  let viesMode = parseInt(document.getElementById('creer-vies').value);
  let tempsMode = STATE.tempsMax;
  if (STATE.modeJeu === 'blitz')  tempsMode = 5;
  if (STATE.modeJeu === 'survie') viesMode = 1;
  STATE.tempsMax = tempsMode;

  const connecte = await tenterConnexionServeur(true, {
    langue,
    mode_mixte: STATE.modeMixte,
    vies:        viesMode,
    temps:       tempsMode,
    max_joueurs: parseInt(document.getElementById('creer-max').value),
    mode_jeu:    STATE.modeJeu,
  });

  btn.disabled = false;
  btn.textContent = 'ğŸ—ºï¸ CrÃ©er la partie';

  if (!connecte) {
    toast('ğŸ”Œ Serveur non disponible', 'error');
  }
}

// â”€â”€ Rejoindre â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function rejoindreParCode(codeForce) {
  const code = (codeForce || document.getElementById('rejoindre-code')?.value || '').trim().toUpperCase();
  const nom  = (document.getElementById('rejoindre-nom')?.value || '').trim() || 'Joueur';
  if (!code || code.length !== 6) { toast('Code invalide (6 lettres)', 'error'); return; }

  STATE.nom         = nom;
  STATE.estCreateur = false;

  const btn = document.querySelector('#step-rejoindre .btn-primary');
  if (btn) { btn.disabled = true; btn.textContent = 'â³ Connexionâ€¦'; }

  try {
    const r = await fetch(`${SERVEUR_HTTP}/parties/${code}`, { signal: AbortSignal.timeout(5000) });
    if (!r.ok) { toast('Salle introuvable', 'error'); resetBtnRejoindre(); return; }
    const data = await r.json();
    // VÃ©rifier l'Ã©tat AVANT d'ouvrir le WebSocket
    if (data.etat === 'en_cours') {
      toast('âŒ Cette partie a dÃ©jÃ  commencÃ© !', 'error');
      resetBtnRejoindre(); return;
    }
    if (data.etat === 'terminee') {
      toast('âŒ Cette partie est terminÃ©e.', 'error');
      resetBtnRejoindre(); return;
    }
    const nbJoueurs = data.joueurs ? data.joueurs.length : 0;
    if (nbJoueurs >= (data.config?.max_joueurs || 8)) {
      toast('âŒ La salle est pleine !', 'error');
      resetBtnRejoindre(); return;
    }
    const cfg = data.config || {};
    STATE.langue    = cfg.langue    || 'fr';
    STATE.modeMixte = cfg.mode_mixte || false;
    STATE.tempsMax  = cfg.temps      || 15;
  } catch {
    toast('Serveur non disponible', 'error'); resetBtnRejoindre(); return;
  }

  if (!PAYS_LOCAL || PAYS_LOCAL._langue !== STATE.langue) await chargerPaysLocal(STATE.langue);

  const connecte = await tenterConnexionServeur(false, null, code);
  if (!connecte) toast('Impossible de rejoindre', 'error');
  resetBtnRejoindre();
}

function resetBtnRejoindre() {
  const btn = document.querySelector('#step-rejoindre .btn-primary');
  if (btn) { btn.disabled = false; btn.textContent = 'Rejoindre â†’'; }
}

// â”€â”€ Parties publiques â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function rafraichirRooms() {
  const list = document.getElementById('rooms-list');
  list.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px;text-align:center">Rechercheâ€¦</div>';
  try {
    const r = await fetch(`${SERVEUR_HTTP}/parties`, { signal: AbortSignal.timeout(4000) });
    const rooms = await r.json();
    list.innerHTML = '';
    if (!rooms.length) {
      list.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px;text-align:center">Aucune partie disponible</div>';
      return;
    }
    rooms.forEach(room => {
      const div = document.createElement('div');
      div.className = 'room-item';
      div.innerHTML = `<span class="room-id">${room.room_id}</span><span class="room-info">${room.joueurs}/${room.max_joueurs} joueurs Â· ${room.langue === 'fr' ? 'ğŸ‡«ğŸ‡·' : 'ğŸ‡¬ğŸ‡§'}</span>`;
      div.onclick = () => {
        // PrÃ©-remplir le code et aller sur l'Ã©tape rejoindre
        allerStep('step-rejoindre');
        document.getElementById('rejoindre-code').value = room.room_id;
      };
      list.appendChild(div);
    });
  } catch {
    list.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px;text-align:center">Serveur non disponible</div>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONNEXION WEBSOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function tenterConnexionServeur(creer, config, roomId = null) {
  try {
    if (creer) {
      const r = await fetch(`${SERVEUR_HTTP}/parties`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config),
        signal: AbortSignal.timeout(4000),
      });
      const data = await r.json();
      STATE.roomId = data.room_id;
    } else {
      STATE.roomId = roomId;
    }

    const ws = new WebSocket(
      `${SERVEUR_WS}/ws/${STATE.roomId}/${encodeURIComponent(STATE.joueurId)}/${encodeURIComponent(STATE.nom)}`
    );

    return await new Promise((resolve) => {
      const timer = setTimeout(() => { ws.close(); resolve(false); }, 5000);

      ws.onopen = () => {
        clearTimeout(timer);
        STATE.ws = ws;
        STATE.modeConnecte = true; // â† CRITIQUE : active le mode multijoueur
        ws.onmessage = onMessage;
        ws.onclose   = (evt) => onClose(evt);
        ws.onerror   = () => {};
        afficherLobby();
        resolve(true);
      };
      ws.onerror = () => { clearTimeout(timer); resolve(false); };
    });
  } catch {
    return false;
  }
}

function envoyerWS(data) {
  if (STATE.ws && STATE.ws.readyState === WebSocket.OPEN) {
    STATE.ws.send(JSON.stringify(data));
  }
}

function onMessage(evt) {
  const msg = JSON.parse(evt.data);
  debugLog(`ğŸ“¨ ${msg.type} | actuel=${msg.joueur_actuel?.slice(0,8)} | seq="${msg.sequence}"`);
  traiterMessage(msg);
}

// â”€â”€ Panneau debug (appuyer D pour toggle) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let DEBUG_ON = false;
function debugLog(txt) {
  if (!DEBUG_ON) return;
  const el = document.getElementById('debug-panel');
  if (!el) return;
  const line = document.createElement('div');
  line.textContent = new Date().toLocaleTimeString('fr') + ' ' + txt;
  line.style.cssText = 'font-size:10px;border-bottom:1px solid #333;padding:2px 0;word-break:break-all';
  el.prepend(line);
  while (el.children.length > 20) el.lastChild.remove();
}
document.addEventListener('keydown', e => {
  if (e.key === 'd' && e.ctrlKey) {
    DEBUG_ON = !DEBUG_ON;
    const el = document.getElementById('debug-panel');
    if (el) el.style.display = DEBUG_ON ? 'block' : 'none';
    if (DEBUG_ON) {
      debugLog(`ğŸ‘¤ monId=${STATE.joueurId.slice(0,8)} | connectÃ©=${STATE.modeConnecte}`);
    }
  }
});

let _reconnectAttempts = 0;
let _reconnectTimer = null;

function onClose(evt) {
  STATE.ws = null;
  STATE.modeConnecte = false;
  // Codes spÃ©ciaux : partie en cours ou pleine
  if (evt && evt.code === 4001) {
    toast('âŒ Cette partie a dÃ©jÃ  commencÃ©.', 'error');
    setTimeout(() => afficherEcran('screen-accueil'), 1500);
    return;
  }
  if (evt && evt.code === 4002) {
    toast('âŒ La salle est pleine.', 'error');
    setTimeout(() => afficherEcran('screen-accueil'), 1500);
    return;
  }

  // Si en cours de partie â†’ tenter reconnexion automatique
  const enJeu = !document.getElementById('screen-jeu').classList.contains('hidden');
  const enLobby = !document.getElementById('screen-lobby').classList.contains('hidden');

  if ((enJeu || enLobby) && STATE.roomId && _reconnectAttempts < 5) {
    const delai = Math.min(1500 * Math.pow(1.5, _reconnectAttempts), 8000);
    _reconnectAttempts++;
    toast(`ğŸ”Œ DÃ©connectÃ© â€” reconnexion dans ${Math.round(delai/1000)}sâ€¦ (${_reconnectAttempts}/5)`, 'warn');
    _reconnectTimer = setTimeout(async () => {
      const ok = await tenterReconnexion();
      if (ok) {
        _reconnectAttempts = 0;
        toast('âœ… ReconnectÃ© !', '');
      }
    }, delai);
  } else if (enJeu || enLobby) {
    toast('ğŸ”Œ Connexion perdue â€” impossible de reconnecter', 'error');
    // Proposer de retourner Ã  l'accueil aprÃ¨s 3s
    setTimeout(() => {
      if (confirm("Connexion perdue. Retourner Ã  l'accueil ?")) retourAccueil();
    }, 3000);
  }
}

async function tenterReconnexion() {
  if (!STATE.roomId || !STATE.joueurId) return false;
  try {
    const ws = new WebSocket(
      `${SERVEUR_WS}/ws/${STATE.roomId}/${encodeURIComponent(STATE.joueurId)}/${encodeURIComponent(STATE.nom)}`
    );
    return await new Promise((resolve) => {
      const timer = setTimeout(() => { ws.close(); resolve(false); }, 5000);
      ws.onopen = () => {
        clearTimeout(timer);
        STATE.ws = ws;
        STATE.modeConnecte = true;
        ws.onmessage = onMessage;
        ws.onclose   = (evt) => onClose(evt);
        ws.onerror   = () => {};
        resolve(true);
      };
      ws.onerror = () => { clearTimeout(timer); resolve(false); };
    });
  } catch { return false; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRAITEMENT DES MESSAGES SERVEUR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function traiterMessage(msg) {
  debugLog(`âš™ï¸ traiter: ${msg.type} | monTour=${msg.joueur_actuel === STATE.joueurId} | connectÃ©=${STATE.modeConnecte}`);
  switch(msg.type) {
    case 'etat':
    case 'joueur_rejoint':
    case 'joueur_parti':
      mettreAJourEtat(msg);
      break;

    case 'erreur':
      toast(msg.message, 'error');
      // Si erreur de rejoindre (partie en cours ou pleine) â†’ retour accueil
      if (msg.message && msg.message.startsWith('âŒ')) {
        setTimeout(() => {
          if (STATE.ws) { STATE.ws.close(); STATE.ws = null; }
          afficherEcran('screen-accueil');
        }, 2500);
      }
      break;

    case 'partie_demarree':
      // Synchroniser la config depuis le snapshot serveur
      if (msg.config) {
        STATE.langue    = msg.config.langue     || STATE.langue;
        STATE.modeMixte = msg.config.mode_mixte || false;
        STATE.tempsMax  = msg.config.temps       || STATE.tempsMax;
        STATE.modeJeu   = msg.config.mode_jeu   || 'classique';
      }
      // S'assurer que le mode connectÃ© est bien activÃ© (sÃ©curitÃ©)
      STATE.modeConnecte = true;
      // â”€â”€ CORRECTION INVITÃ‰ : vÃ©rifier que notre joueurId matche le serveur
      // Si l'UUID local ne correspond pas (encodage URL, etc.), chercher par nom
      if (msg.joueurs) {
        const moi = msg.joueurs.find(j => j.id === STATE.joueurId);
        if (!moi) {
          const parNom = msg.joueurs.find(j => j.nom === STATE.nom && !j.est_ia);
          if (parNom) {
            debugLog('âš ï¸ joueurId corrigÃ©: ' + STATE.joueurId.slice(0,8) + ' â†’ ' + parNom.id.slice(0,8));
            STATE.joueurId = parNom.id;
          }
        }
      }
      afficherEcran('screen-jeu');
      construireClavier();
      // Badge mode
      {
        const badge = document.getElementById('mode-badge');
        const labels = { classique:'ğŸ¯ CLASSIQUE', blitz:'âš¡ BLITZ', survie:'ğŸ’€ SURVIE', acceleration:'ğŸ”¥ ACCÃ‰LÃ‰RATION' };
        if (badge && STATE.modeJeu !== 'classique') {
          badge.textContent = labels[STATE.modeJeu] || '';
          badge.style.display = 'block';
        } else if (badge) badge.style.display = 'none';
      }
      mettreAJourEtat(msg);
      toast('ğŸ® La partie commence !');
      break;

    case 'nouveau_tour':
      stopChrono();
      STATE.joueurFautif = msg.joueur_fautif || null;
      if (document.getElementById('screen-jeu').classList.contains('hidden')) {
        afficherEcran('screen-jeu');
      }
      if (!document.getElementById('keyboard').children.length) construireClavier();
      // Avertissement Niger/Nigeria â€” affichÃ© pour tout le monde
      if (msg.sequence_est_pays) {
        const cEstMoi = msg.joueur_actuel === STATE.joueurId;
        const nomJoueur = msg.joueurs?.find(j => j.id === msg.joueur_actuel)?.nom || 'Le joueur';
        if (cEstMoi) {
          toast(`âš ï¸ "${msg.sequence_pays_nom}" est un pays ! Ajoute une lettre pour continuer ou donne ta langue au chat.`, 'warn');
        } else {
          toast(`ğŸ‘€ La sÃ©quence forme "${msg.sequence_pays_nom}" â€” ${nomJoueur} doit continuer ou dÃ©fendre !`, '');
        }
      }
      mettreAJourEtat(msg);
      STATE.nbTours++;
      // Mode accÃ©lÃ©ration : -1s par tour (min 3s)
      if (STATE.modeJeu === 'acceleration') {
        STATE.tempsMax = Math.max(3, (msg.config?.temps || STATE.tempsMax) - STATE.nbTours);
      }
      lancerChrono(STATE.tempsMax);
      // DÃ©lai langue au chat : 2s aprÃ¨s chaque nouveau tour
      if (STATE.modeConnecte) {
        const btnL = document.getElementById('btn-langue');
        if (btnL) {
          btnL.disabled = true;
          setTimeout(() => {
            if (STATE.estMonTour && (msg.sequence || '').length > 0) btnL.disabled = false;
          }, 2100);
        }
      }
      break;

    case 'sequence_invalide':
      jouerSon('erreur');
      stopChrono();
      STATE.joueurFautif = msg.joueur_fautif || null;
      mettreAJourEtat(msg);
      document.getElementById('letters-seq').classList.add('invalid');
      setTimeout(() => document.getElementById('letters-seq').classList.remove('invalid'), 600);
      // En multijoueur : animation secrÃ¨te, pas de message explicatif
      // Le bouton "langue au chat" du joueur suivant s'activera naturellement
      if (!STATE.modeConnecte) toast(`âš ï¸ ${msg.message}`, 'warn');
      break;

    case 'mot_complet':
      jouerSon('complet');
      stopChrono();
      document.querySelectorAll('.key').forEach(k => k.disabled = true);
      document.getElementById('btn-langue').disabled = true;
      mettreAJourEtat(msg);
      document.getElementById('letters-seq').classList.add('complete');
      ajouterDrapeau(msg.pays);
      toast(`ğŸ’€ ${msg.message}`, 'warn');
      break;

    case 'langue_au_chat':
      jouerSon('langue');
      stopChrono();
      document.querySelectorAll('.key').forEach(k => k.disabled = true);
      document.getElementById('btn-langue').disabled = true;
      mettreAJourEtat(msg);
      if (msg.interpelle === STATE.joueurId) {
        ouvrirModalLangueAuChat(msg.message, msg.delai || 20);
      } else {
        toast(`ğŸ—£ï¸ ${msg.message}`, 'warn');
      }
      break;

        case 'verdict_langue_au_chat':
      // Fermer tous les modaux langue au chat
      document.getElementById('modal-langue').classList.add('hidden');
      if (_lacCountdownInterval) { clearInterval(_lacCountdownInterval); _lacCountdownInterval = null; }
      afficherVerdict(msg);
      mettreAJourEtat(msg);
      break;

        case 'perte_vie':
      jouerSon('vie');
      stopChrono();
      // Fermer modal langue au chat si ouvert
      document.getElementById('modal-langue').classList.add('hidden');
      document.getElementById('modal-verdict').classList.add('hidden');
      if (_lacCountdownInterval) { clearInterval(_lacCountdownInterval); _lacCountdownInterval = null; }
      mettreAJourEtat(msg);
      toast(msg.message, msg.elimine ? 'error' : 'warn');
      break;

    case 'fin_partie':
      jouerSon('victoire');
      mettreAJourEtat(msg);
      afficherFinDePartie(msg);
      break;

    case 'chat':
      ajouterMessageChat(msg);
      break;

    case 'ia_langue_au_chat':
      toast(msg.message, 'warn');
      break;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOBBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function afficherLobby() {
  afficherEcran('screen-lobby');
  document.getElementById('lobby-code').textContent = STATE.roomId;
  const lien = `${window.location.href.split('?')[0]}?room=${STATE.roomId}`;
  document.getElementById('lien-partage').textContent = lien;
  // Remettre le lien visible (peut avoir Ã©tÃ© masquÃ© en solo)
  const lienWrap = document.querySelector('.link-share');
  if (lienWrap) lienWrap.style.display = '';
  mettreAJourBoutonsLobby();
  document.getElementById('chat-toggle-btn').classList.remove('hidden');
}

function mettreAJourBoutonsLobby() {
  const actions = document.getElementById('lobby-actions');
  const btnDemarrer = document.getElementById('btn-demarrer');

  // Supprimer bouton dynamique prÃ©cÃ©dent
  const old = document.getElementById('btn-lobby-action');
  if (old) old.remove();

  if (STATE.estCreateur) {
    // CrÃ©ateur : peut ajouter des bots + lancer
    const btn = document.createElement('button');
    btn.id = 'btn-lobby-action';
    btn.className = 'btn btn-secondary';
    btn.innerHTML = 'ğŸ¤– Ajouter un bot';
    btn.onclick = ajouterIA;
    actions.insertBefore(btn, btnDemarrer);
    btnDemarrer.style.display = '';
  } else {
    // InvitÃ© : peut quitter la salle
    const btn = document.createElement('button');
    btn.id = 'btn-lobby-action';
    btn.className = 'btn btn-secondary';
    btn.innerHTML = 'â† Quitter la salle';
    btn.onclick = () => {
      if (STATE.ws) { STATE.ws.close(); STATE.ws = null; }
      afficherEcran('screen-accueil');
      document.getElementById('chat-toggle-btn').classList.add('hidden');
    };
    actions.insertBefore(btn, btnDemarrer);
    btnDemarrer.style.display = 'none';
  }
}

function mettreAJourEtat(msg) {
  STATE.etat = msg;

  // Mettre Ã  jour lobby
  if (!document.getElementById('screen-lobby').classList.contains('hidden')) {
    mettreAJourLobby(msg);
  }

  // Mettre Ã  jour jeu
  if (!document.getElementById('screen-jeu').classList.contains('hidden')) {
    mettreAJourJeu(msg);
  }
}

function mettreAJourLobby(msg) {
  const joueurs = msg.joueurs || [];
  const grid = document.getElementById('players-grid');
  grid.innerHTML = '';

  const avatars = ['ğŸ§‘','ğŸ‘©','ğŸ§”','ğŸ‘±','ğŸ§•','ğŸ‘¨â€ğŸ’»','ğŸ§™','ğŸ¦Š'];
  joueurs.forEach((j, i) => {
    const div = document.createElement('div');
    div.className = 'player-slot filled';
    // ReconnaÃ®tre "moi" mÃªme si l'UUID n'est pas encore synchronisÃ©
    const estMoi = j.id === STATE.joueurId || (!j.est_ia && j.nom === STATE.nom);
    div.innerHTML = `
      <div class="slot-avatar">${j.est_ia ? 'ğŸ¤–' : avatars[i % avatars.length]}</div>
      <div class="slot-name">${escapeHtml(j.nom)}</div>
      <div class="slot-tag">${j.est_ia ? 'BOT' : estMoi ? 'MOI' : 'EN LIGNE'}</div>
    `;
    grid.appendChild(div);
  });

  // Slots vides
  const max = msg.config?.max_joueurs || 4;
  for (let i = joueurs.length; i < max; i++) {
    const div = document.createElement('div');
    div.className = 'player-slot';
    div.innerHTML = `<div class="slot-avatar" style="opacity:.2">ğŸ‘¤</div><div class="slot-name" style="opacity:.2;font-size:11px">En attenteâ€¦</div>`;
    grid.appendChild(div);
  }
}

async function ajouterIA() {
  if (STATE.ws) {
    try {
      await fetch(`${SERVEUR_HTTP}/parties/${STATE.roomId}/ia`, { method: 'POST' });
    } catch { toast('Serveur indisponible', 'error'); }
  } else {
    // Mode solo â€” ajouter IA locale
    ajouterIALocale();
  }
}

async function demarrerPartie() {
  if (STATE.modeConnecte && STATE.ws) {
    // Mode multijoueur â€” envoyer au serveur, ne JAMAIS lancer en solo
    try {
      const r = await fetch(
        `${SERVEUR_HTTP}/parties/${STATE.roomId}/demarrer?joueur_id=${STATE.joueurId}`,
        { method: 'POST', signal: AbortSignal.timeout(5000) }
      );
      if (!r.ok) {
        const err = await r.json().catch(() => ({}));
        toast(`Erreur : ${err.detail || r.status}`, 'error');
      }
      // Le serveur diffuse "partie_demarree" Ã  tous via WS â†’ pas besoin d'action ici
    } catch (e) {
      toast('Erreur serveur â€” rÃ©essaie', 'error');
    }
  } else if (!STATE.modeConnecte) {
    // Mode solo uniquement si on n'est vraiment pas connectÃ©
    demarrerSolo();
  }
}

function copierLien() {
  const lien = document.getElementById('lien-partage').textContent;
  navigator.clipboard.writeText(lien).then(() => toast('ğŸ”— Lien copiÃ© !'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MISE Ã€ JOUR DE L'INTERFACE DE JEU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mettreAJourJeu(msg) {
  const seq = msg.sequence || '';
  const monTour = msg.joueur_actuel === STATE.joueurId;
  debugLog(`ğŸ® mettreAJourJeu | monId=${STATE.joueurId.slice(0,8)} | actuel=${msg.joueur_actuel?.slice(0,8)} | monTour=${monTour} | connectÃ©=${STATE.modeConnecte}`);

  // SÃ©quence
  const el = document.getElementById('letters-seq');
  el.textContent = seq ? seq.split('').join(' - ') : 'â€¦';
  el.className = 'letters-sequence';

  // Indicateur de tour
  STATE.estMonTour = monTour;
  document.getElementById('turn-indicator').textContent =
    monTour ? 'â¬‡ Ton tour !' :
    msg.joueurs?.find(j => j.id === msg.joueur_actuel)
      ? `Tour de ${msg.joueurs.find(j => j.id === msg.joueur_actuel).nom}`
      : '';

  // Activer/dÃ©sactiver clavier â€” gÃ©rÃ© par activerClavier() en mode solo
  // En mode connectÃ©, on l'applique ici directement
  if (STATE.modeConnecte) {
    // Lire joueur_fautif depuis le snapshot serveur (field ajoutÃ© dans serveur corrigÃ©)
    if ('joueur_fautif' in msg) STATE.joueurFautif = msg.joueur_fautif;
    document.querySelectorAll('.key').forEach(k => k.disabled = !monTour);
    const seqEnCours = (msg.sequence || '').length > 0;
    const jeSuisFautif = STATE.joueurFautif === STATE.joueurId;
    document.getElementById('btn-langue').disabled = !(monTour && seqEnCours && !jeSuisFautif);
  }

  // PossibilitÃ©s â€” visible uniquement en solo
  if (seq && !STATE.modeConnecte) {
    const poss = chercherPossibilites(seq);
    document.getElementById('poss-count').textContent =
      poss.length ? `${poss.length} pays possible${poss.length > 1 ? 's' : ''}` : '';
  } else {
    document.getElementById('poss-count').textContent = '';
  }

  // Scores
  mettreAJourScores(msg);
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOUVELLES FONCTIONS DESIGN â€” avatars, sliders, VS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Avatars sÃ©lectionnÃ©s par Ã©cran
const AVATARS_CHOISIS = { solo: 'ğŸ§‘â€ğŸš€', creer: 'ğŸ§‘â€ğŸš€' };

function pickAvatar(btn, ecran) {
  const grid = document.getElementById(ecran + '-avatar-grid');
  grid.querySelectorAll('.av-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  AVATARS_CHOISIS[ecran] = btn.dataset.av;
  // Mettre Ã  jour l'avatar dans STATE si on est en jeu
  if (ecran === 'solo' || ecran === 'creer') {
    STATE.avatar = btn.dataset.av;
  }
}

function onSlider(input, lblId, hiddenId) {
  const v = parseInt(input.value);
  const min = parseInt(input.min), max = parseInt(input.max);
  const pct = ((v - min) / (max - min) * 100).toFixed(1) + '%';
  input.style.setProperty('--fill', pct);
  document.getElementById(lblId).textContent = v + 's';
  document.getElementById(hiddenId).value = v;
}

let _maxJoueurs = 4;
function changeMax(delta) {
  _maxJoueurs = Math.max(2, Math.min(8, _maxJoueurs + delta));
  document.getElementById('creer-max-val').textContent = _maxJoueurs;
  document.getElementById('creer-max').value = _maxJoueurs;
}

// â”€â”€ VS Header â€” mise Ã  jour complÃ¨te â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _renderHearts(containerId, vies, viesMax) {
  const el = document.getElementById(containerId);
  if (!el) return;
  // max affichÃ© : 10 cÅ“urs
  const affMax = Math.min(viesMax, 10);
  let html = '';
  for (let i = 0; i < affMax; i++) {
    const perdu = i >= vies;
    html += `<span class="hrt${perdu ? ' lost' : ''}">â¤ï¸</span>`;
  }
  // Si > 10 vies, afficher le chiffre
  if (viesMax > 10) {
    html = `<span style="font-family:'Bebas Neue',cursive;font-size:16px;color:var(--orange)">${vies}</span><span class="hrt" style="font-size:12px">â¤ï¸</span>`;
  }
  el.innerHTML = html;
}

function _setVSPlayer(side, joueur, isActive, viesMax) {
  if (!joueur) return;
  const avEl    = document.getElementById('vsp-av-' + side);
  const nameEl  = document.getElementById('vsp-name-' + side);
  const hrtsId  = 'vsp-hearts-' + side;

  // Avatar : utiliser l'avatar du STATE si c'est moi, sinon emoji basique
  let av = joueur.est_ia ? 'ğŸ¤–' : (joueur.id === STATE.joueurId ? (STATE.avatar || 'ğŸ§‘â€ğŸš€') : 'ğŸ§‘');
  if (avEl) {
    avEl.textContent = av;
    avEl.classList.toggle('active', isActive);
  }
  if (nameEl) nameEl.textContent = joueur.nom;
  _renderHearts(hrtsId, joueur.vies, viesMax);
}

function mettreAJourScores(msg) {
  const joueurs  = msg.joueurs || [];
  const viesMax  = msg.config?.vies || 10;
  const actuelId = msg.joueur_actuel;

  // â”€â”€ 2 joueurs ou moins : layout VS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (joueurs.length <= 2) {
    const j0 = joueurs[0], j1 = joueurs[1];
    _setVSPlayer('left',  j0, j0?.id === actuelId, viesMax);
    _setVSPlayer('right', j1 || null, j1?.id === actuelId, viesMax);
    document.getElementById('extra-strip')?.classList.add('hidden');

  } else {
    // â”€â”€ 3+ joueurs : premiers en VS, reste en chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const j0 = joueurs[0], j1 = joueurs[1];
    _setVSPlayer('left',  j0, j0?.id === actuelId, viesMax);
    _setVSPlayer('right', j1, j1?.id === actuelId, viesMax);

    const extra = document.getElementById('extra-strip');
    if (extra) {
      extra.classList.remove('hidden');
      extra.innerHTML = joueurs.slice(2).map(j => {
        const act = j.id === actuelId;
        const cls = 'extra-chip' + (act ? ' active' : '');
        return `<div class="${cls}"><span>${j.est_ia ? 'ğŸ¤–' : 'ğŸ§‘'}</span><span style="font-size:12px;font-weight:700">${escapeHtml(j.nom)}</span><span style="font-family:'Bebas Neue',cursive;color:var(--orange)">${j.vies}â¤</span></div>`;
      }).join('');
    }
  }

  // â”€â”€ BanniÃ¨re "En danger" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const danger = document.getElementById('danger-banner');
  if (danger) {
    // Trouver le joueur avec le moins de vies parmi les vivants
    const vivants = joueurs.filter(j => j.en_vie !== false);
    const enDanger = vivants.find(j => j.vies === 1);
    if (enDanger) {
      danger.classList.remove('hidden');
      document.getElementById('danger-text').textContent = `En danger : ${enDanger.nom}`;
    } else {
      danger.classList.add('hidden');
    }
  }
}

// â”€â”€ Passeport â€” remplace les drapeaux â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ajouterDrapeau(pays, valeurJouee = null) {
  // Afficher le passeport
  const wrap = document.getElementById('passeport-wrap');
  if (wrap) wrap.style.display = '';

  // Aussi alimenter le flags-inner cachÃ© (compat legacy)
  const inner = document.getElementById('flags-inner');

  const row = document.getElementById('stamps-row');
  if (!row) return;

  const stamp = document.createElement('div');
  stamp.className = 'stamp';

  const label = (valeurJouee && valeurJouee !== pays.nom)
    ? valeurJouee : pays.nom;

  stamp.innerHTML = `
    <div class="stamp-ring">
      <img src="https://flagcdn.com/w80/${pays.code}.png" alt="${pays.nom}"
           onerror="this.style.display='none'">
    </div>
    <div class="stamp-name">${label}</div>
  `;

  row.appendChild(stamp);
  // Scroll au dernier tampon
  row.parentElement.scrollLeft = row.scrollWidth;

  // Petit effet d'entrÃ©e
  stamp.style.opacity = '0';
  stamp.style.transform = 'scale(0.6) rotate(-8deg)';
  stamp.style.transition = 'all .35s cubic-bezier(0.34,1.56,0.64,1)';
  requestAnimationFrame(() => {
    stamp.style.opacity = '1';
    stamp.style.transform = 'scale(1) rotate(0deg)';
  });
}

// â”€â”€ Surcharge actualiserChrono pour le nouveau design â”€â”€â”€â”€â”€â”€â”€â”€
const _origActualiserChrono = typeof actualiserChrono !== 'undefined' ? actualiserChrono : null;

function actualiserChrono() {
  const pct = (STATE.tempsRestant / STATE.tempsMax) * 100;
  const urgent = STATE.tempsRestant <= 5;

  // Barre mÃ¨che
  const fill = document.getElementById('chrono-fill');
  if (fill) {
    fill.style.width = pct + '%';
    fill.classList.toggle('urgent', urgent);
  }

  // Chiffre VS header
  const val = document.getElementById('chrono-val');
  if (val) {
    val.textContent = STATE.tempsRestant;
    val.classList.toggle('urgent', urgent);
  }

  // Compat : pill cachÃ©
  const pill = document.getElementById('chrono-pill');
  const valPill = document.getElementById('chrono-val-pill');
  if (pill) pill.classList?.toggle('urgent', urgent);
  if (valPill) valPill.textContent = STATE.tempsRestant;
}

// â”€â”€ Surcharge mettreAJourLobby pour afficher les avatars â”€â”€â”€â”€â”€
const _origMettreAJourLobby = typeof mettreAJourLobby !== 'undefined' ? mettreAJourLobby : null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FONCTIONS EXISTANTES CONSERVÃ‰ES (patching init)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Injecter avatar dans STATE au lancement solo
const _origLancerSolo = lancerSolo;
lancerSolo = function() {
  STATE.avatar = AVATARS_CHOISIS.solo || 'ğŸ§‘â€ğŸš€';
  // Lire le temps depuis le hidden input (slider)
  const tempsHidden = document.getElementById('solo-temps');
  if (tempsHidden) {
    const modeEl = document.getElementById('solo-mode');
    const mode = modeEl ? modeEl.value : 'classique';
    if (mode !== 'blitz') STATE.tempsMax = parseInt(tempsHidden.value) || 15;
  }
  _origLancerSolo();
};

const _origCreerPartie = creerPartie;
creerPartie = async function() {
  STATE.avatar = AVATARS_CHOISIS.creer || 'ğŸ§‘â€ğŸš€';
  const tempsHidden = document.getElementById('creer-temps');
  if (tempsHidden) STATE.tempsMax = parseInt(tempsHidden.value) || 15;
  await _origCreerPartie();
};



function construireClavier() {
  const kb = document.getElementById('keyboard');
  kb.innerHTML = '';
  ['AZERTYUIOP', 'QSDFGHJKLM', 'WXCVBN'].forEach(rangee => {
    const row = document.createElement('div');
    row.className = 'kb-row';
    rangee.split('').forEach(l => {
      const btn = document.createElement('button');
      btn.className = 'key';
      btn.textContent = l;
      btn.dataset.lettre = l;
      btn.disabled = false;
      btn.onclick = () => appuyerTouche(l);
      row.appendChild(btn);
    });
    kb.appendChild(row);
  });
}

function appuyerTouche(lettre) {
  jouerSon('touche');
  debugLog(`âŒ¨ï¸ appuyerTouche(${lettre}) | estMonTour=${STATE.estMonTour} | connectÃ©=${STATE.modeConnecte}`);
  if (!STATE.estMonTour) return;

  if (STATE.modeConnecte) {
    // Verrouiller immÃ©diatement pour Ã©viter double-envoi (latence rÃ©seau)
    STATE.estMonTour = false;
    document.querySelectorAll('.key').forEach(k => k.disabled = true);
    envoyerWS({ action: 'lettre', lettre });
  } else {
    traiterLettreLocal(lettre);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHRONO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function lancerChrono(secondes) {
  clearInterval(STATE.chronoInterval);
  STATE.tempsRestant = secondes;
  STATE.tempsMax = secondes;
  actualiserChrono();

  STATE.chronoInterval = setInterval(() => {
    STATE.tempsRestant--;
    actualiserChrono();
    if (STATE.tempsRestant <= 0) {
      clearInterval(STATE.chronoInterval);
      if (!STATE.modeConnecte && STATE.estMonTour) {
        // Mode solo â€” temps Ã©coulÃ©
        perdreVieLocal('â° Temps Ã©coulÃ© !');
      }
    }
  }, 1000);
}

function actualiserChrono() {
  const pct = (STATE.tempsRestant / STATE.tempsMax) * 100;
  const urgent = STATE.tempsRestant <= 5;

  // Barre de progression
  const fill = document.getElementById('chrono-fill');
  fill.style.width = pct + '%';
  fill.classList.toggle('urgent', urgent);

  // Pill sablier
  const pill = document.getElementById('chrono-pill');
  const val  = document.getElementById('chrono-val');
  if (pill) {
    pill.classList.toggle('urgent', urgent);
    if (val) val.textContent = STATE.tempsRestant;
  }

  // Sablier tourne vite si urgent
  const hg = document.getElementById('hourglass-display');
  if (hg) hg.style.animationDuration = urgent ? '0.5s' : '3s';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LANGUE AU CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function demanderLangueAuChat() {
  if (STATE.modeConnecte) {
    envoyerWS({ action: 'langue_au_chat' });
  } else {
    demanderLangueAuChatLocal();
  }
}

let _lacCountdownInterval = null;

function ouvrirModalLangueAuChat(texte, delai) {
  document.getElementById('modal-langue-text').textContent = texte || 'Quel pays avais-tu en tÃªte ?';
  document.getElementById('modal-langue-input').value = '';
  document.getElementById('modal-langue').classList.remove('hidden');
  setTimeout(() => document.getElementById('modal-langue-input').focus(), 100);

  // Lancer le compte Ã  rebours
  const totalSec = delai || 20;
  let restant = totalSec;
  const elNum = document.getElementById('lac-countdown');
  const elBar = document.getElementById('lac-progress');

  if (_lacCountdownInterval) clearInterval(_lacCountdownInterval);

  function majCountdown() {
    if (elNum) {
      elNum.textContent = restant;
      elNum.style.color = restant <= 5 ? 'var(--crimson)' : restant <= 10 ? 'var(--amber)' : 'var(--teal)';
    }
    if (elBar) elBar.style.width = (restant / totalSec * 100) + '%';
  }
  majCountdown();

  _lacCountdownInterval = setInterval(() => {
    restant--;
    majCountdown();
    if (restant <= 0) {
      clearInterval(_lacCountdownInterval);
      // Le serveur va Ã©liminer automatiquement â€” on ferme juste le modal
      document.getElementById('modal-langue').classList.add('hidden');
    }
  }, 1000);
}

function validerLangueAuChat() {
  const pays = document.getElementById('modal-langue-input').value.trim();
  if (!pays) return;
  document.getElementById('modal-langue').classList.add('hidden');
  if (_lacCountdownInterval) { clearInterval(_lacCountdownInterval); _lacCountdownInterval = null; }

  if (STATE.modeConnecte) {
    envoyerWS({ action: 'reponse_langue_au_chat', pays });
  } else {
    evaluerReponseLocal(pays);
  }
}

function afficherVerdict(msg) {
  document.getElementById('verdict-emoji').textContent = msg.valide ? 'âœ…' : 'ğŸ˜‚';
  document.getElementById('verdict-title').textContent = msg.valide ? 'Bravo !' : "C'est Nul ğŸ˜‚";
  document.getElementById('verdict-text').textContent = msg.message;
  document.getElementById('modal-verdict').classList.remove('hidden');
}

function fermerVerdict() {
  document.getElementById('modal-verdict').classList.add('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleChat() {
  const panel = document.getElementById('chat-panel');
  panel.classList.toggle('open');
  document.getElementById('chat-notif').classList.remove('show');
  // Afficher/masquer la barre emojis en jeu
  const emojiBar = document.getElementById('emoji-bar');
  const enJeu = !document.getElementById('screen-jeu').classList.contains('hidden');
  if (emojiBar) emojiBar.style.display = panel.classList.contains('open') && enJeu ? 'flex' : 'none';
}

const EMOJIS_RAPIDES = ['ğŸ˜‚','ğŸ‘','ğŸ”¥','ğŸ’€','ğŸ˜±','ğŸ¤”','ğŸ‘','ğŸ˜®','ğŸ‰','ğŸ˜¤','ğŸ™Œ','ğŸ‘€'];

function construireBarreEmojis() {
  const bar = document.getElementById('emoji-bar');
  if (!bar) return;
  // Conserver le label
  const label = bar.children[0];
  bar.innerHTML = '';
  bar.appendChild(label);
  EMOJIS_RAPIDES.forEach(e => {
    const btn = document.createElement('button');
    btn.textContent = e;
    btn.style.cssText = 'background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:4px 6px;font-size:18px;cursor:pointer;transition:transform .1s';
    btn.onmouseenter = () => btn.style.transform = 'scale(1.2)';
    btn.onmouseleave = () => btn.style.transform = '';
    btn.onclick = () => envoyerEmojiRapide(e);
    bar.appendChild(btn);
  });
}

function envoyerEmoji() {
  // Ouvre un picker emoji simplifiÃ©
  const bar = document.getElementById('emoji-bar');
  if (!bar) return;
  const visible = bar.style.display !== 'none' && bar.style.display !== '';
  bar.style.display = visible ? 'none' : 'flex';
  if (!visible && bar.children.length <= 1) construireBarreEmojis();
}

function envoyerEmojiRapide(emoji) {
  jouerSon('emoji');
  const heure = new Date().toLocaleTimeString('fr', {hour:'2-digit',minute:'2-digit'});
  if (STATE.modeConnecte) {
    envoyerWS({ action: 'chat', texte: emoji });
  } else {
    ajouterMessageChat({
      joueur_id: STATE.joueurId,
      nom: STATE.nom,
      texte: emoji,
      heure
    });
  }
}

function envoyerChat() {
  const input = document.getElementById('chat-input');
  const texte = input.value.trim();
  if (!texte) return;
  input.value = '';
  const heure = new Date().toLocaleTimeString('fr', {hour:'2-digit',minute:'2-digit'});
  if (STATE.modeConnecte) {
    envoyerWS({ action: 'chat', texte });
  } else {
    // Mode solo : afficher le message localement
    ajouterMessageChat({ joueur_id: STATE.joueurId, nom: STATE.nom, texte, heure });
  }
}

function ajouterMessageChat(msg) {
  const el = document.getElementById('chat-messages');
  const div = document.createElement('div');
  const estMoi = msg.joueur_id === STATE.joueurId;
  // DÃ©tecter si c'est un emoji seul (rÃ©action rapide)
  const estEmoji = msg.texte && [...msg.texte].length === 1 &&
    /\p{Emoji}/u.test(msg.texte);

  if (msg.joueur_id) {
    div.className = 'chat-msg' + (estMoi ? ' moi' : '');
    if (estEmoji) {
      div.innerHTML = `<div class="msg-author">${escapeHtml(msg.nom)} Â· ${msg.heure}</div>
        <div style="font-size:32px;line-height:1.2">${escapeHtml(msg.texte)}</div>`;
    } else {
      div.innerHTML = `<div class="msg-author">${escapeHtml(msg.nom)} Â· ${msg.heure}</div>
        <div class="msg-text">${escapeHtml(msg.texte)}</div>`;
    }
  } else {
    div.className = 'chat-msg system';
    div.innerHTML = `<div class="msg-text">${msg.message || escapeHtml(msg.texte || '')}</div>`;
  }

  el.appendChild(div);
  el.scrollTop = el.scrollHeight;

  // Notif si panel fermÃ©
  if (!document.getElementById('chat-panel').classList.contains('open')) {
    document.getElementById('chat-notif').classList.add('show');
    // Si emoji reÃ§u en jeu : afficher un toast flottant rapide
    if (estEmoji && msg.joueur_id && !estMoi) {
      toast(`${msg.nom} : ${msg.texte}`, '');
    }
  }
}

function escapeHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODE SOLO (sans serveur) â€” IA locale
//  RÃ©Ã©criture complÃ¨te et fidÃ¨le Ã  main.py
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Ã‰tat solo â€” miroir des attributs self.* de PaysGameApp
let SOLO = {
  joueurs:      [],
  indexTour:    0,
  sequence:     '',
  paysJoues:    new Set(),
  paysJouesList:[],
  joueurFautif: null,
  viesDepart:   10,
};

// â”€â”€ _lancer_mode_solo() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lancerModeSolo(viesParam) {
  const vies = viesParam || parseInt(document.getElementById('solo-vies')?.value) || 10;
  STATE.modeConnecte = false;
  STATE.nbTours      = 0;
  // tempsMax et modeMixte dÃ©jÃ  dÃ©finis par lancerSolo() ou STATE
  if (!STATE.tempsMax) STATE.tempsMax = 15;

  SOLO.viesDepart    = vies;
  SOLO.joueurs       = [
    { id: STATE.joueurId, nom: STATE.nom || 'Joueur', vies, en_vie: true, est_ia: false },
    { id: 'ia', nom: 'ğŸ¤– Ordinateur', vies, en_vie: true, est_ia: true },
  ];
  SOLO.indexTour     = 0;
  SOLO.sequence      = '';
  SOLO.paysJoues     = new Set();
  SOLO.paysJouesList = [];
  SOLO.joueurFautif  = null;

  afficherEcran('screen-lobby');
  document.getElementById('lobby-code').textContent = 'SOLO';

  // Masquer le lien de partage en solo (pas de sens)
  const lienWrap = document.querySelector('.link-share');
  if (lienWrap) lienWrap.style.display = 'none';

  // Bouton dÃ©marrer
  const btnDem = document.getElementById('btn-demarrer');
  btnDem.style.display = '';
  btnDem.onclick = demarrerSolo;

  // Bouton "Ajouter bot" en solo (crÃ©er dynamiquement)
  const actions = document.getElementById('lobby-actions');
  const oldBtn = document.getElementById('btn-lobby-action');
  if (oldBtn) oldBtn.remove();
  const btnBot = document.createElement('button');
  btnBot.id = 'btn-lobby-action';
  btnBot.className = 'btn btn-secondary';
  btnBot.innerHTML = 'ğŸ¤– Ajouter un bot';
  btnBot.onclick = ajouterIALocale;
  actions.insertBefore(btnBot, btnDem);

  // Masquer le chat en solo (pas de serveur)
  document.getElementById('chat-toggle-btn').classList.add('hidden');

  mettreAJourLobbyLocal();
}

// â”€â”€ _ajouter_ia_locale() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ajouterIALocale() {
  if (SOLO.joueurs.length >= 4) return;
  SOLO.joueurs.push({
    id: `ia${SOLO.joueurs.length}`,
    nom: 'ğŸ¤– Bot',
    vies: SOLO.viesDepart,
    en_vie: true,
    est_ia: true,
  });
  mettreAJourLobbyLocal();
}

function mettreAJourLobbyLocal() {
  mettreAJourLobby({ joueurs: SOLO.joueurs, config: { max_joueurs: 4 } });
}

// â”€â”€ _demarrer_solo() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function demarrerSolo() {
  document.getElementById('flags-inner').innerHTML = '';
  afficherEcran('screen-jeu');
  construireClavier();
  // Afficher badge mode
  const badge = document.getElementById('mode-badge');
  const labels = { classique:'ğŸ¯ CLASSIQUE', blitz:'âš¡ BLITZ', survie:'ğŸ’€ SURVIE', acceleration:'ğŸ”¥ ACCÃ‰LÃ‰RATION' };
  if (badge && STATE.modeJeu !== 'classique') {
    badge.textContent = labels[STATE.modeJeu] || '';
    badge.style.display = 'block';
  } else if (badge) badge.style.display = 'none';
  nouveauTourSolo(true);
}

// â”€â”€ _joueur_actuel_solo() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function joueurActuelSolo() {
  return SOLO.joueurs[SOLO.indexTour];
}

// â”€â”€ _nouveau_tour_solo(reset_sequence) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nouveauTourSolo(reset) {
  if (reset === undefined) reset = true;
  if (reset) {
    SOLO.sequence     = '';
    SOLO.joueurFautif = null;
  }
  STATE.nbTours++;

  const j = joueurActuelSolo();
  STATE.estMonTour = (j.id === STATE.joueurId);

  mettreAJourJeu({
    sequence:      SOLO.sequence,
    joueur_actuel: j.id,
    joueurs:       SOLO.joueurs,
    config:        { vies: SOLO.viesDepart },
  });
  // Mode accÃ©lÃ©ration : -1s par tour (min 3s)
  if (STATE.modeJeu === 'acceleration') {
    STATE.tempsMax = Math.max(3, (SOLO.tempsDepart || 15) - STATE.nbTours);
  }
  lancerChrono(STATE.tempsMax);

  if (j.est_ia) {
    activerClavier(false);
    setTimeout(iaJouerSolo, 1000 + Math.random() * 1200);
  } else {
    activerClavier(true);
  }
}

// â”€â”€ _activer_clavier(actif) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function activerClavier(actif) {
  document.querySelectorAll('.key').forEach(k => { k.disabled = !actif; });
  const languePossible = actif
    && SOLO.sequence.length > 0
    && SOLO.joueurFautif !== STATE.joueurId;
  document.getElementById('btn-langue').disabled = !languePossible;
}

// â”€â”€ _traiter_lettre_solo(lettre) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function traiterLettreLocal(lettre) {
  if (!STATE.estMonTour) return;

  const nouvelleSeq  = normaliser(SOLO.sequence) + normaliser(lettre);
  const possibilites = soloChercherPossibilites(nouvelleSeq);

  if (possibilites.length === 0) {
    jouerSon('erreur');
    flashSequence('invalid');
    SOLO.sequence     = nouvelleSeq;
    SOLO.joueurFautif = STATE.joueurId;
    mettreAJourJeu({
      sequence: nouvelleSeq, joueur_actuel: STATE.joueurId,
      joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart },
    });
    toast("âš ï¸ SÃ©quence invalide â€” l'IA peut demander une langue au chat", 'warn');
    passerAuSuivantSolo();
    return;
  }

  SOLO.sequence = nouvelleSeq;
  const match   = soloEstComplet(nouvelleSeq);

  if (match) {
    if (SOLO.paysJoues.has(match.nom_normalise)) {
      toast(`ğŸ” ${match.nom} dÃ©jÃ  jouÃ© ! Tu perds une vie.`, 'error');
      stopChrono();
      setTimeout(() => perdreVieSolo(STATE.joueurId, 'Pays dÃ©jÃ  jouÃ©'), 500);
      return;
    }
    const valeur = soloValeurJouee(match, nouvelleSeq);
    SOLO.paysJoues.add(match.nom_normalise);
    SOLO.paysJouesList.push({ ...match, _valeur_jouee: valeur });
    ajouterDrapeau(match, valeur);
    flashSequence('complete');
    toast(`ğŸ’€ Tu as complÃ©tÃ© Â« ${valeur} Â» â€” tu perds une vie !`, 'warn');
    stopChrono();
    setTimeout(() => perdreVieSolo(STATE.joueurId, 'Mot complet'), 1500);
  } else {
    mettreAJourJeu({
      sequence: nouvelleSeq, joueur_actuel: STATE.joueurId,
      joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart },
    });
    passerAuSuivantSolo();
  }
}

// â”€â”€ _ia_jouer_solo() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function iaJouerSolo() {
  // VÃ©rifier que c'est encore le tour de l'IA
  const j = joueurActuelSolo();
  if (!j || !j.est_ia) return;

  const seqNorm      = normaliser(SOLO.sequence);
  const possibilites = soloChercherPossibilites(seqNorm);

  if (possibilites.length === 0) {
    if (SOLO.joueurFautif === STATE.joueurId) {
      ouvrirModalLangueAuChat("L'IA te demande : quel pays visais-tu ?");
    } else {
      toast("ğŸ¤– L'IA donne sa langue au chat ! Elle perd une vie.", 'warn');
      stopChrono();
      perdreVieSolo('ia', 'IA piÃ©gÃ©e');
    }
    return;
  }

  const nonJoues = possibilites.filter(p => !SOLO.paysJoues.has(p.nom_normalise));

  if (nonJoues.length === 0) {
    toast("ğŸ¤– L'IA est piÃ©gÃ©e (tous les pays dÃ©jÃ  jouÃ©s) ! Elle perd une vie.", 'warn');
    stopChrono();
    perdreVieSolo('ia', 'Tous pays jouÃ©s');
    return;
  }

  const longues = nonJoues.filter(p => p[p._cible].length > seqNorm.length + 1);
  const cibles  = longues.length > 0 ? longues : nonJoues;
  const cible   = cibles[Math.floor(Math.random() * cibles.length)];

  const lettreSuivante = cible[cible._cible][seqNorm.length];
  const nouvelleSeq    = seqNorm + lettreSuivante;

  SOLO.sequence     = nouvelleSeq;
  SOLO.joueurFautif = 'ia';

  const match = soloEstComplet(nouvelleSeq);
  if (match) {
    if (SOLO.paysJoues.has(match.nom_normalise)) {
      toast(`ğŸ” L'IA a jouÃ© ${match.nom} dÃ©jÃ  jouÃ© ! Elle perd une vie.`, 'warn');
      stopChrono();
      setTimeout(() => perdreVieSolo('ia', 'Pays dÃ©jÃ  jouÃ©'), 500);
      return;
    }
    const valeur = soloValeurJouee(match, nouvelleSeq);
    SOLO.paysJoues.add(match.nom_normalise);
    SOLO.paysJouesList.push({ ...match, _valeur_jouee: valeur });
    ajouterDrapeau(match, valeur);
    mettreAJourJeu({
      sequence: nouvelleSeq, joueur_actuel: 'ia',
      joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart },
    });
    flashSequence('complete');
    toast(`ğŸ’€ L'IA a complÃ©tÃ© Â« ${valeur} Â» â€” elle perd une vie !`, 'warn');
    stopChrono();
    setTimeout(() => perdreVieSolo('ia', 'Mot complet'), 1500);
  } else {
    mettreAJourJeu({
      sequence: nouvelleSeq, joueur_actuel: 'ia',
      joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart },
    });
    passerAuSuivantSolo();
  }
}

// â”€â”€ _demander_langue_locale() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function demanderLangueAuChatLocal() {
  stopChrono();
  const seqNorm      = normaliser(SOLO.sequence);
  const possibilites = soloChercherPossibilites(seqNorm).filter(
    p => p[p._cible].startsWith(seqNorm) && !SOLO.paysJoues.has(p.nom_normalise)
  );
  setTimeout(() => {
    if (possibilites.length > 0) {
      const pays   = possibilites[Math.floor(Math.random() * possibilites.length)];
      const valeur = pays._cible === 'nom_normalise' ? pays.nom : pays.capitale;
      SOLO.paysJoues.add(pays.nom_normalise);
      SOLO.paysJouesList.push({ ...pays, _valeur_jouee: valeur });
      ajouterDrapeau(pays, valeur);
      afficherVerdict({ valide: true, message: `L'IA visait Â« ${valeur} Â» (${SOLO.sequence}â€¦). Valide ! Tu perds une vie.` });
      setTimeout(() => { fermerVerdict(); perdreVieSolo(STATE.joueurId, 'Langue au chat perdue'); }, 2000);
    } else {
      afficherVerdict({ valide: false, message: `L'IA ne peut pas justifier Â« ${SOLO.sequence} Â» ! Elle perd une vie.` });
      setTimeout(() => { fermerVerdict(); perdreVieSolo('ia', 'IA sans rÃ©ponse'); }, 2000);
    }
  }, 800);
}

// â”€â”€ _evaluer_reponse_locale(pays_propose) â”€â”€â”€â”€â”€â”€â”€â”€â”€
function evaluerReponseLocal(paysPropose) {
  const norm    = normaliser(paysPropose);
  const seqNorm = normaliser(SOLO.sequence);

  let match      = PAYS_LOCAL ? (PAYS_LOCAL.find(p => p.nom_normalise === norm) || null) : null;
  let champMatch = 'nom_normalise';
  let valeurAff  = paysPropose;

  if (!match && STATE.modeMixte && PAYS_LOCAL) {
    match = PAYS_LOCAL.find(p => p.capitale_normalisee === norm) || null;
    if (match) { champMatch = 'capitale_normalisee'; valeurAff = match.capitale || paysPropose; }
  }

  if (!match) {
    afficherVerdict({ valide: false, message: `Â« ${paysPropose} Â» n'existe pas ! Tu perds une vie.` });
    setTimeout(() => { fermerVerdict(); perdreVieSolo(STATE.joueurId, 'Pays inexistant'); }, 2000);
  } else if (SOLO.paysJoues.has(match.nom_normalise)) {
    afficherVerdict({ valide: false, message: `Â« ${valeurAff} Â» a dÃ©jÃ  Ã©tÃ© jouÃ© ! Tu perds une vie.` });
    setTimeout(() => { fermerVerdict(); perdreVieSolo(STATE.joueurId, 'Pays dÃ©jÃ  jouÃ©'); }, 2000);
  } else if (!match[champMatch].startsWith(seqNorm)) {
    afficherVerdict({ valide: false, message: `Â« ${valeurAff} Â» ne commence pas par Â« ${SOLO.sequence} Â» ! Tu perds une vie.` });
    setTimeout(() => { fermerVerdict(); perdreVieSolo(STATE.joueurId, 'Pays incohÃ©rent'); }, 2000);
  } else {
    SOLO.paysJoues.add(match.nom_normalise);
    SOLO.paysJouesList.push({ ...match, _valeur_jouee: valeurAff });
    ajouterDrapeau(match, valeurAff);
    afficherVerdict({ valide: true, message: `âœ… Â« ${valeurAff} Â» commence bien par Â« ${SOLO.sequence} Â» ! L'IA perd une vie.` });
    setTimeout(() => { fermerVerdict(); perdreVieSolo('ia', 'Langue au chat perdue'); }, 2000);
  }
}

// â”€â”€ _perdre_vie_solo(joueur_id, raison) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function perdreVieLocal(raison) { perdreVieSolo(STATE.joueurId, raison); }

function perdreVieSolo(joueurId, raison) {
  stopChrono();
  const j = SOLO.joueurs.find(x => x.id === joueurId);
  if (!j) return;

  j.vies--;
  if (j.vies <= 0) { j.vies = 0; j.en_vie = false; toast(`ğŸ˜‚ ${j.nom} est OUTTT !`, 'error'); }

  mettreAJourScores({
    sequence: SOLO.sequence, joueur_actuel: null,
    joueurs: SOLO.joueurs, config: { vies: SOLO.viesDepart },
  });

  const vivants = SOLO.joueurs.filter(x => x.en_vie);
  if (vivants.length <= 1) {
    setTimeout(() => afficherFinDePartieLocal(vivants[0] || null), 800);
    return;
  }

  const idxJ = SOLO.joueurs.indexOf(j);
  if (j.en_vie) {
    SOLO.indexTour = idxJ;
  } else {
    const n = SOLO.joueurs.length;
    let idx = idxJ;
    for (let i = 0; i < n; i++) { idx = (idx + 1) % n; if (SOLO.joueurs[idx].en_vie) break; }
    SOLO.indexTour = idx;
  }
  setTimeout(() => nouveauTourSolo(true), 800);
}

// â”€â”€ _passer_suivant_solo() â€” NE reset PAS la sÃ©quence
function passerAuSuivantSolo() {
  const n = SOLO.joueurs.length;
  for (let i = 0; i < n; i++) {
    SOLO.indexTour = (SOLO.indexTour + 1) % n;
    if (SOLO.joueurs[SOLO.indexTour].en_vie) break;
  }
  setTimeout(() => nouveauTourSolo(false), 150);
}

// â”€â”€ Utilitaires â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function stopChrono() {
  clearInterval(STATE.chronoInterval);
  STATE.chronoInterval = null;
}

function flashSequence(type) {
  const el = document.getElementById('letters-seq');
  el.classList.add(type);
  setTimeout(() => el.classList.remove(type), 600);
}

function soloValeurJouee(match, seqNorm) {
  if (STATE.modeMixte && seqNorm === match.capitale_normalisee) return match.capitale;
  return match.nom;
}

function soloChercherPossibilites(seq) {
  if (!PAYS_LOCAL || !PAYS_LOCAL.length) return [];
  const s = normaliser(seq);
  if (!s) return PAYS_LOCAL.map(p => ({ ...p, _cible: 'nom_normalise' }));
  const res = [];
  for (const p of PAYS_LOCAL) {
    if (p.nom_normalise.startsWith(s)) {
      res.push({ ...p, _cible: 'nom_normalise' });
    } else if (STATE.modeMixte && p.capitale_normalisee && p.capitale_normalisee.startsWith(s)) {
      res.push({ ...p, _cible: 'capitale_normalisee' });
    }
  }
  return res;
}

function soloEstComplet(seq) {
  const s = normaliser(seq);
  if (!PAYS_LOCAL) return null;
  for (const p of PAYS_LOCAL) {
    if (p.nom_normalise === s) return p;
    if (STATE.modeMixte && p.capitale_normalisee === s) return p;
  }
  return null;
}

// estComplet et chercherPossibilites â€” alias pour compatibilitÃ© mode connectÃ©
function estComplet(seq) { return soloEstComplet(seq); }
function chercherPossibilites(seq) { return soloChercherPossibilites(seq); }


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIN DE PARTIE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function afficherFinDePartie(msg) {
  const moi = msg.joueurs?.find(j => j.id === STATE.joueurId);
  if (moi) {
    sauvegarderScore(moi.nom, moi.vies,
      msg.pays_joues?.length || 0, STATE.nbTours,
      msg.gagnant === STATE.joueurId ? 1 : 0);
  }
  clearInterval(STATE.chronoInterval);
  const gagnant = msg.joueurs?.find(j => j.id === msg.gagnant);
  document.getElementById('winner-name').textContent = gagnant ? gagnant.nom : 'â€”';
  document.getElementById('stat-pays').textContent = msg.pays_joues?.length || 0;
  document.getElementById('stat-tours').textContent = STATE.nbTours;
  document.getElementById('stat-vies').textContent = gagnant?.vies || 0;
  // Stocker les pays jouÃ©s pour afficherPaysJoues()
  STATE.paysJouesList = (msg.pays_joues || []).map(p => ({ ...p, _valeur_jouee: p.nom }));
  setTimeout(() => afficherEcran('screen-fin'), 600);
}

function afficherFinDePartieLocal(gagnant) {
  const joueurHumain = SOLO.joueurs.find(j => j.id === STATE.joueurId);
  if (joueurHumain) {
    sauvegarderScore(joueurHumain.nom, joueurHumain.vies,
      SOLO.paysJouesList.length, STATE.nbTours,
      gagnant && gagnant.id === STATE.joueurId ? 1 : 0);
  }
  document.getElementById('winner-name').textContent = gagnant ? gagnant.nom : 'â€”';
  document.getElementById('stat-pays').textContent = SOLO.paysJouesList.length;
  document.getElementById('stat-tours').textContent = STATE.nbTours;
  document.getElementById('stat-vies').textContent = gagnant?.vies || 0;
  afficherEcran('screen-fin');
}

function retourAccueil() {
  stopChrono();
  EN_PAUSE = false;
  if (STATE.ws) { STATE.ws.close(); STATE.ws = null; }
  document.getElementById('flags-inner').innerHTML = '';
  document.getElementById('modal-pause').classList.add('hidden');
  document.getElementById('modal-quitter').classList.add('hidden');
  afficherEcran('screen-accueil');
}

function rejouerMeme() {
  stopChrono();
  if (STATE.modeConnecte) {
    retourAccueil();
  } else {
    // RÃ©initialiser SOLO sans passer par le lobby
    const vies = SOLO.viesDepart;
    SOLO.joueurs = SOLO.joueurs.map(j => ({ ...j, vies, en_vie: true }));
    SOLO.indexTour    = 0;
    SOLO.sequence     = '';
    SOLO.paysJoues    = new Set();
    SOLO.paysJouesList= [];
    SOLO.joueurFautif = null;
    STATE.nbTours     = 0;
    demarrerSolo();  // repart directement en jeu
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUG05 FIX â€” PAUSE & QUITTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let EN_PAUSE = false;

function basculerPause() {
  EN_PAUSE = !EN_PAUSE;
  const btn = document.getElementById('btn-pause');
  if (EN_PAUSE) {
    clearInterval(STATE.chronoInterval);
    document.querySelectorAll('.key').forEach(k => k.disabled = true);
    document.getElementById('btn-langue').disabled = true;
    btn.textContent = 'â–¶ Reprendre';
    btn.style.background = 'rgba(0,201,167,0.12)';
    btn.style.color = 'var(--teal)';
    btn.style.borderColor = 'rgba(0,201,167,0.3)';
    // Modal pause
    document.getElementById('modal-pause').classList.remove('hidden');
  } else {
    reprendreDepuisPause();
  }
}

function reprendreDepuisPause() {
  EN_PAUSE = false;
  document.getElementById('modal-pause').classList.add('hidden');
  const btn = document.getElementById('btn-pause');
  btn.textContent = 'â¸ Pause';
  btn.style.background = 'rgba(255,255,255,0.06)';
  btn.style.color = 'var(--paper)';
  btn.style.borderColor = 'rgba(255,255,255,0.1)';
  // Relancer chrono si temps restant
  if (STATE.tempsRestant > 0) {
    STATE.chronoInterval = setInterval(() => {
      STATE.tempsRestant--;
      actualiserChrono();
      if (STATE.tempsRestant <= 0) {
        clearInterval(STATE.chronoInterval);
        if (!STATE.modeConnecte && STATE.estMonTour) perdreVieLocal('â° Temps Ã©coulÃ© !');
      }
    }, 1000);
  }
  // RÃ©activer clavier selon le tour
  document.querySelectorAll('.key').forEach(k => k.disabled = !STATE.estMonTour);
}

function confirmerQuitter() {
  // Mettre en pause le chrono pendant la popup
  clearInterval(STATE.chronoInterval);
  document.getElementById('modal-quitter').classList.remove('hidden');
}

function annulerQuitter() {
  document.getElementById('modal-quitter').classList.add('hidden');
  // Reprendre le chrono si pas en pause
  if (!EN_PAUSE && STATE.tempsRestant > 0) {
    STATE.chronoInterval = setInterval(() => {
      STATE.tempsRestant--;
      actualiserChrono();
      if (STATE.tempsRestant <= 0) {
        clearInterval(STATE.chronoInterval);
        if (!STATE.modeConnecte && STATE.estMonTour) perdreVieLocal('â° Temps Ã©coulÃ© !');
      }
    }, 1000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUG04 FIX â€” VOIR LES PAYS JOUÃ‰S
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function afficherPaysJoues() {
  const liste = STATE.modeConnecte ? (STATE.paysJouesList || []) : SOLO.paysJouesList;
  const modal = document.getElementById('modal-pays-joues');
  const content = document.getElementById('pays-joues-list');
  content.innerHTML = '';

  document.getElementById('pays-joues-count').textContent =
    `ğŸ—ºï¸ ${liste.length} mot${liste.length > 1 ? 's' : ''} jouÃ©${liste.length > 1 ? 's' : ''}`;

  if (!liste.length) {
    content.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px;font-size:13px">Aucun pays jouÃ©</div>';
  } else {
    liste.forEach(item => {
      const valeur = item._valeur_jouee || item.nom || '';
      const code = item.code || 'fr';
      const div = document.createElement('div');
      div.style.cssText = 'display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05)';

      const affichage = (STATE.modeMixte && item._valeur_jouee && item._valeur_jouee !== item.nom)
        ? `${item._valeur_jouee} <span style="color:var(--muted);font-size:11px">(${item.nom})</span>`
        : valeur;

      div.innerHTML = `
        <img src="https://flagcdn.com/w80/${code}.png"
             style="width:48px;height:32px;object-fit:cover;border-radius:4px;border:1px solid rgba(255,255,255,0.1);flex-shrink:0"
             onerror="this.style.display='none'">
        <span style="font-size:14px">${affichage}</span>
      `;
      content.appendChild(div);
    });
  }

  modal.classList.remove('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOASTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type = '') {
  const container = document.getElementById('toast-container');
  const div = document.createElement('div');
  div.className = 'toast' + (type ? ` ${type}` : '');
  div.textContent = msg;
  container.appendChild(div);
  setTimeout(() => {
    div.classList.add('exit');
    setTimeout(() => div.remove(), 300);
  }, 3500);
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TUTORIEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _tutoStep = 0;
const TUTO_TOTAL = 3;

function afficherTuto() {
  _tutoStep = 0;
  document.getElementById('tuto-overlay').classList.remove('hidden');
  document.getElementById('tuto-overlay').style.display = 'flex';
  _syncTuto();
}

function fermerTuto() {
  document.getElementById('tuto-overlay').classList.add('hidden');
  document.getElementById('tuto-overlay').style.display = '';
  localStorage.setItem('paysfatal_tuto', '1');
}

function tutoSuivant() {
  _tutoStep++;
  if (_tutoStep >= TUTO_TOTAL) { fermerTuto(); return; }
  _syncTuto();
}

function _syncTuto() {
  document.querySelectorAll('.tuto-slide').forEach((s, i) => {
    s.classList.toggle('hidden', i !== _tutoStep);
  });
  document.querySelectorAll('.tuto-dot').forEach((d, i) => {
    d.classList.toggle('active', i === _tutoStep);
  });
  const btn = document.getElementById('tuto-next');
  if (btn) btn.textContent = _tutoStep === TUTO_TOTAL - 1 ? 'ğŸ® Jouer !' : 'Suivant â†’';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SONS â€” Web Audio API (zÃ©ro fichier externe)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let _actx = null;
function getACtx() {
  if (!_actx) _actx = new AudioCtx();
  return _actx;
}

// Son muet par dÃ©faut â€” activÃ© au premier geste utilisateur
let sonsActifs = localStorage.getItem('sons') !== 'off';

function jouerSon(type) {
  if (!sonsActifs) return;
  try {
    const ctx = getACtx();
    const g = ctx.createGain();
    g.connect(ctx.destination);

    switch(type) {
      case 'touche': {
        // Clic court et sec
        const o = ctx.createOscillator();
        o.connect(g);
        o.type = 'sine';
        o.frequency.setValueAtTime(880, ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.06);
        g.gain.setValueAtTime(0.18, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.07);
        o.start(); o.stop(ctx.currentTime + 0.07);
        break;
      }
      case 'erreur': {
        // Buzzer grave
        const o = ctx.createOscillator();
        o.connect(g);
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(180, ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.25);
        g.gain.setValueAtTime(0.22, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);
        o.start(); o.stop(ctx.currentTime + 0.25);
        break;
      }
      case 'vie': {
        // Impact sourd â€” perte de vie
        const o = ctx.createOscillator();
        o.connect(g);
        o.type = 'square';
        o.frequency.setValueAtTime(220, ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(60, ctx.currentTime + 0.3);
        g.gain.setValueAtTime(0.3, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
        o.start(); o.stop(ctx.currentTime + 0.3);
        break;
      }
      case 'complet': {
        // Ding ascendant â€” mot complÃ©tÃ©
        [0, 0.08, 0.18].forEach((t, i) => {
          const o = ctx.createOscillator();
          const gn = ctx.createGain();
          o.connect(gn); gn.connect(ctx.destination);
          o.type = 'sine';
          o.frequency.value = [523, 659, 784][i];
          gn.gain.setValueAtTime(0.15, ctx.currentTime + t);
          gn.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + t + 0.18);
          o.start(ctx.currentTime + t);
          o.stop(ctx.currentTime + t + 0.18);
        });
        break;
      }
      case 'victoire': {
        // Fanfare joyeuse
        const notes = [523,659,784,1047];
        notes.forEach((freq, i) => {
          const o = ctx.createOscillator();
          const gn = ctx.createGain();
          o.connect(gn); gn.connect(ctx.destination);
          o.type = 'triangle';
          o.frequency.value = freq;
          gn.gain.setValueAtTime(0.18, ctx.currentTime + i * 0.12);
          gn.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.12 + 0.25);
          o.start(ctx.currentTime + i * 0.12);
          o.stop(ctx.currentTime + i * 0.12 + 0.25);
        });
        break;
      }
      case 'langue': {
        // Alerter â€” son montant-descendant
        const o = ctx.createOscillator();
        o.connect(g);
        o.type = 'sine';
        o.frequency.setValueAtTime(660, ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.15);
        g.gain.setValueAtTime(0.2, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
        o.start(); o.stop(ctx.currentTime + 0.2);
        break;
      }
      case 'emoji': {
        // Pop lÃ©ger
        const o = ctx.createOscillator();
        o.connect(g);
        o.type = 'sine';
        o.frequency.setValueAtTime(1200, ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.08);
        g.gain.setValueAtTime(0.12, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.08);
        o.start(); o.stop(ctx.currentTime + 0.08);
        break;
      }
    }
  } catch(e) {}
}

// â”€â”€ Musique d'ambiance (Kenney CC0) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Plusieurs pistes en rotation, servies par gamesounds.xyz
// URL du fichier ambiance.mp3 Ã  placer dans ton repo GitHub
// â†’ tÃ©lÃ©charge un MP3 libre sur pixabay.com/music (Electronic + Happy)
// â†’ renomme-le ambiance.mp3 et dÃ©pose-le dans ton repo
const _AMBIANCE_URL = "https://raw.githubusercontent.com/LAantaaa/pays-game/main/ambiance.mp3";
let _ambianceAudio = null;

function demarrerAmbiance() {
  if (!sonsActifs || _ambianceAudio) return;
  try {
    const audio = new Audio(_AMBIANCE_URL);
    audio.volume = 0.18;
    audio.loop = true;
    audio.play().catch(() => {});
    _ambianceAudio = audio;
  } catch(e) {}
}

function arreterAmbiance() {
  if (_ambianceAudio) {
    _ambianceAudio.pause();
    _ambianceAudio = null;
  }
}

// Activer/couper l'ambiance quand on toggle les sons
function toggleSons() {
  sonsActifs = !sonsActifs;
  localStorage.setItem('sons', sonsActifs ? 'on' : 'off');
  const btn = document.getElementById('btn-sons');
  if (btn) btn.textContent = sonsActifs ? 'ğŸ”Š' : 'ğŸ”‡';
  if (sonsActifs) demarrerAmbiance(); else arreterAmbiance();
  toast(sonsActifs ? 'ğŸ”Š Sons activÃ©s' : 'ğŸ”‡ Sons dÃ©sactivÃ©s', '');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCORES PERSISTANTS â€” Top 10 localStorage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sauvegarderScore(nomJoueur, viesRestantes, nbPays, nbTours, gagne) {
  try {
    const scores = JSON.parse(localStorage.getItem('paysfatal_scores') || '[]');
    scores.push({
      nom: nomJoueur, vies: viesRestantes, pays: nbPays,
      tours: nbTours, gagne, date: new Date().toLocaleDateString('fr'), ts: Date.now()
    });
    scores.sort((a, b) => {
      if (b.gagne !== a.gagne) return b.gagne - a.gagne;
      if (b.vies !== a.vies) return b.vies - a.vies;
      return b.pays - a.pays;
    });
    localStorage.setItem('paysfatal_scores', JSON.stringify(scores.slice(0, 10)));
  } catch(e) {}
}

function afficherScores() {
  try {
    const scores = JSON.parse(localStorage.getItem('paysfatal_scores') || '[]');
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = 'z-index:9999;display:flex';
    const rows = scores.length ? scores.map((s, i) => `
      <div style="display:flex;align-items:center;gap:10px;padding:10px 0;
           border-bottom:1px solid rgba(255,255,255,0.06);
           color:${i < 3 ? 'var(--amber)' : 'var(--paper)'}">
        <span style="font-family:'Bebas Neue',sans-serif;font-size:22px;width:28px;text-align:center">
          ${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] || (i+1)}
        </span>
        <div style="flex:1">
          <div style="font-weight:600">${escapeHtml(s.nom)} ${s.gagne ? 'ğŸ‘‘' : ''}</div>
          <div style="font-size:11px;color:var(--muted)">${s.date}</div>
        </div>
        <div style="text-align:right;font-size:12px;font-family:'DM Mono',monospace">
          <div>â¤ï¸ ${s.vies}</div><div>ğŸŒ ${s.pays}</div>
        </div>
      </div>`).join('')
      : '<div style="color:var(--muted);text-align:center;padding:20px">Aucun score enregistrÃ©.</div>';
    modal.innerHTML = `
      <div class="modal-box" style="max-height:80vh;overflow:hidden;display:flex;flex-direction:column">
        <span class="modal-emoji">ğŸ†</span>
        <div class="modal-title">MEILLEURS SCORES</div>
        <div style="overflow-y:auto;flex:1">${rows}</div>
        <div class="modal-actions" style="margin-top:12px;gap:8px">
          <button class="btn btn-secondary" onclick="localStorage.removeItem('paysfatal_scores');
            this.closest('.modal-overlay').remove();toast('Scores effacÃ©s','warn')">Effacer</button>
          <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Fermer</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
  } catch(e) { toast('Erreur lecture scores', 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  construireClavier();
  STATE.modeConnecte = false;

  // Afficher le premier step
  allerStep('step-choix');

  // Tutoriel au premier lancement
  if (!localStorage.getItem('paysfatal_tuto')) {
    setTimeout(afficherTuto, 600);
  }

  // Son d'ambiance â€” dÃ©marrÃ© au premier clic (politique navigateur)
  document.addEventListener('click', () => {
    if (sonsActifs) demarrerAmbiance();
  }, { once: true });

  // PrÃ©charger les pays en arriÃ¨re-plan dÃ¨s le dÃ©marrage
  // (Ã©vite le bug "sÃ©quences non reconnues" au premier lancement)
  chargerPaysLocal('fr');

  // Rejoindre via lien partagÃ© (?room=ABCDEF)
  const params = new URLSearchParams(window.location.search);
  const roomFromUrl = params.get('room');
  if (roomFromUrl && roomFromUrl.length === 6) {
    allerStep('step-rejoindre');
    document.getElementById('rejoindre-code').value = roomFromUrl.toUpperCase();
    toast(`ğŸ”— Code dÃ©tectÃ© : ${roomFromUrl.toUpperCase()} â€” entrez votre nom et rejoignez !`, '');
  }
}

init();

</script>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TUTORIEL â€” Premier lancement
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tuto-overlay" class="modal-overlay hidden" style="z-index:10000;align-items:center;justify-content:center">
  <div style="background:var(--surface);border:1px solid var(--border-hi);border-radius:var(--r-xl);
              padding:32px 28px;max-width:420px;width:90%;position:relative">
    <!-- Slides -->
    <div id="tuto-slides">

      <div class="tuto-slide" data-slide="0">
        <div style="font-size:64px;text-align:center;margin-bottom:16px">ğŸŒ</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;color:var(--amber);text-align:center;margin-bottom:12px">LE PAYS FATAL</div>
        <div style="color:var(--paper);font-size:15px;line-height:1.7;text-align:center">
          Ajoute une lettreâ€¦ mais ne sois jamais celui qui achÃ¨ve le pays. ğŸ˜‰
        </div>
      </div>

      <div class="tuto-slide hidden" data-slide="1">
        <div style="font-size:48px;text-align:center;margin-bottom:16px">âŒ¨ï¸</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;color:var(--amber);text-align:center;margin-bottom:16px">COMMENT JOUER</div>
        <div style="display:flex;flex-direction:column;gap:12px;font-size:14px;color:var(--paper)">
          <div style="display:flex;gap:12px;align-items:flex-start">
            <span style="font-size:20px;flex-shrink:0">ğŸ”¤</span>
            <span>Ã€ chaque tour tu ajoutes <strong>une lettre</strong>. La sÃ©quence doit toujours commencer au moins un nom de pays.</span>
          </div>
          <div style="display:flex;gap:12px;align-items:flex-start">
            <span style="font-size:20px;flex-shrink:0">ğŸ’€</span>
            <span>Si tu <strong>complÃ¨tes un nom de pays</strong> ou si tu poses une lettre <strong>impossible</strong>, tu perds une vie.</span>
          </div>
          <div style="display:flex;gap:12px;align-items:flex-start">
            <span style="font-size:20px;flex-shrink:0">ğŸ—£ï¸</span>
            <span><strong>Langue au chat</strong> : tu penses que l'adversaire ment ? Interpelle-le â€” il doit prouver qu'un pays existe.</span>
          </div>
        </div>
      </div>

      <div class="tuto-slide hidden" data-slide="2">
        <div style="font-size:48px;text-align:center;margin-bottom:16px">âš¡</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;color:var(--amber);text-align:center;margin-bottom:16px">LES MODES</div>
        <div style="display:flex;flex-direction:column;gap:10px;font-size:14px;color:var(--paper)">
          <div style="background:rgba(255,255,255,0.04);border-radius:10px;padding:10px 12px">
            ğŸ¯ <strong>Classique</strong> â€” 15 secondes, 10 vies, sÃ©quence libre
          </div>
          <div style="background:rgba(255,255,255,0.04);border-radius:10px;padding:10px 12px">
            âš¡ <strong>Blitz</strong> â€” 5 secondes max par lettre, rÃ©flÃ©chis vite
          </div>
          <div style="background:rgba(255,255,255,0.04);border-radius:10px;padding:10px 12px">
            ğŸ’€ <strong>Survie</strong> â€” 1 seule vie. La moindre erreur = Ã©liminÃ©
          </div>
          <div style="background:rgba(255,255,255,0.04);border-radius:10px;padding:10px 12px">
            ğŸ”¥ <strong>AccÃ©lÃ©ration</strong> â€” le chrono perd 1s Ã  chaque tour
          </div>
        </div>
      </div>

    </div>

    <!-- Navigation -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:28px">
      <div style="display:flex;gap:6px">
        <div class="tuto-dot active" data-dot="0"></div>
        <div class="tuto-dot" data-dot="1"></div>
        <div class="tuto-dot" data-dot="2"></div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="tuto-skip" onclick="fermerTuto()"
          style="background:none;border:none;color:var(--muted);font-size:13px;cursor:pointer;padding:8px 12px">
          Passer
        </button>
        <button id="tuto-next" onclick="tutoSuivant()"
          class="btn btn-primary" style="padding:10px 24px">
          Suivant â†’
        </button>
      </div>
    </div>
  </div>
</div>


</body>
</html>